<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店家管理後台 - BrewDate</title>
    <!-- SEO 優化 meta 標籤 -->
    <meta name="description" content="BREWDATE 商家管理後台 - 管理您的店鋪資訊，優化推薦曝光度，吸引更多顧客。">
    <meta name="keywords" content="BREWDATE, 商家管理, 店家平台, 約會場所, 合作夥伴">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="base.css">
    <!-- Favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
                
    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.0/apexcharts.min.js"></script>
    
    <!-- 添加Firebase ES 模組 script 標籤 -->
    <script type="module">
        // 從 firebase-config.js 導入所有需要的模組
        import { auth, db, storage, appCheck } from './firebase-config.js';
        import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js';
        
        // 將變數暴露給全局範圍
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.appCheck = appCheck;
        
        // 暴露 Firebase Auth 方法到全局範圍
        window.firebase = {
            auth: {
                signOut: () => signOut(auth)
            },
            firestore: () => db,
            storage: () => storage
        };
        
        // 創建一個事件，通知頁面 Firebase 已初始化完成
        window.addEventListener('DOMContentLoaded', () => {
            // 等待初始化完成，確保全局變數已賦值
            setTimeout(() => {
                const event = new CustomEvent('firebase-ready');
                document.dispatchEvent(event);
                console.log('Firebase 已初始化完成，全局變數已設置');
            }, 500);
        });
        
        // 驗證用戶身份
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('用戶已登入:', user.email);
                // 觸發用戶登入事件
                const event = new CustomEvent('user-authenticated', { detail: user });
                document.dispatchEvent(event);
            } else {
                console.log('用戶未登入，重定向到登入頁面');
                window.location.href = 'business-login.html';
            }
        });
    </script>
    
    <!-- 錯誤處理 -->
    <script src="error-handler.js"></script>

    <style>
        :root {
            --primary-color: #9D7F86;
            --primary-light: #EADED5;
            --secondary-color: #D8CAB8;
            --dark-color: #4A4A4A;
            --light-color: #F8F9FA;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --gray-color: #6c757d;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #F8F9FA;
            color: var(--dark-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 側邊欄樣式 */
        .dashboard-container {
            display: flex;
            flex: 1;
        }
        
        .sidebar {
            width: 280px;
            background: var(--dark-color);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            text-align: center;
        }
        
        .sidebar-header img {
            width: 40px;
            margin-bottom: 10px;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-family: 'Playfair Display', serif;
            font-size: 24px;
        }
        
        .sidebar-menu {
            padding: 0;
            list-style: none;
        }
        
        .sidebar-menu li {
            margin: 0;
            padding: 0;
        }
        
        .sidebar-menu li a {
            padding: 15px 20px;
            display: block;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            font-size: 15px;
        }
        
        .sidebar-menu li a i {
            margin-right: 10px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-menu li a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }
        
        .sidebar-menu li.active a {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--primary-color);
        }
        
        /* 主內容區域 */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 20px;
            transition: all 0.3s;
        }
        
        /* 導航欄 */
        .dashboard-nav {
            background-color: white;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 10px;
        }
        
        .dashboard-nav .nav-toggle {
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-color);
        }
        
        .dashboard-nav .nav-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .dashboard-nav .nav-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .dashboard-nav .nav-user .dropdown-toggle {
            background: none;
            border: none;
            color: var(--dark-color);
            cursor: pointer;
        }
        
        /* 卡片樣式 */
        .dashboard-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .dashboard-card .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dashboard-card .card-header h5 {
            margin: 0;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .dashboard-card .card-body {
            padding: 20px;
        }
        
        /* 統計卡片 */
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stat-card .stat-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            margin-right: 15px;
            font-size: 24px;
        }
        
        .stat-card .stat-icon.views {
            background-color: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }
        
        .stat-card .stat-icon.matches {
            background-color: rgba(155, 89, 182, 0.1);
            color: #9b59b6;
        }
        
        .stat-card .stat-icon.ratings {
            background-color: rgba(241, 196, 15, 0.1);
            color: #f1c40f;
        }
        
        .stat-card .stat-icon.recommendations {
            background-color: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }
        
        .stat-card .stat-content {
            flex: 1;
        }
        
        .stat-card .stat-content h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }
        
        .stat-card .stat-content p {
            margin: 5px 0 0;
            color: var(--gray-color);
            font-size: 14px;
        }
        
        /* 表格樣式 */
        .dashboard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .dashboard-table th, 
        .dashboard-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .dashboard-table th {
            font-weight: 600;
            color: var(--dark-color);
            background-color: #f8f9fa;
        }
        
        .dashboard-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 狀態標籤 */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-badge.active {
            background-color: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
        }
        
        .status-badge.pending {
            background-color: rgba(241, 196, 15, 0.1);
            color: #f1c40f;
        }
        
        .status-badge.inactive {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        
        /* 按鈕樣式 */
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #8a6e75;
            border-color: #8a6e75;
        }
        
        .btn-outline-primary {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* 標籤輸入區 */
        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            border: 1px solid #ced4da;
            padding: 8px;
            border-radius: 5px;
            min-height: 80px;
            background-color: white;
        }
        
        .tag {
            background-color: var(--primary-light);
            padding: 5px 10px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            color: var(--primary-color);
            font-size: 14px;
        }
        
        .tag .tag-close {
            margin-left: 5px;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 16px;
        }
        
        .tag-input {
            flex: 1;
            min-width: 100px;
            border: none;
            outline: none;
            padding: 5px;
        }
        
        /* 嵌套菜單項目 */
        .nested-menu {
            padding-left: 35px;
            display: none;
        }
        
        .nested-menu.show {
            display: block;
        }
        
        /* 商品項目管理 */
        .product-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
            padding: 15px;
        }
        
        .product-category {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-category .actions {
            display: flex;
            gap: 5px;
        }
        
        .product-item-list {
            padding-left: 20px;
        }
        
        .product-subitem {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .product-subitem:hover {
            background-color: #f0f0f0;
        }
        
        .product-subitem .product-name {
            font-weight: 500;
        }
        
        .product-subitem .product-description {
            font-size: 13px;
            color: #777;
            margin-left: 10px;
        }
        
        /* 響應式調整 */
        @media (max-width: 992px) {
            .sidebar {
                margin-left: -280px;
            }
            
            .sidebar.active {
                margin-left: 0;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .main-content.active {
                margin-left: 280px;
            }
        }
        
        /* 圖片上傳預覽 */
        .image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .image-preview .upload-placeholder {
            text-align: center;
        }
        
        .image-preview .upload-placeholder i {
            font-size: 40px;
            color: #ddd;
            margin-bottom: 10px;
        }
        
        .image-preview .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        /* 選擇活動類型區塊 */
        .activity-type-section {
            padding: 20px;
        }
        
        .activity-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .activity-type-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .activity-type-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .activity-type-card.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .activity-type-card i {
            font-size: 30px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .activity-type-card p {
            margin: 0;
            font-weight: 500;
        }
        
        /* 操作時間選擇 */
        .hours-selection {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .hours-selection .day-label {
            width: 90px;
            font-weight: 500;
        }
        
        .hours-selection .time-inputs {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .hours-selection .time-separator {
            margin: 0 5px;
        }
        
        /* 工具提示 */
        .tooltip-icon {
            margin-left: 5px;
            color: #868e96;
            font-size: 16px;
            cursor: help;
        }
        
        /* 切換開關 */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* 內容區塊顯示控制 */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }

        /* 菜單與商品項目編輯表單 */
        .menu-item-form {
            display: none;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 3px solid var(--primary-color);
        }
        
        .menu-item-form.show {
            display: block;
        }
        
        /* 多圖預覽區域 */
        .gallery-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .gallery-item {
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }
        
        .add-gallery-item {
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .add-gallery-item:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }
        
        .add-gallery-item i {
            font-size: 30px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .add-gallery-item p {
            margin: 0;
            color: #777;
        }
    </style>
</head>
<body>
    <!-- 側邊欄 -->
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="logo.png" alt="BrewDate">
                <h3>BREWDATE</h3>
                <p>店家管理平台</p>
            </div>
            <ul class="sidebar-menu">
                <li class="active">
                    <a href="#dashboard"><i class="fas fa-tachometer-alt"></i> 儀表板</a>
                </li>
                <li>
                    <a href="#profile"><i class="fas fa-store"></i> 店家資訊</a>
                </li>
                <li>
                    <a href="#activities"><i class="fas fa-tags"></i> 活動類型與標籤</a>
                </li>
                <li>
                    <a href="#menu"><i class="fas fa-utensils"></i> 商品項目管理</a>
                </li>
                <li>
                    <a href="#promotions"><i class="fas fa-ticket-alt"></i> 優惠管理</a>
                </li>
                <li>
                    <a href="#photos"><i class="fas fa-images"></i> 店家照片</a>
                </li>
                <li>
                    <a href="#analytics"><i class="fas fa-chart-line"></i> 數據分析</a>
                </li>
                <li>
                    <a href="#settings"><i class="fas fa-cog"></i> 設定</a>
                </li>
                <li>
                    <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> 登出</a>
                </li>
            </ul>
        </div>
        
        <!-- 主內容區 -->
        <div class="main-content">
            <!-- 頂部導航 -->
            <div class="dashboard-nav">
                <div class="nav-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="nav-user dropdown">
                    <button class="dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <img id="navUserImage" src="https://via.placeholder.com/40" alt="用戶頭像">
                        <span id="navUserName">載入中... <i class="fas fa-chevron-down"></i></span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="userDropdown">
                        <li><a class="dropdown-item" href="#profile"><i class="fas fa-user"></i> 店家資料</a></li>
                        <li><a class="dropdown-item" href="#settings"><i class="fas fa-cog"></i> 帳戶設定</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> 登出</a>
                    </ul>
                </div>
            </div>
            
            <!-- 儀表板區塊 -->
            <div class="content-section active" id="dashboard-section">
                <h2 class="mb-4">儀表板</h2>
                
                <!-- 統計卡 -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon views">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="stat-content">
                                <h3 id="viewCountStat">0</h3>
                                <p>店面瀏覽次數</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon matches">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="stat-content">
                                <h3>85</h3>
                                <p>收藏次數</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon ratings">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-content">
                                <h3>4.8</h3>
                                <p>平均評分</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-icon recommendations">
                                <i class="fas fa-thumbs-up"></i>
                            </div>
                            <div class="stat-content">
                                <h3>432</h3>
                                <p>被推薦次數</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 最近活動 -->
                <div class="row mt-4">
                    <div class="col-md-7">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>最近推薦記錄</h5>
                                <button class="btn btn-sm btn-outline-primary">查看全部</button>
                            </div>
                            <div class="card-body">
                                <table class="dashboard-table">
                                    <thead>
                                        <tr>
                                            <th>日期</th>
                                            <th>活動類型</th>
                                            <th>推薦次數</th>
                                            <th>點擊率</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>2023/11/24</td>
                                            <td>咖啡約會</td>
                                            <td>23</td>
                                            <td>68%</td>
                                        </tr>
                                        <tr>
                                            <td>2023/11/23</td>
                                            <td>下午茶</td>
                                            <td>18</td>
                                            <td>72%</td>
                                        </tr>
                                        <tr>
                                            <td>2023/11/22</td>
                                            <td>咖啡約會</td>
                                            <td>21</td>
                                            <td>65%</td>
                                        </tr>
                                        <tr>
                                            <td>2023/11/21</td>
                                            <td>下午茶</td>
                                            <td>15</td>
                                            <td>59%</td>
                                        </tr>
                                        <tr>
                                            <td>2023/11/20</td>
                                            <td>咖啡約會</td>
                                            <td>19</td>
                                            <td>71%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>熱門時段</h5>
                            </div>
                            <div class="card-body">
                                <div id="popularTimesChart" style="height: 250px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 優惠方案狀態 -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>當前優惠方案</h5>
                                <button class="btn btn-sm btn-primary">新增優惠</button>
                            </div>
                            <div class="card-body">
                                <table class="dashboard-table">
                                    <thead>
                                        <tr>
                                            <th>名稱</th>
                                            <th>類型</th>
                                            <th>適用對象</th>
                                            <th>有效期</th>
                                            <th>狀態</th>
                                            <th>查看次數</th>
                                            <th>使用次數</th>
                                            <th>操作</th>
                                            <tbody id="promotionsTableBody">
                                                <!-- 優惠列表會從資料庫動態載入 -->
                                                <tr class="text-center">
                                                    <td colspan="8" class="py-4">
                                                        <div class="spinner-border text-primary" role="status">
                                                            <span class="visually-hidden">載入中...</span>
                                                        </div>
                                                        <p class="mt-2 text-muted">載入優惠列表...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 店家資訊區塊 -->
                    <div class="content-section" id="profile-section">
                        <h2 class="mb-4">店家資訊</h2>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>基本資料</h5>
                                <button class="btn btn-primary">儲存變更</button>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="storeName" class="form-label">店家名稱</label>
                                                <input type="text" class="form-control" id="storeName" placeholder="請輸入店家名稱">
                                            </div>
                                            <div class="mb-3">
                                                <label for="storeDescription" class="form-label">店家簡介</label>
                                                <textarea class="form-control" id="storeDescription" rows="5" placeholder="請輸入店家簡介"></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="storePhone" class="form-label">聯絡電話</label>
                                                <input type="tel" class="form-control" id="storePhone" placeholder="請輸入聯絡電話">
                                            </div>
                                            <div class="mb-3">
                                                <label for="storeEmail" class="form-label">電子郵件</label>
                                                <input type="email" class="form-control" id="storeEmail" placeholder="請輸入電子郵件">
                                            </div>
                                            <div class="mb-3">
                                                <label for="storeWebsite" class="form-label">網站</label>
                                                <input type="url" class="form-control" id="storeWebsite" placeholder="請輸入網站網址">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="dashboard-card mt-4">
                                                <div class="card-header">
                                                    <h5>地理位置設定</h5>
                                                    <button class="btn btn-primary" id="saveLocationBtn">儲存位置</button>
                                                </div>
                                                <div class="card-body">
                                                    <p class="text-muted mb-3">
                                                        準確設定店家位置，讓附近的用戶能夠更容易找到您。此位置將用於APP中的距離計算及推薦功能。
                                                    </p>
                                                    <div class="row mb-3">
                                                        <div class="col-md-12">
                                                            <div class="input-group">
                                                                <input type="text" class="form-control" id="locationSearch" placeholder="搜尋地址...">
                                                                <button class="btn btn-outline-secondary" type="button" id="searchLocationBtn">
                                                                    <i class="fas fa-search"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div id="mapContainer" style="height: 350px; border-radius: 8px;"></div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label class="form-label">緯度</label>
                                                                <input type="text" class="form-control" id="latitude" readonly>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">經度</label>
                                                                <input type="text" class="form-control" id="longitude" readonly>
                                                            </div>
                                                            <div class="mb-3">
                                                                <label class="form-label">地址</label>
                                                                <textarea class="form-control" id="formattedAddress" rows="3" readonly></textarea>
                                                            </div>
                                                            <div class="alert alert-info" role="alert">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                移動地圖上的標記以設定精確位置
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>                              
                                </form>
                            </div>
                        </div>
                        
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>營業時間設置</h5>
                                <button class="btn btn-primary">儲存營業時間</button>
                            </div>
                            <div class="card-body">
                                <!-- 營業時間設置 -->
                                <div class="row g-3" id="businessHoursContainer"></div>
                            </div>
                            <script>
                                // 假設整點與半點
                                const timeSlots = [
                                    '08:00','08:30','09:00','09:30','10:00','10:30',
                                    '11:00','11:30','12:00','12:30','13:00','13:30',
                                    '14:00','14:30','15:00','15:30','16:00','16:30',
                                    '17:00','17:30','18:00','18:30','19:00','19:30',
                                    '20:00','20:30','21:00','21:30','22:00','22:30',
                                    '23:00','23:30'
                                ];
                                
                                const days = [
                                    { label: '星期一', value: 1 },
                                    { label: '星期二', value: 2 },
                                    { label: '星期三', value: 3 },
                                    { label: '星期四', value: 4 },
                                    { label: '星期五', value: 5 },
                                    { label: '星期六', value: 6 },
                                    { label: '星期日', value: 7 }
                                ];
                                
                                const container = document.getElementById('businessHoursContainer');
                                
                                days.forEach(dayObj => {
                                    // 建立一個 col-md-6
                                    const col = document.createElement('div');
                                    col.classList.add('col-md-6');
                                
                                    // 生成 day-label
                                    const dayLabel = document.createElement('div');
                                    dayLabel.classList.add('day-label');
                                    dayLabel.textContent = dayObj.label;
                                
                                    // 生成「起始時間」的 select
                                    const startSelect = document.createElement('select');
                                    startSelect.classList.add('form-select', 'form-select-sm', 'business-hours');
                                    // 可用 data-* 來記錄是第幾天、屬於 open 之類
                                    startSelect.setAttribute('data-day', dayObj.value);
                                    startSelect.setAttribute('data-type', 'start');
                                    // 動態插入所有 options
                                    timeSlots.forEach(t => {
                                        const option = document.createElement('option');
                                        option.value = t;
                                        option.textContent = t;
                                        startSelect.appendChild(option);
                                    });
                                
                                    // 生成「結束時間」的 select
                                    const endSelect = document.createElement('select');
                                    endSelect.classList.add('form-select', 'form-select-sm', 'business-hours');
                                    endSelect.setAttribute('data-day', dayObj.value);
                                    endSelect.setAttribute('data-type', 'end');
                                    timeSlots.forEach(t => {
                                        const option = document.createElement('option');
                                        option.value = t;
                                        option.textContent = t;
                                        endSelect.appendChild(option);
                                    });
                                
                                    // 組合成排版
                                    const timeInputsDiv = document.createElement('div');
                                    timeInputsDiv.classList.add('time-inputs');
                                    timeInputsDiv.appendChild(startSelect);
                                
                                    const separator = document.createElement('span');
                                    separator.classList.add('time-separator');
                                    separator.textContent = '至';
                                    timeInputsDiv.appendChild(separator);
                                
                                    timeInputsDiv.appendChild(endSelect);
                                
                                    const hoursSelectionDiv = document.createElement('div');
                                    hoursSelectionDiv.classList.add('hours-selection');
                                    hoursSelectionDiv.appendChild(dayLabel);
                                    hoursSelectionDiv.appendChild(timeInputsDiv);
                                
                                    col.appendChild(hoursSelectionDiv);
                                    container.appendChild(col);
                                });
                            </script>
                        </div>

                        <!-- 店家主圖區 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>店家照片設置</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="mb-3">店家頭像/Logo</h6>
                                        <div class="image-preview">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-image"></i>
                                                <p>上傳店家頭像或Logo</p>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <input class="form-control" type="file" id="mainImageUpload" accept="image/*">
                                            <div class="form-text">建議尺寸：400 x 400 像素，檔案大小不超過 2MB</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="my-4">
                                
                                <h6 class="mb-3">店內環境照片</h6>
                                <p class="text-muted">上傳高品質的店內環境照片，讓用戶更全面了解您的店鋪環境與氛圍</p>
                                
                                <div class="gallery-preview">
                                    <!-- 上傳按鈕 -->
                                    <div class="add-gallery-item">
                                        <i class="fas fa-plus"></i>
                                        <p>添加環境照片</p>
                                        <input type="file" class="d-none" id="addEnvironmentImage" accept="image/*" multiple>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
                    <!-- 活動類型與標籤區塊 -->
                    <div class="content-section" id="activities-section">
                        <h2 class="mb-4">活動類型與標籤</h2>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>選擇店家適合的活動類型</h5>
                                <div>
                                    <span class="badge bg-primary">已選擇 3 項</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p>請選擇您的店家適合的活動類型，這將有助於我們向用戶推薦您的店鋪。</p>
                                
                                <div class="activity-type-grid">
                                    <div class="activity-type-card">
                                        <i class="fas fa-coffee"></i>
                                        <p>咖啡廳</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-utensils"></i>
                                        <p>吃飯</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-shopping-bag"></i>
                                        <p>逛街</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-film"></i>
                                        <p>看電影</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-book"></i>
                                        <p>讀書</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-glass-cheers"></i>
                                        <p>喝酒</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-running"></i>
                                        <p>運動</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-comments"></i>
                                        <p>聊天</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-gamepad"></i>
                                        <p>電玩</p>
                                    </div>
                                    <div class="activity-type-card">
                                        <i class="fas fa-music"></i>
                                        <p>音樂</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 店家標籤設置 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>店家標籤</h5>
                                <button class="btn btn-primary">儲存標籤</button>
                            </div>
                            <div class="card-body">
                                <p>添加能代表您店家特色的標籤，讓用戶更容易找到您。</p>
                                
                                <div class="mb-4">
                                    <label class="form-label">添加標籤</label>
                                    <div class="tag-input-container" id="tagContainer">
                                        <!-- 標籤會動態添加 -->
                                        <input type="text" class="tag-input" placeholder="輸入標籤，按Enter添加">
                                    </div>
                                    <div class="form-text">最多可添加10個標籤，每個標籤不超過10個字</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">熱門標籤推薦</label>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">免費WiFi</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">不限時</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">適合工作</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">寵物友善</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">適合約會</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">文青風格</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">個人服務</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">浪漫氛圍</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">安靜環境</button>
                                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2">美式風格</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 店家活動描述 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>活動描述</h5>
                            </div>
                            <div class="card-body">
                                <p>為不同活動類型添加專屬描述，讓用戶了解在您店內能進行什麼活動。</p>
                                
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">咖啡廳活動描述</label>
                                            <textarea class="form-control" rows="4" placeholder="描述店內咖啡廳體驗">我們提供精選的單品咖啡和特色拿鐵，店內環境寧靜舒適，適合小型聚會和輕鬆約會。每個座位都有插座，是讀書工作的好去處。</textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">用餐活動描述</label>
                                            <textarea class="form-control" rows="4" placeholder="描述店內用餐體驗">除了優質咖啡，我們還提供精緻的輕食和手工甜點。招牌三明治和沙拉都是使用當季新鮮食材，營養美味又健康。</textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">酒精飲品描述</label>
                                            <textarea class="form-control" rows="4" placeholder="描述店內酒精飲品體驗">傍晚時分，我們提供精選的調酒和精釀啤酒。每週五和週六晚上有駐唱表演，是放鬆享受的好時光。</textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary">儲存描述</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 商品項目管理區塊 -->
                    <div class="content-section" id="menu-section">
                        <h2 class="mb-4">商品項目管理</h2>
                        
                        <!-- 商品類別管理 -->
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>菜單項目管理</h5>
                                <button class="btn btn-primary" id="addCategoryBtn">新增類別</button>
                            </div>
                            <div class="card-body">
                                <!-- 新增類別表單 -->
                                <div class="menu-item-form" id="addCategoryForm">
                                    <h6>新增商品類別</h6>
                                    <div class="mb-3">
                                        <label for="categoryName" class="form-label">類別名稱</label>
                                        <input type="text" class="form-control" id="categoryName" placeholder="例如：咖啡、甜點、輕食">
                                    </div>
                                    <div class="mb-3">
                                        <label for="categoryDesc" class="form-label">類別描述</label>
                                        <textarea class="form-control" id="categoryDesc" rows="2" placeholder="簡單描述此類別的特色"></textarea>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary">儲存類別</button>
                                        <button type="button" class="btn btn-outline-secondary" id="cancelAddCategory">取消</button>
                                    </div>
                                </div>
                                
                                <!-- 類別列表 -->
                                <div id="categoryList">
                                    <!-- 商品類別會從資料庫動態加載 -->
                                    <div class="text-center py-4 text-muted" id="categoryListEmpty">
                                        <i class="fas fa-utensils fa-3x mb-3"></i>
                                        <p>尚未添加任何商品類別</p>
                                        <p>點擊「新增類別」按鈕開始建立您的菜單</p>
                                    </div>
                                </div>
                                <!-- 商品項目表單 -->
                                <div class="menu-item-form" id="coffeeItemForm">
                                    <h6>新增項目</h6>
                                    <div class="mb-3">
                                        <label for="itemName" class="form-label">商品名稱</label>
                                        <input type="text" class="form-control" id="itemName" placeholder="輸入商品名稱">
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemDesc" class="form-label">描述</label>
                                        <textarea class="form-control" id="itemDesc" rows="3" placeholder="描述商品特色或口味"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemImage" class="form-label">商品圖片</label>
                                        <div class="image-preview mb-2" id="itemImagePreview">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-image"></i>
                                                <p>上傳商品圖片</p>
                                            </div>
                                        </div>
                                        <input type="file" class="form-control" id="itemImage" accept="image/*">
                                        <div class="form-text">建議尺寸：600 x 400 像素，優質的商品照片可提高顧客興趣</div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary">儲存項目</button>
                                        <button type="button" class="btn btn-outline-secondary cancel-add-item">取消</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 優惠管理區塊 -->
                    <div class="content-section" id="promotions-section">
                        <h2 class="mb-4">優惠管理</h2>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>創建新優惠</h5>
                            </div>
                            <div class="card-body">
                                <form id="promotionForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="promotionTitle" class="form-label">優惠標題 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="promotionTitle" placeholder="例如：咖啡第二杯半價" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="promotionType" class="form-label">優惠類型 <span class="text-danger">*</span></label>
                                                <select class="form-select" id="promotionType" required>
                                                    <option value="">請選擇類型</option>
                                                    <option value="discount">折扣</option>
                                                    <option value="gift">贈品</option>
                                                    <option value="combo">套餐</option>
                                                    <option value="special">特別優惠</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="promotionDesc" class="form-label">優惠描述 <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="promotionDesc" rows="3" placeholder="詳細描述優惠內容和使用條件" required></textarea>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="promotionStart" class="form-label">開始日期 <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="promotionStart" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="promotionEnd" class="form-label">結束日期 <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="promotionEnd" required>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">適用對象</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="targetAudience" id="allUsers" value="all" checked>
                                                    <label class="form-check-label" for="allUsers">
                                                        所有顧客
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="targetAudience" id="brewdateUsers" value="brewdate">
                                                    <label class="form-check-label" for="brewdateUsers">
                                                        <strong>僅限BREWDATE用戶</strong>
                                                        <span class="badge bg-primary ms-2">推薦</span>
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="targetAudience" id="firstVisitUsers" value="first_visit">
                                                    <label class="form-check-label" for="firstVisitUsers">
                                                        首次造訪顧客
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">最大使用次數</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="usageLimit" placeholder="不限制請留空" min="1">
                                                    <span class="input-group-text">次</span>
                                                </div>
                                                <div class="form-text">設定此優惠最多可使用的總次數，留空表示不限制</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">優惠券圖片 <span class="text-danger">*</span></label>
                                        <div class="image-preview" id="promotionImagePreview">
                                            <div class="upload-placeholder">
                                                <i class="fas fa-image"></i>
                                                <p>上傳優惠券圖片</p>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <input class="form-control" type="file" id="couponImageUpload" accept="image/*" required>
                                            <div class="form-text">建議尺寸：800 x 400 像素，清晰展示優惠內容</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="statsEnabled" checked>
                                            <label class="form-check-label" for="statsEnabled">
                                                啟用優惠使用統計和分析
                                            </label>
                                        </div>
                                        <div class="form-text">收集優惠使用數據，了解優惠的效果和吸引客戶的表現</div>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <button type="submit" class="btn btn-primary">建立優惠</button>
                                        <button type="button" class="btn btn-outline-secondary" id="resetPromotionForm">取消</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <!-- 現有優惠列表 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>現有優惠</h5>
                                <div>
                                    <span class="badge bg-success promotion-active-count">0 個進行中</span>
                                    <span class="badge bg-secondary promotion-inactive-count ms-2">0 個已結束</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="promotionSearch" placeholder="搜尋優惠...">
                                        <select class="form-select" id="promotionFilter" style="max-width: 150px;">
                                            <option value="all">全部狀態</option>
                                            <option value="active">進行中</option>
                                            <option value="inactive">已結束</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="searchPromotionBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="dashboard-table">
                                        <thead>
                                            <tr>
                                                <th>名稱</th>
                                                <th>類型</th>
                                                <th>適用對象</th>
                                                <th>有效期</th>
                                                <th>狀態</th>
                                                <th>查看次數</th>
                                                <th>使用次數</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="promotionsTableBody">
                                            <!-- 優惠列表將由JavaScript填充 -->
                                            <tr class="text-center">
                                                <td colspan="8" class="py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">載入中...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">載入優惠列表...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 優惠數據分析 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>優惠效益分析</h5>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary active" data-period="7">7天</button>
                                    <button class="btn btn-sm btn-outline-secondary" data-period="30">30天</button>
                                    <button class="btn btn-sm btn-outline-secondary" data-period="90">3個月</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div id="promotionUsageChart" style="height: 300px;"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">優惠使用統計</h6>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0">
                                                        總優惠使用次數
                                                        <span class="badge bg-primary rounded-pill" id="totalPromotionUsage">0</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0">
                                                        平均每日使用次數
                                                        <span class="badge bg-info rounded-pill" id="avgDailyUsage">0</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0">
                                                        通過APP帶來的顧客
                                                        <span class="badge bg-success rounded-pill" id="appGeneratedCustomers">0</span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-0">
                                                        最熱門優惠
                                                        <span class="text-primary" id="mostPopularPromotion">-</span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 店家照片區塊 -->
                    <div class="content-section" id="photos-section">
                        <h2 class="mb-4">店家照片</h2>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>店家環境照片</h5>
                            </div>
                            <div class="card-body">
                                <p>上傳高品質的店家環境照片，讓用戶更全面了解您的店鋪環境與氛圍。</p>
                                
                                <div class="gallery-preview">
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="店內環境">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="店內環境">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="店內環境">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="店內環境">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="add-gallery-item">
                                        <i class="fas fa-plus"></i>
                                        <p>添加照片</p>
                                        <input type="file" class="d-none" id="addGalleryImage" accept="image/*" multiple>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 商品照片 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>商品照片</h5>
                            </div>
                            <div class="card-body">
                                <p>上傳您店內特色商品的照片，讓用戶提前了解您的招牌產品。</p>
                                
                                <div class="gallery-preview">
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="商品照片">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="商品照片">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="gallery-item">
                                        <img src="https://via.placeholder.com/150x150" alt="商品照片">
                                        <div class="remove-image">
                                            <i class="fas fa-times"></i>
                                        </div>
                                    </div>
                                    <div class="add-gallery-item">
                                        <i class="fas fa-plus"></i>
                                        <p>添加照片</p>
                                        <input type="file" class="d-none" id="addProductImage" accept="image/*" multiple>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <button class="btn btn-primary">儲存所有照片</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 數據分析區塊 -->
                    <div class="content-section" id="analytics-section">
                        <h2 class="mb-4">數據分析</h2>
                        
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5>推薦數據趨勢</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-secondary active">7天</button>
                                            <button class="btn btn-sm btn-outline-secondary">30天</button>
                                            <button class="btn btn-sm btn-outline-secondary">3個月</button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="recommendationChart" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5>推薦來源分析</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="referralSourceChart" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5>用戶活動類型分布</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="activityTypeChart" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="dashboard-card">
                                    <div class="card-header">
                                        <h5>用戶年齡和性別分布</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="demographicsChart" style="height: 300px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>熱門標籤和搜索</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>熱門標籤</h6>
                                        <div id="popularTagsChart" style="height: 250px;"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>熱門搜索詞</h6>
                                        <table class="dashboard-table">
                                            <thead>
                                                <tr>
                                                    <th>搜索詞</th>
                                                    <th>搜索次數</th>
                                                    <th>轉化率</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>咖啡約會</td>
                                                    <td>235</td>
                                                    <td>48%</td>
                                                </tr>
                                                <tr>
                                                    <td>寧靜咖啡廳</td>
                                                    <td>187</td>
                                                    <td>52%</td>
                                                </tr>
                                                <tr>
                                                    <td>文青咖啡</td>
                                                    <td>142</td>
                                                    <td>41%</td>
                                                </tr>
                                                <tr>
                                                    <td>手沖咖啡</td>
                                                    <td>136</td>
                                                    <td>63%</td>
                                                </tr>
                                                <tr>
                                                    <td>大安區咖啡</td>
                                                    <td>128</td>
                                                    <td>39%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 設定區塊 -->
                    <div class="content-section" id="settings-section">
                        <h2 class="mb-4">帳戶設定</h2>
                        
                        <div class="dashboard-card">
                            <div class="card-header">
                                <h5>帳戶資料</h5>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="accountEmail" class="form-label">電子郵件</label>
                                                <input type="email" class="form-control" id="accountEmail" disabled placeholder="電子郵件會自動載入">
                                            </div>
                                            <div class="mb-3">
                                                <label for="accountName" class="form-label">管理者姓名</label>
                                                <input type="text" class="form-control" id="accountName" placeholder="請輸入管理者姓名">
                                            </div>
                                            <div class="mb-3">
                                                <label for="accountPhone" class="form-label">管理者電話</label>
                                                <input type="tel" class="form-control" id="accountPhone" placeholder="請輸入管理者電話">
                                            </div>
                                            <div class="mb-3">
                                                <label for="accountPosition" class="form-label">職位</label>
                                                <input type="text" class="form-control" id="accountPosition" placeholder="請輸入職位">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary">更新帳戶資料</button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- 密碼變更 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>變更密碼</h5>
                            </div>
                            <div class="card-body">
                                <form>
                                    <div class="mb-3">
                                        <label for="currentPassword" class="form-label">目前密碼</label>
                                        <input type="password" class="form-control" id="currentPassword">
                                    </div>
                                    <div class="mb-3">
                                        <label for="newPassword" class="form-label">新密碼</label>
                                        <input type="password" class="form-control" id="newPassword">
                                        <div class="form-text">密碼長度至少8個字符，必須包含數字和字母</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirmPassword" class="form-label">確認新密碼</label>
                                        <input type="password" class="form-control" id="confirmPassword">
                                    </div>
                                    <button type="submit" class="btn btn-primary">更新密碼</button>
                                </form>
                            </div>
                        </div>
                        
                        <!-- 通知設定 -->
                        <div class="dashboard-card mt-4">
                            <div class="card-header">
                                <h5>通知設定</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0">電子郵件通知</h6>
                                            <p class="text-muted mb-0">接收重要更新和提醒</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0">推薦通知</h6>
                                            <p class="text-muted mb-0">當店鋪被推薦時收到通知</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <h6 class="mb-0">評價通知</h6>
                                            <p class="text-muted mb-0">當收到新評價時收到通知</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-0">行銷通訊</h6>
                                            <p class="text-muted mb-0">接收活動和優惠資訊</p>
                                        </div>
                                        <label class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">儲存通知設定</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // 側邊欄切換
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    const navToggle = document.querySelector('.nav-toggle');
                    
                    navToggle.addEventListener('click', function() {
                        sidebar.classList.toggle('active');
                        mainContent.classList.toggle('active');
                    });
                    
                    // 內容區塊切換
                    const menuItems = document.querySelectorAll('.sidebar-menu li a');
                    const contentSections = document.querySelectorAll('.content-section');
                    
                    menuItems.forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            const target = item.getAttribute('href').substring(1);
                            const targetSection = document.getElementById(target + '-section');
                            
                            // 更新活躍菜單項
                            document.querySelector('.sidebar-menu li.active').classList.remove('active');
                            item.parentElement.classList.add('active');
                            
                            // 顯示對應的內容區塊
                            document.querySelector('.content-section.active').classList.remove('active');
                            targetSection.classList.add('active');
                        });
                    });
                    
                    // 商品類別添加表單顯示/隱藏
                    const addCategoryBtn = document.getElementById('addCategoryBtn');
                    const addCategoryForm = document.getElementById('addCategoryForm');
                    const cancelAddCategory = document.getElementById('cancelAddCategory');
                    
                    if (addCategoryBtn && addCategoryForm && cancelAddCategory) {
                        addCategoryBtn.addEventListener('click', function() {
                            addCategoryForm.style.display = 'block';
                        });
                        
                        cancelAddCategory.addEventListener('click', function() {
                            addCategoryForm.style.display = 'none';
                        });
                    }
                    
                    // 商品項目添加按鈕
                    const addProductBtns = document.querySelectorAll('.add-product-btn');
                    const coffeeItemForm = document.getElementById('coffeeItemForm');
                    const cancelItemBtns = document.querySelectorAll('.cancel-add-item');
                    
                    if (addProductBtns.length && coffeeItemForm && cancelItemBtns.length) {
                        addProductBtns.forEach(btn => {
                            btn.addEventListener('click', function() {
                                const category = btn.getAttribute('data-category');
                                if (category === 'coffee') {
                                    coffeeItemForm.style.display = 'block';
                                }
                            });
                        });
                        
                        cancelItemBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        coffeeItemForm.style.display = 'none';
                    });
                });
            }
            
            // 標籤輸入功能
            const tagContainer = document.getElementById('tagContainer');
            const tagInput = tagContainer?.querySelector('.tag-input');
            
            if (tagContainer && tagInput) {
                // 添加新標籤
                tagInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.value.trim() !== '') {
                        e.preventDefault();
                        
                        // 檢查是否已達到最大數量
                        const existingTags = tagContainer.querySelectorAll('.tag');
                        if (existingTags.length >= 10) {
                            alert('最多只能添加10個標籤');
                            return;
                        }
                        
                        // 檢查標籤長度
                        if (this.value.trim().length > 10) {
                            alert('標籤不能超過10個字');
                            return;
                        }
                        
                        // 創建新標籤元素
                        const tag = document.createElement('div');
                        tag.className = 'tag';
                        tag.innerHTML = this.value.trim() + '<span class="tag-close">&times;</span>';
                        
                        // 添加到容器
                        tagContainer.insertBefore(tag, this);
                        this.value = '';
                        
                        // 添加刪除事件
                        const closeBtn = tag.querySelector('.tag-close');
                        closeBtn.addEventListener('click', function() {
                            tag.remove();
                        });
                    }
                });
                
                // 為現有標籤添加刪除功能
                const existingTags = tagContainer.querySelectorAll('.tag');
                existingTags.forEach(tag => {
                    const closeBtn = tag.querySelector('.tag-close');
                    closeBtn.addEventListener('click', function() {
                        tag.remove();
                    });
                });
                
                // 為推薦標籤按鈕添加點擊事件
                const tagButtons = document.querySelectorAll('.btn-outline-secondary');
                tagButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tagText = this.textContent.trim();
                        
                        // 檢查是否已存在
                        const existingTags = tagContainer.querySelectorAll('.tag');
                        let isDuplicate = false;
                        
                        existingTags.forEach(tag => {
                            const tagContent = tag.textContent.replace('×', '').trim();
                            if (tagContent === tagText) {
                                isDuplicate = true;
                            }
                        });
                        
                        if (isDuplicate) {
                            alert('此標籤已添加');
                            return;
                        }
                        
                        // 檢查是否已達到最大數量
                        if (existingTags.length >= 10) {
                            alert('最多只能添加10個標籤');
                            return;
                        }
                        
                        // 創建新標籤元素
                        const tag = document.createElement('div');
                        tag.className = 'tag';
                        tag.innerHTML = tagText + '<span class="tag-close">&times;</span>';
                        
                        // 添加到容器
                        tagContainer.insertBefore(tag, tagInput);
                        
                        // 添加刪除事件
                        const closeBtn = tag.querySelector('.tag-close');
                        closeBtn.addEventListener('click', function() {
                            tag.remove();
                        });
                    });
                });
            }
            
            // 活動類型卡片選擇
            const activityCards = document.querySelectorAll('.activity-type-card');
            
            activityCards.forEach(card => {
                card.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    
                    // 更新選中數量
                    const selectedCount = document.querySelectorAll('.activity-type-card.selected').length;
                    const badge = document.querySelector('.badge.bg-primary');
                    if (badge) {
                        badge.textContent = `已選擇 ${selectedCount} 項`;
                    }
                });
            });
            
            // 圖片上傳預覽
            const imageUploads = document.querySelectorAll('input[type="file"][accept="image/*"]');
            
            imageUploads.forEach(input => {
                input.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (!files.length) return;
                    
                    const preview = this.closest('.card-body').querySelector('.image-preview');
                    if (!preview) return;
                    
                    // 清空預覽
                    while (preview.firstChild) {
                        preview.removeChild(preview.firstChild);
                    }
                    
                    // 創建預覽圖
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(files[0]);
                    preview.appendChild(img);
                    
                    // 添加刪除按鈕
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-image';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    preview.appendChild(removeBtn);
                    
                    // 添加刪除事件
                    removeBtn.addEventListener('click', function() {
                        img.remove();
                        removeBtn.remove();
                        input.value = '';
                        
                        // 重新添加上傳提示
                        const placeholder = document.createElement('div');
                        placeholder.className = 'upload-placeholder';
                        placeholder.innerHTML = '<i class="fas fa-image"></i><p>上傳圖片</p>';
                        preview.appendChild(placeholder);
                    });
                });
            });
            
            // 圖庫中的刪除按鈕
            const removeImageBtns = document.querySelectorAll('.gallery-item .remove-image');
            
            removeImageBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.gallery-item').remove();
                });
            });
            
            // 圖庫添加按鈕
            const addGalleryBtns = document.querySelectorAll('.add-gallery-item');
            
            addGalleryBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.querySelector('input[type="file"]').click();
                });
                
                const input = btn.querySelector('input[type="file"]');
                input.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (!files.length) return;
                    
                    // 獲取圖庫容器
                    const gallery = this.closest('.gallery-preview');
                    
                    // 循環創建新的圖庫項目
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        // 創建新的圖庫項目
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        
                        // 創建預覽圖
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.alt = file.name;
                        item.appendChild(img);
                        
                        // 添加刪除按鈕
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'remove-image';
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        item.appendChild(removeBtn);
                        
                        // 添加到圖庫，插入到添加按鈕之前
                        gallery.insertBefore(item, this.closest('.add-gallery-item'));
                        
                        // 添加刪除事件
                        removeBtn.addEventListener('click', function() {
                            item.remove();
                        });
                    }
                    
                    // 清空輸入，允許再次選擇相同的文件
                    input.value = '';
                });
            });
            
            // 初始化圖表
            if (typeof ApexCharts !== 'undefined') {
                // 熱門時段圖表
                const popularTimesOptions = {
                    series: [{
                        name: '訪客數',
                        data: [30, 40, 35, 50, 49, 60, 70, 91, 125, 150, 120, 100, 80, 75, 60]
                    }],
                    chart: {
                        type: 'bar',
                        height: 250,
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '55%',
                            borderRadius: 5
                        },
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        show: true,
                        width: 2,
                        colors: ['transparent']
                    },
                    xaxis: {
                        categories: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00'],
                    },
                    fill: {
                        opacity: 1,
                        colors: ['#9D7F86']
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return val + " 位"
                            }
                        }
                    }
                };
                
                const popularTimesChart = document.getElementById('popularTimesChart');
                if (popularTimesChart) {
                    new ApexCharts(popularTimesChart, popularTimesOptions).render();
                }
                
                // 推薦數據趨勢圖表
                const recommendationOptions = {
                    series: [{
                        name: '推薦次數',
                        data: [31, 40, 28, 51, 42, 109, 100]
                    }, {
                        name: '點擊次數',
                        data: [11, 32, 45, 32, 34, 52, 41]
                    }],
                    chart: {
                        height: 300,
                        type: 'area',
                        toolbar: {
                            show: false
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        curve: 'smooth'
                    },
                    xaxis: {
                        type: 'datetime',
                        categories: [
                            '2023-11-18T00:00:00.000Z',
                            '2023-11-19T00:00:00.000Z',
                            '2023-11-20T00:00:00.000Z',
                            '2023-11-21T00:00:00.000Z',
                            '2023-11-22T00:00:00.000Z',
                            '2023-11-23T00:00:00.000Z',
                            '2023-11-24T00:00:00.000Z'
                        ],
                    },
                    tooltip: {
                        x: {
                            format: 'dd/MM/yy'
                        },
                    },
                    colors: ['#9D7F86', '#D8CAB8']
                };
                
                const recommendationChart = document.getElementById('recommendationChart');
                if (recommendationChart) {
                    new ApexCharts(recommendationChart, recommendationOptions).render();
                }
                
                // 推薦來源分析
                const referralOptions = {
                    series: [44, 55, 13, 43],
                    chart: {
                        height: 300,
                        type: 'pie',
                    },
                    labels: ['附近推薦', '搜尋結果', '用戶個人喜好', '其他管道'],
                    colors: ['#9D7F86', '#D8CAB8', '#A7C4BC', '#BEB0A7'],
                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {
                                width: 200
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }]
                };
                
                const referralSourceChart = document.getElementById('referralSourceChart');
                if (referralSourceChart) {
                    new ApexCharts(referralSourceChart, referralOptions).render();
                }
                
                // 活動類型分布
                const activityTypeOptions = {
                    series: [{
                        data: [45, 30, 25]
                    }],
                    chart: {
                        height: 300,
                        type: 'bar',
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 10,
                            columnWidth: '40%',
                            distributed: true,
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    legend: {
                        show: false
                    },
                    xaxis: {
                        categories: ['咖啡廳', '吃飯', '喝酒'],
                        labels: {
                            style: {
                                fontSize: '12px'
                            }
                        }
                    },
                    colors: ['#9D7F86', '#D8CAB8', '#A7C4BC']
                };
                
                const activityTypeChart = document.getElementById('activityTypeChart');
                if (activityTypeChart) {
                    new ApexCharts(activityTypeChart, activityTypeOptions).render();
                }
                
                // 用戶人口統計
                const demographicsOptions = {
                    series: [{
                        name: '男性',
                        data: [13, 23, 20, 8, 5]
                    }, {
                        name: '女性',
                        data: [11, 17, 15, 15, 10]
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        stacked: true,
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: true,
                            borderRadius: 5
                        },
                    },
                    stroke: {
                        width: 1,
                        colors: ['#fff']
                    },
                    xaxis: {
                        categories: ['18-24', '25-34', '35-44', '45-54', '55+'],
                    },
                    yaxis: {
                        title: {
                            text: '年齡群組'
                        },
                    },
                    fill: {
                        opacity: 1
                    },
                    legend: {
                        position: 'top',
                        horizontalAlign: 'left',
                        offsetX: 40
                    },
                    colors: ['#9D7F86', '#D8CAB8']
                };
                
                const demographicsChart = document.getElementById('demographicsChart');
                if (demographicsChart) {
                    new ApexCharts(demographicsChart, demographicsOptions).render();
                }
                
                // 熱門標籤
                const popularTagsOptions = {
                    series: [{
                        name: '搜索量',
                        data: [45, 42, 38, 35, 32, 28, 22, 18]
                    }],
                    chart: {
                        height: 250,
                        type: 'bar',
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 5,
                            columnWidth: '40%',
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    xaxis: {
                        categories: ['精品咖啡', '手工甜點', '安靜環境', '插座充足', '不限時', '寵物友善', '文青風格', '適合約會'],
                        labels: {
                            style: {
                                fontSize: '12px'
                            }
                        }
                    },
                    colors: ['#9D7F86']
                };
                
                const popularTagsChart = document.getElementById('popularTagsChart');
                if (popularTagsChart) {
                    new ApexCharts(popularTagsChart, popularTagsOptions).render();
                }
            }
        });



        // 全域變數
        let currentUser = null;
        let venueData = null;
        let promotionsData = [];
        let analyticsData = null;

        // 監聽認證狀態
        auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            // 加載店家資料
            await loadVenueData();
            // 加載數據分析
            await loadAnalyticsData();
            // 加載優惠資料
            await loadPromotions();
            // 加載商品項目
            await loadMenuItems();
            // 更新UI
            updateDashboardUI();
        } else {
            // 未登入，重定向到登入頁
            window.location.href = "login.html";
        }
        });

        // 加載店家資料
        async function loadVenueData() {
            try {
                const venueDoc = await db.collection("venues").doc(currentUser.uid).get();
                
                if (venueDoc.exists) {
                    venueData = venueDoc.data();
                    
                    // 更新導航欄用戶資訊
                    document.getElementById("navUserName").textContent = venueData.name || "未命名店家";
                    if (venueData.profileImageUrl) {
                        document.getElementById("navUserImage").src = venueData.profileImageUrl;
                    }
                    
                    // 更新基本資料欄位
                    document.getElementById("storeName").value = venueData.name || "";
                    document.getElementById("storePhone").value = venueData.phoneNumber || "";
                    document.getElementById("storeEmail").value = venueData.email || "";
                    document.getElementById("storeWebsite").value = venueData.website || "";
                    document.getElementById("storeDescription").value = venueData.description || "";
                    
                    // 更新店家主圖
                    if (venueData.imageUrl) {
                        const mainImagePreview = document.querySelector(".image-preview");
                        mainImagePreview.innerHTML = `
                        <img src="${venueData.imageUrl}" alt="店家主圖">
                        <div class="remove-image">
                            <i class="fas fa-times"></i>
                        </div>
                        `;
                        
                        // 添加刪除事件
                        const removeBtn = mainImagePreview.querySelector('.remove-image');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function() {
                                // 在此實現刪除圖片的邏輯
                                if (confirm('確定要刪除主圖嗎?')) {
                                    removeMainImage();
                                }
                            });
                        }
                    }
                    
                    // 更新營業狀態
                    const isActiveToggle = document.querySelector('input[type="checkbox"][checked]');
                    if (isActiveToggle) {
                        isActiveToggle.checked = venueData.isActive || false;
                    }
                    
                    // 更新營業時間
                    if (venueData.openingHours && venueData.openingHours.length > 0) {
                        updateOpeningHours(venueData.openingHours);
                    }
                    
                    // 更新活動類型
                    if (venueData.activityTypes && venueData.activityTypes.length > 0) {
                        updateActivityTypes(venueData.activityTypes);
                    }
                    
                    // 更新標籤
                    if (venueData.tags && venueData.tags.length > 0) {
                        updateTags(venueData.tags);
                    }
                    
                    // 更新照片畫廊
                    if (venueData.galleryImages && venueData.galleryImages.length > 0) {
                        updateGallery(venueData.galleryImages);
                    }
                    
                    // 更新帳戶資訊
                    const userDoc = await db.collection("users").doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        document.getElementById("accountEmail").value = currentUser.email || "";
                        document.getElementById("accountName").value = userData.displayName || "";
                        document.getElementById("accountPhone").value = userData.phoneNumber || "";
                        document.getElementById("accountPosition").value = userData.position || "";
                    }
                } else {
                    // 店家資料不存在，可能是新用戶
                    console.log("店家資料不存在，請建立資料");
                    showAlert("歡迎使用店家管理平台！請完善您的店家資料。", "info");
                    
                    // 預設營業狀態為開啟
                    const isActiveToggle = document.querySelector('input[type="checkbox"][checked]');
                    if (isActiveToggle) {
                        isActiveToggle.checked = true;
                    }
                    
                    // 設置預設營業時間
                    initDefaultOpeningHours();
                }
            } catch (error) {
                console.error("載入店家資料錯誤:", error);
                showAlert("載入資料時發生錯誤，請稍後再試", "danger");
            }
        }

        // 移除主圖
        async function removeMainImage() {
            try {
                if (!venueData || !venueData.imageUrl) return;
                
                // 從存儲中刪除文件
                const imageRef = storage.refFromURL(venueData.imageUrl);
                await imageRef.delete();
                
                // 從資料庫中刪除引用
                await db.collection("venues").doc(currentUser.uid).update({
                    imageUrl: firebase.firestore.FieldValue.delete(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 更新本地數據
                delete venueData.imageUrl;
                
                // 更新UI
                const mainImagePreview = document.querySelector(".image-preview");
                mainImagePreview.innerHTML = `
                    <div class="upload-placeholder">
                        <i class="fas fa-image"></i>
                        <p>上傳店家主圖</p>
                    </div>
                `;
                
                showAlert("店家主圖已成功刪除", "success");
            } catch (error) {
                console.error("刪除主圖時發生錯誤:", error);
                showAlert("刪除主圖失敗，請稍後再試", "danger");
            }
        }

        // 初始化預設營業時間選擇器
        function initDefaultOpeningHours() {
            const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"];
            const hourSelectionDivs = document.querySelectorAll(".hours-selection");
            
            days.forEach((day, index) => {
                const selects = hourSelectionDivs[index].querySelectorAll("select");
                if (selects.length === 2) {
                    // 預設開始和結束時間（可以根據需要調整）
                    const defaultOpen = index < 5 ? "09:00" : "10:00"; // 週一至週五 9:00，週末 10:00
                    const defaultClose = index < 5 ? "19:00" : "20:00"; // 週一至週五 19:00，週末 20:00
                    
                    // 生成時間選項（如果尚未生成）
                    if (selects[0].options.length <= 1) {
                        generateTimeOptions(selects[0], "07:00", "22:00", "30");
                        generateTimeOptions(selects[1], "07:00", "22:00", "30");
                    }
                    
                    // 設置預設值
                    setSelectValue(selects[0], defaultOpen);
                    setSelectValue(selects[1], defaultClose);
                }
            });
        }

        // 根據資料庫資料更新營業時間
        function updateOpeningHours(hours) {
            const hourSelectionDivs = document.querySelectorAll(".hours-selection");
            
            hours.forEach((hourData, index) => {
                if (index < hourSelectionDivs.length) {
                    const selects = hourSelectionDivs[index].querySelectorAll("select");
                    if (selects.length === 2) {
                        // 確保選項已生成
                        if (selects[0].options.length <= 1) {
                            generateTimeOptions(selects[0], "07:00", "22:00", "30");
                            generateTimeOptions(selects[1], "07:00", "22:00", "30");
                        }
                        
                        // 設置值
                        setSelectValue(selects[0], hourData.open);
                        setSelectValue(selects[1], hourData.close);
                    }
                }
            });
        }

        // 生成時間選項
        function generateTimeOptions(selectElement, startTime, endTime, interval) {
            // 清空現有選項，保留第一個"請選擇"選項
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            
            // 解析開始和結束時間
            const start = parseTimeString(startTime);
            const end = parseTimeString(endTime);
            const step = parseInt(interval, 10);
            
            // 生成時間選項
            for (let minutes = start; minutes <= end; minutes += step) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                const timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
                
                const option = document.createElement('option');
                option.value = timeStr;
                option.textContent = timeStr;
                selectElement.appendChild(option);
            }
        }

        // 解析時間字符串為分鐘數
        function parseTimeString(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // 設置選擇器的值
        function setSelectValue(selectElement, value) {
            if (!value) return;
            
            // 尋找匹配的選項
            for (let i = 0; i < selectElement.options.length; i++) {
                if (selectElement.options[i].value === value) {
                    selectElement.selectedIndex = i;
                    return;
                }
            }
            
            // 如果沒找到匹配的選項，添加一個新選項
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value;
            option.selected = true;
            selectElement.appendChild(option);
        }

        // 加載數據分析
        async function loadAnalyticsData() {
            try {
                const analyticsDoc = await db.collection("analytics").doc("venues").collection(currentUser.uid).doc("stats").get();
                
                if (analyticsDoc.exists) {
                    analyticsData = analyticsDoc.data();
                    
                    // 更新儀表板數據卡
                    document.getElementById("viewCountStat").textContent = analyticsData.viewCount || 0;
                    document.getElementById("favoriteCountStat").textContent = analyticsData.favoriteCount || 0;
                    document.getElementById("ratingAverageStat").textContent = analyticsData.averageRating?.toFixed(1) || "0.0";
                    document.getElementById("recommendCountStat").textContent = analyticsData.recommendCount || 0;
                    
                    // 更新圖表數據
                    updateAnalyticsCharts(analyticsData);
                } else {
                    // 創建默認統計數據
                    analyticsData = {
                        viewCount: 0,
                        favoriteCount: 0,
                        averageRating: 0,
                        recommendCount: 0,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // 保存到資料庫
                    await db.collection("analytics").doc("venues").collection(currentUser.uid).doc("stats").set(analyticsData);
                    
                    // 更新UI
                    document.getElementById("viewCountStat").textContent = "0";
                    document.getElementById("favoriteCountStat").textContent = "0";
                    document.getElementById("ratingAverageStat").textContent = "0.0";
                    document.getElementById("recommendCountStat").textContent = "0";
                }
            } catch (error) {
                console.error("載入數據分析錯誤:", error);
                showAlert("載入數據分析時發生錯誤，請稍後再試", "warning");
            }
        }

        // 加載優惠資料
        async function loadPromotions() {
            try {
                const promotionsSnapshot = await db.collection("promotions")
                .where("venueId", "==", currentUser.uid)
                .get();
                
                promotionsData = [];
                promotionsSnapshot.forEach(doc => {
                promotionsData.push({
                    id: doc.id,
                    ...doc.data()
                });
                });
                
                // 更新優惠列表
                updatePromotionsList(promotionsData);
            } catch (error) {
                console.error("載入優惠資料錯誤:", error);
            }
        }

        // 加載商品項目
        async function loadMenuItems() {
            try {
                const menuItemsSnapshot = await db.collection("menuItems")
                .where("venueId", "==", currentUser.uid)
                .get();
                
                // 整理商品項目，按類別分組
                const menuItemsByCategory = {};
                
                menuItemsSnapshot.forEach(doc => {
                const item = {
                    id: doc.id,
                    ...doc.data()
                };
                
                if (!menuItemsByCategory[item.category]) {
                    menuItemsByCategory[item.category] = [];
                }
                
                menuItemsByCategory[item.category].push(item);
                });
                
                // 更新商品列表
                updateMenuItemsList(menuItemsByCategory);
            } catch (error) {
                console.error("載入商品項目錯誤:", error);
            }
        }

        // 更新商品列表 UI
        function updateMenuItemsList(menuItemsByCategory) {
            const categoryList = document.getElementById("categoryList");
            if (!categoryList) return;
            
            // 清空現有內容
            categoryList.innerHTML = "";
            
            // 為每個類別創建區塊
            for (const [category, items] of Object.entries(menuItemsByCategory)) {
                const categoryElement = document.createElement("div");
                categoryElement.className = "product-item";
                categoryElement.innerHTML = `
                <div class="product-category">
                    <span>${category}</span>
                    <div class="actions">
                    <button class="btn btn-sm btn-outline-primary add-product-btn" data-category="${category}">新增項目</button>
                    <button class="btn btn-sm btn-outline-secondary edit-category-btn" data-category="${category}">編輯</button>
                    <button class="btn btn-sm btn-outline-danger delete-category-btn" data-category="${category}">刪除</button>
                    </div>
                </div>
                <div class="product-item-list" id="${category.replace(/\s+/g, '-').toLowerCase()}-items">
                </div>
                `;
                
                categoryList.appendChild(categoryElement);
                
                // 獲取該類別的項目列表容器
                const itemsList = categoryElement.querySelector('.product-item-list');
                
                // 添加商品項目表單 (初始隱藏)
                const itemFormId = `${category.replace(/\s+/g, '-').toLowerCase()}-item-form`;
                const itemForm = document.createElement("div");
                itemForm.className = "menu-item-form";
                itemForm.id = itemFormId;
                itemForm.innerHTML = `
                <h6>新增${category}項目</h6>
                <div class="row">
                    <div class="col-md-6">
                    <div class="mb-3">
                        <label for="${itemFormId}-name" class="form-label">商品名稱</label>
                        <input type="text" class="form-control" id="${itemFormId}-name" placeholder="輸入商品名稱">
                    </div>
                    </div>
                    <div class="col-md-6">
                    <div class="mb-3">
                        <label for="${itemFormId}-price" class="form-label">價格</label>
                        <input type="number" class="form-control" id="${itemFormId}-price" placeholder="輸入價格">
                    </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="${itemFormId}-desc" class="form-label">描述</label>
                    <textarea class="form-control" id="${itemFormId}-desc" rows="2" placeholder="描述商品特色或口味"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">在APP中顯示</label>
                    <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="${itemFormId}-display" checked>
                    <label class="form-check-label" for="${itemFormId}-display">顯示此商品在APP中</label>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary save-item-btn" data-category="${category}">儲存項目</button>
                    <button type="button" class="btn btn-outline-secondary cancel-add-item" data-form="${itemFormId}">取消</button>
                </div>
                `;
                
                itemsList.appendChild(itemForm);
                
                // 添加項目列表
                items.forEach(item => {
                const itemElement = document.createElement("div");
                itemElement.className = "product-subitem";
                itemElement.dataset.id = item.id;
                itemElement.innerHTML = `
                    <div>
                    <span class="product-name">${item.name}</span>
                    <span class="product-description">${item.description || ''}</span>
                    ${!item.displayInApp ? '<span class="badge bg-secondary">不顯示</span>' : ''}
                    </div>
                    <div class="d-flex align-items-center gap-3">
                    <span class="text-primary fw-bold">$${item.price}</span>
                    <button class="btn btn-sm btn-outline-secondary edit-item-btn" data-id="${item.id}">編輯</button>
                    <button class="btn btn-sm btn-outline-danger delete-item-btn" data-id="${item.id}">刪除</button>
                    </div>
                `;
                
                itemsList.appendChild(itemElement);
                });
            }
            
            // 添加「新增類別」按鈕的事件監聽
            const addCategoryBtn = document.getElementById("addCategoryBtn");
            if (addCategoryBtn) {
                addCategoryBtn.addEventListener("click", function() {
                document.getElementById("addCategoryForm").style.display = "block";
                });
            }
            
            // 添加類別表單取消按鈕事件監聽
            const cancelAddCategory = document.getElementById("cancelAddCategory");
            if (cancelAddCategory) {
                cancelAddCategory.addEventListener("click", function() {
                document.getElementById("addCategoryForm").style.display = "none";
                });
            }
            
            // 為所有「新增項目」按鈕添加事件監聽
            document.querySelectorAll(".add-product-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                const category = this.getAttribute("data-category");
                const formId = `${category.replace(/\s+/g, '-').toLowerCase()}-item-form`;
                document.getElementById(formId).style.display = "block";
                });
            });
            
            // 為所有「取消」按鈕添加事件監聽
            document.querySelectorAll(".cancel-add-item").forEach(btn => {
                btn.addEventListener("click", function() {
                const formId = this.getAttribute("data-form");
                document.getElementById(formId).style.display = "none";
                });
            });
            
            // 為所有「儲存項目」按鈕添加事件監聽
            document.querySelectorAll(".save-item-btn").forEach(btn => {
                btn.addEventListener("click", async function() {
                const category = this.getAttribute("data-category");
                const formId = `${category.replace(/\s+/g, '-').toLowerCase()}-item-form`;
                
                const name = document.getElementById(`${formId}-name`).value;
                const price = parseFloat(document.getElementById(`${formId}-price`).value);
                const description = document.getElementById(`${formId}-desc`).value;
                const displayInApp = document.getElementById(`${formId}-display`).checked;
                
                if (!name || isNaN(price)) {
                    showAlert("請填寫完整商品資料", "warning");
                    return;
                }
                
                try {
                    // 添加到 Firestore
                    await db.collection("menuItems").add({
                    venueId: currentUser.uid,
                    category: category,
                    name: name,
                    price: price,
                    description: description,
                    displayInApp: displayInApp,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 重新加載項目
                    await loadMenuItems();
                    
                    // 重置表單
                    document.getElementById(`${formId}`).style.display = "none";
                    document.getElementById(`${formId}-name`).value = "";
                    document.getElementById(`${formId}-price`).value = "";
                    document.getElementById(`${formId}-desc`).value = "";
                    
                    showAlert("商品項目已成功添加", "success");
                } catch (error) {
                    console.error("添加商品項目錯誤:", error);
                    showAlert("添加商品項目失敗，請稍後再試", "danger");
                }
                });
            });
            
            // 刪除項目按鈕事件監聽
            document.querySelectorAll(".delete-item-btn").forEach(btn => {
                btn.addEventListener("click", async function() {
                if (!confirm("確定要刪除此商品項目嗎？")) return;
                
                const itemId = this.getAttribute("data-id");
                
                try {
                    await db.collection("menuItems").doc(itemId).delete();
                    await loadMenuItems();
                    showAlert("商品項目已成功刪除", "success");
                } catch (error) {
                    console.error("刪除商品項目錯誤:", error);
                    showAlert("刪除商品項目失敗，請稍後再試", "danger");
                }
                });
            });
        }

        // 更新優惠列表 UI
        function updatePromotionsList(promotions) {
            const promotionsTableBody = document.querySelector("#promotions-section .dashboard-table tbody");
            if (!promotionsTableBody) return;
            
            // 清空現有內容
            promotionsTableBody.innerHTML = "";
            
            // 添加優惠項目
            promotions.forEach(promo => {
                const startDate = promo.startDate ? new Date(promo.startDate.toDate()).toLocaleDateString() : "未設定";
                const endDate = promo.endDate ? new Date(promo.endDate.toDate()).toLocaleDateString() : "未設定";
                
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${promo.title}</td>
                <td>${promo.type}</td>
                <td>${promo.targetAudience}</td>
                <td>${startDate} - ${endDate}</td>
                <td><span class="status-badge ${promo.isActive ? 'active' : 'inactive'}">${promo.isActive ? '進行中' : '已結束'}</span></td>
                <td>${promo.viewCount || 0}</td>
                <td>${promo.usageCount || 0}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary edit-promotion-btn" data-id="${promo.id}">編輯</button>
                    <button class="btn btn-sm btn-outline-${promo.isActive ? 'danger' : 'success'} toggle-promotion-btn" data-id="${promo.id}" data-status="${promo.isActive}">
                    ${promo.isActive ? '暫停' : '啟用'}
                    </button>
                </td>
                `;
                
                promotionsTableBody.appendChild(row);
            });
            
            // 為所有「編輯優惠」按鈕添加事件監聽
            document.querySelectorAll(".edit-promotion-btn").forEach(btn => {
                btn.addEventListener("click", function() {
                const promotionId = this.getAttribute("data-id");
                // 跳轉到優惠編輯頁面或打開編輯模態框
                editPromotion(promotionId);
                });
            });
            
            // 為所有「啟用/暫停」按鈕添加事件監聽
            document.querySelectorAll(".toggle-promotion-btn").forEach(btn => {
                btn.addEventListener("click", async function() {
                const promotionId = this.getAttribute("data-id");
                const currentStatus = this.getAttribute("data-status") === "true";
                
                try {
                    await db.collection("promotions").doc(promotionId).update({
                    isActive: !currentStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 重新加載優惠
                    await loadPromotions();
                    
                    showAlert(`優惠已${!currentStatus ? '啟用' : '暫停'}`, "success");
                } catch (error) {
                    console.error("更新優惠狀態錯誤:", error);
                    showAlert("更新優惠狀態失敗，請稍後再試", "danger");
                }
                });
            });
        }

        // 更新標籤
        function updateTags(tags) {
            const tagContainer = document.getElementById("tagContainer");
            if (!tagContainer) return;
            
            // 清空現有標籤，但保留輸入框
            const tagInput = tagContainer.querySelector(".tag-input");
            tagContainer.innerHTML = "";
            
            // 添加標籤
            tags.forEach(tag => {
                const tagElement = document.createElement("div");
                tagElement.className = "tag";
                tagElement.innerHTML = `
                ${tag}
                <span class="tag-close">&times;</span>
                `;
                
                tagContainer.appendChild(tagElement);
                
                // 添加刪除事件
                const closeBtn = tagElement.querySelector(".tag-close");
                if (closeBtn) {
                    closeBtn.addEventListener("click", function() {
                        tagElement.remove();
                    });
                }
            });
            
            // 添加輸入框
            tagContainer.appendChild(tagInput || createTagInput());
            
            // 添加輸入事件
            if (tagInput) {
                addTagInputEvents(tagInput);
            }
        }

        // 創建標籤輸入框
        function createTagInput() {
            const input = document.createElement("input");
            input.type = "text";
            input.className = "tag-input";
            input.placeholder = "輸入標籤，按Enter添加";
            
            addTagInputEvents(input);
            
            return input;
        }

        // 添加標籤輸入事件
        function addTagInputEvents(inputElement) {
            inputElement.addEventListener("keydown", function(e) {
                if (e.key === "Enter" && this.value.trim() !== "") {
                    e.preventDefault();
                    
                    const tagContainer = this.closest(".tag-input-container");
                    if (!tagContainer) return;
                    
                    // 檢查是否已達到最大數量
                    const existingTags = tagContainer.querySelectorAll(".tag");
                    if (existingTags.length >= 10) {
                        showAlert("最多只能添加10個標籤", "warning");
                        return;
                    }
                    
                    // 檢查標籤長度
                    if (this.value.trim().length > 10) {
                        showAlert("標籤不能超過10個字", "warning");
                        return;
                    }
                    
                    // 創建新標籤元素
                    const tag = document.createElement("div");
                    tag.className = "tag";
                    tag.innerHTML = this.value.trim() + '<span class="tag-close">&times;</span>';
                    
                    // 添加到容器
                    tagContainer.insertBefore(tag, this);
                    this.value = "";
                    
                    // 添加刪除事件
                    const closeBtn = tag.querySelector(".tag-close");
                    closeBtn.addEventListener("click", function() {
                        tag.remove();
                    });
                }
            });
        }

        // 更新活動類型
        function updateActivityTypes(activityTypes) {
            const activityCards = document.querySelectorAll(".activity-type-card");
            
            // 重置所有卡片
            activityCards.forEach(card => {
                card.classList.remove("selected");
            });
            
            // 選中對應活動類型
            activityTypes.forEach(type => {
                activityCards.forEach(card => {
                if (card.querySelector("p").textContent === type) {
                    card.classList.add("selected");
                }
                });
            });
            
            // 更新選擇數量顯示
            const selectedCount = document.querySelectorAll(".activity-type-card.selected").length;
            const badge = document.querySelector(".badge.bg-primary");
            if (badge) {
                badge.textContent = `已選擇 ${selectedCount} 項`;
            }
        }

        // 更新營業時間
        function updateOpeningHours(hours) {
            // 營業時間有7天，對應索引0-6
            for (let i = 0; i < 7; i++) {
                if (hours[i]) {
                const daySelects = document.querySelectorAll(`.hours-selection:nth-child(${i + 1}) select`);
                    if (daySelects.length === 2) {
                        // 設置開始時間和結束時間
                        const openOptions = daySelects[0].querySelectorAll('option');
                        const closeOptions = daySelects[1].querySelectorAll('option');
                        
                        for (let open of openOptions) {
                            if (open.value === hours[i].open) {
                                open.selected = true;
                                break;
                            }
                        }
                        
                        for (let close of closeOptions) {
                            if (close.value === hours[i].close) {
                                close.selected = true;
                                break;
                            }
                        }
                    }
                }
            }
        }

        // 更新圖片畫廊
        function updateGallery(images) {
            // 更新環境照片畫廊
            const galleryPreview = document.querySelector("#photos-section .gallery-preview");
            if (galleryPreview) {
                // 保留添加按鈕
                const addBtn = galleryPreview.querySelector(".add-gallery-item");
                galleryPreview.innerHTML = "";
                
                images.forEach(imageUrl => {
                    const galleryItem = document.createElement("div");
                    galleryItem.className = "gallery-item";
                    galleryItem.innerHTML = `
                        <img src="${imageUrl}" alt="店內環境">
                        <div class="remove-image">
                        <i class="fas fa-times"></i>
                        </div>
                    `;
                    
                    galleryPreview.appendChild(galleryItem);
                    
                    // 添加刪除事件
                    const removeBtn = galleryItem.querySelector(".remove-image");
                    removeBtn.addEventListener("click", function() {
                        if (confirm("確定要刪除此照片？")) {
                        removeGalleryImage(imageUrl);
                        galleryItem.remove();
                        }
                    });
                });
                
                // 重新添加上傳按鈕
                galleryPreview.appendChild(addBtn);
            }
        }

        // 刪除畫廊圖片
        async function removeGalleryImage(imageUrl) {
            try {
                // 從存儲中刪除文件
                const storageRef = firebase.storage().refFromURL(imageUrl);
                await storageRef.delete();
                
                // 從店家數據中移除 URL
                const updatedImages = venueData.galleryImages.filter(url => url !== imageUrl);
                
                await db.collection("venues").doc(currentUser.uid).update({
                galleryImages: updatedImages,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                venueData.galleryImages = updatedImages;
                
                showAlert("照片已成功刪除", "success");
            } catch (error) {
                console.error("刪除照片錯誤:", error);
                showAlert("刪除照片失敗，請稍後再試", "danger");
            }
        }

        // 創建新優惠
        async function createPromotion(promotionData) {
            try {
                // 添加文件到 Firestore
                const docRef = await db.collection("promotions").add({
                venueId: currentUser.uid,
                viewCount: 0,
                usageCount: 0,
                isActive: true,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                ...promotionData
                });
                
                // 如果有圖片，上傳到 Storage
                if (promotionData.imageFile) {
                const imageUrl = await uploadPromotionImage(docRef.id, promotionData.imageFile);
                
                // 更新文檔添加圖片 URL
                await docRef.update({
                    imageUrl: imageUrl
                });
                }
                
                // 重新加載優惠
                await loadPromotions();
                
                return { success: true, id: docRef.id };
            } catch (error) {
                console.error("創建優惠錯誤:", error);
                return { success: false, error: error.message };
            }
        }

        // 上傳優惠圖片
        async function uploadPromotionImage(promotionId, imageFile) {
        const storageRef = storage.ref(`promotions/${currentUser.uid}/${promotionId}`);
        await storageRef.put(imageFile);
        return await storageRef.getDownloadURL();
        }

        // 提交店家資料表單
        async function submitVenueForm() {
            try {
                // 顯示載入提示
                const saveBtn = document.querySelector("#profile-section .btn-primary");
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 儲存中...';
                saveBtn.disabled = true;
                
                const nameInput = document.getElementById("storeName");
                const phoneInput = document.getElementById("storePhone");
                const emailInput = document.getElementById("storeEmail");
                const websiteInput = document.getElementById("storeWebsite");
                const descriptionInput = document.getElementById("storeDescription");
                const isActiveToggle = document.querySelector('input[type="checkbox"][checked]');
                
                // 驗證必填字段
                if (!nameInput.value) {
                    showAlert("請填寫店家名稱", "warning");
                    saveBtn.innerHTML = originalBtnText;
                    saveBtn.disabled = false;
                    return;
                }
                
                // 收集營業時間
                const openingHours = [];
                const hourSelectionDivs = document.querySelectorAll(".hours-selection");
                hourSelectionDivs.forEach((div, index) => {
                    const selects = div.querySelectorAll("select");
                    if (selects.length === 2) {
                        openingHours[index] = {
                            day: index,
                            open: selects[0].value,
                            close: selects[1].value
                        };
                    }
                });
                
                // 收集選中的活動類型
                const activityTypes = [];
                const selectedActivityCards = document.querySelectorAll(".activity-type-card.selected");
                selectedActivityCards.forEach(card => {
                    activityTypes.push(card.querySelector("p").textContent);
                });
                
                // 收集標籤
                const tags = [];
                const tagElements = document.querySelectorAll("#tagContainer .tag");
                tagElements.forEach(tag => {
                    tags.push(tag.textContent.replace('×', '').trim());
                });
                
                // 檢查是否有店家文檔
                let venueDocRef = db.collection("venues").doc(currentUser.uid);
                let venueDoc = await venueDocRef.get();
                
                // 準備更新的數據
                const venueData = {
                    name: nameInput.value,
                    phoneNumber: phoneInput.value,
                    email: emailInput.value,
                    website: websiteInput.value,
                    description: descriptionInput.value,
                    isActive: isActiveToggle ? isActiveToggle.checked : false,
                    openingHours: openingHours,
                    activityTypes: activityTypes,
                    tags: tags,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 如果文檔不存在，添加創建時間
                if (!venueDoc.exists) {
                    venueData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                // 更新 Firestore 文檔
                await venueDocRef.set(venueData, { merge: true });
                
                // 更新本地數據
                window.venueData = {
                    ...window.venueData,
                    ...venueData
                };
                
                // 更新UI
                document.getElementById("navUserName").textContent = venueData.name;
                
                // 恢復按鈕狀態
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
                
                showAlert("店家資料已成功更新", "success");
            } catch (error) {
                console.error("更新店家資料錯誤:", error);
                showAlert("更新店家資料失敗，請稍後再試", "danger");
                
                // 恢復按鈕狀態
                const saveBtn = document.querySelector("#profile-section .btn-primary");
                saveBtn.innerHTML = '儲存變更';
                saveBtn.disabled = false;
            }
        }

        // 更新分析圖表
        function updateAnalyticsCharts(data) {
            if (typeof ApexCharts !== 'undefined') {
                // 熱門時段圖表
                if (data.popularTimes && data.popularTimes.length > 0) {
                const popularTimesOptions = {
                    series: [{
                    name: '訪客數',
                    data: data.popularTimes
                    }],
                    chart: {
                    type: 'bar',
                    height: 250,
                    toolbar: {
                        show: false
                    }
                    },
                    plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        borderRadius: 5
                    },
                    },
                    dataLabels: {
                    enabled: false
                    },
                    stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                    },
                    xaxis: {
                    categories: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00'],
                    },
                    fill: {
                    opacity: 1,
                    colors: ['#9D7F86']
                    },
                    tooltip: {
                    y: {
                        formatter: function (val) {
                        return val + " 位"
                        }
                    }
                    }
                };
                
                const popularTimesChart = document.getElementById('popularTimesChart');
                if (popularTimesChart) {
                    new ApexCharts(popularTimesChart, popularTimesOptions).render();
                }
                }
                
                // 推薦數據趨勢圖表
                if (data.recommendTrend && data.clickTrend) {
                    const recommendationOptions = {
                        series: [{
                        name: '推薦次數',
                        data: data.recommendTrend.counts
                        }, {
                        name: '點擊次數',
                        data: data.clickTrend.counts
                        }],
                        chart: {
                        height: 300,
                        type: 'area',
                        toolbar: {
                            show: false
                        }
                        },
                        dataLabels: {
                        enabled: false
                        },
                        stroke: {
                        curve: 'smooth'
                        },
                        xaxis: {
                        type: 'datetime',
                        categories: data.recommendTrend.dates,
                        },
                        tooltip: {
                        x: {
                            format: 'dd/MM/yy'
                        },
                        },
                        colors: ['#9D7F86', '#D8CAB8']
                    };
                    
                    const recommendationChart = document.getElementById('recommendationChart');
                    if (recommendationChart) {
                        new ApexCharts(recommendationChart, recommendationOptions).render();
                    }
                }
                
                // 其他圖表...
                // (類似方式實現其他圖表的數據更新)
            }
        }

        // 顯示提示訊息
        function showAlert(message, type = "success") {
            const alertDiv = document.createElement("div");
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = "alert";
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // 添加到頁面
            const mainContent = document.querySelector(".main-content");
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            // 自動關閉
            setTimeout(() => {
                alertDiv.classList.remove("show");
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        // 添加頁面加載事件
        document.addEventListener("DOMContentLoaded", async function() {
            // 初始化表單提交事件
            const saveProfileBtn = document.querySelector("#profile-section .btn-primary");
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener("click", submitVenueForm);
            }
            
            // 初始化標籤提交
            const saveTagsBtn = document.querySelector("#activities-section .card-header .btn-primary");
            if (saveTagsBtn) {
                saveTagsBtn.addEventListener("click", async function() {
                    await updateVenueTags();
                });
            }
            
            // 初始化側邊欄
            initSidebar();
            
            // 初始化圖表
            initCharts();
            
            // 初始化表單驗證
            initFormValidation();
        });

        // 添加表單驗證初始化
        function initFormValidation() {
            // 為所有必填字段添加驗證
            const requiredFields = document.querySelectorAll('input[required], textarea[required], select[required]');
            
            requiredFields.forEach(field => {
                field.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.classList.add('is-invalid');
                        
                        // 檢查是否已存在錯誤提示
                        let feedback = this.nextElementSibling;
                        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                            feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback';
                            feedback.textContent = '此欄位為必填';
                            this.after(feedback);
                        }
                    } else {
                        this.classList.remove('is-invalid');
                        
                        // 移除錯誤提示
                        const feedback = this.nextElementSibling;
                        if (feedback && feedback.classList.contains('invalid-feedback')) {
                            feedback.remove();
                        }
                    }
                });
            });
            
            // 為電子郵件欄位添加格式驗證
            const emailFields = document.querySelectorAll('input[type="email"]');
            emailFields.forEach(field => {
                field.addEventListener('blur', function() {
                    if (this.value && !isValidEmail(this.value)) {
                        this.classList.add('is-invalid');
                        
                        // 檢查是否已存在錯誤提示
                        let feedback = this.nextElementSibling;
                        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                            feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback';
                            feedback.textContent = '請輸入有效的電子郵件地址';
                            this.after(feedback);
                        }
                    }
                });
            });
            
            // 為網址欄位添加格式驗證
            const urlFields = document.querySelectorAll('input[type="url"]');
            urlFields.forEach(field => {
                field.addEventListener('blur', function() {
                    if (this.value && !isValidUrl(this.value)) {
                        this.classList.add('is-invalid');
                        
                        // 檢查是否已存在錯誤提示
                        let feedback = this.nextElementSibling;
                        if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                            feedback = document.createElement('div');
                            feedback.className = 'invalid-feedback';
                            feedback.textContent = '請輸入有效的網址，包含http://或https://';
                            this.after(feedback);
                        }
                    }
                });
            });
        }

        // 驗證電子郵件格式
        function isValidEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        // 驗證URL格式
        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch (e) {
                return false;
            }
        }

        // 初始化表單提交事件
        const saveProfileBtn = document.querySelector("#profile-section .btn-primary");
        if (saveProfileBtn) {
            saveProfileBtn.addEventListener("click", submitVenueForm);
        }
        
        // 初始化標籤提交
        const saveTagsBtn = document.querySelector("#activities-section .card-header .btn-primary");
        if (saveTagsBtn) {
            saveTagsBtn.addEventListener("click", async function() {
            // 收集標籤
            const tags = [];
            const tagElements = document.querySelectorAll("#tagContainer .tag");
            tagElements.forEach(tag => {
                tags.push(tag.textContent.replace('×', '').trim());
            });
            
            try {
                // 更新 Firestore
                await db.collection("venues").doc(currentUser.uid).update({
                tags: tags,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 更新本地數據
                venueData.tags = tags;
                
                showAlert("標籤已成功更新", "success");
            } catch (error) {
                console.error("更新標籤錯誤:", error);
                showAlert("更新標籤失敗，請稍後再試", "danger");
            }
            });
        }
        
        // 初始化店家主圖上傳
        const mainImageUpload = document.getElementById("mainImageUpload");
        if (mainImageUpload) {
            mainImageUpload.addEventListener("change", async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 檢查文件類型和大小
            if (!file.type.match('image.*')) {
                showAlert("請上傳圖片文件", "warning");
                return;
            }
            
            if (file.size > 2 * 1024 * 1024) { // 2MB
                showAlert("檔案大小不能超過 2MB", "warning");
                return;
            }
            
            try {
                // 顯示加載
                showAlert("正在上傳圖片，請稍候...", "info");
                
                // 上傳到 Storage
                const storageRef = storage.ref(`venues/${currentUser.uid}/main`);
                await storageRef.put(file);
                const imageUrl = await storageRef.getDownloadURL();
                
                // 更新 Firestore
                await db.collection("venues").doc(currentUser.uid).update({
                imageUrl: imageUrl,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 更新預覽
                const mainImagePreview = document.querySelector(".image-preview");
                mainImagePreview.innerHTML = `
                <img src="${imageUrl}" alt="店家主圖">
                <div class="remove-image">
                    <i class="fas fa-times"></i>
                </div>
                `;
                
                // 更新本地數據
                venueData.imageUrl = imageUrl;
                
                showAlert("店家主圖已成功更新", "success");
            } catch (error) {
                console.error("上傳圖片錯誤:", error);
                showAlert("上傳圖片失敗，請稍後再試", "danger");
            }
            });
        }

        // 初始化店家主圖上傳
        function initMainImageUpload() {
            const mainImageUpload = document.getElementById("mainImageUpload");
            if (mainImageUpload) {
                mainImageUpload.addEventListener("change", async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // 檢查文件類型和大小
                    if (!file.type.match('image.*')) {
                        showAlert("請上傳圖片文件", "warning");
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        showAlert("檔案大小不能超過 5MB", "warning");
                        return;
                    }
                    
                    try {
                        // 顯示加載
                        showAlert("正在上傳圖片，請稍候...", "info");
                        
                        // 壓縮圖片
                        const compressedFile = await compressImage(file, 1200, 600);
                        
                        // 上傳到 Storage
                        const storageRef = storage.ref(`venues/${currentUser.uid}/main`);
                        await storageRef.put(compressedFile);
                        const imageUrl = await storageRef.getDownloadURL();
                        
                        // 更新 Firestore
                        await db.collection("venues").doc(currentUser.uid).update({
                            imageUrl: imageUrl,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // 更新預覽
                        const mainImagePreview = document.querySelector(".image-preview");
                        mainImagePreview.innerHTML = `
                        <img src="${imageUrl}" alt="店家主圖">
                        <div class="remove-image">
                            <i class="fas fa-times"></i>
                        </div>
                        `;
                        
                        // 添加刪除事件
                        const removeBtn = mainImagePreview.querySelector('.remove-image');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function() {
                                if (confirm('確定要刪除主圖嗎?')) {
                                    removeMainImage();
                                }
                            });
                        }
                        
                        // 更新本地數據
                        if (!venueData) venueData = {};
                        venueData.imageUrl = imageUrl;
                        
                        showAlert("店家主圖已成功更新", "success");
                    } catch (error) {
                        console.error("上傳圖片錯誤:", error);
                        showAlert("上傳圖片失敗，請稍後再試", "danger");
                    } finally {
                        // 清空文件輸入，允許上傳相同檔案
                        mainImageUpload.value = '';
                    }
                });
            }
        }

        // 壓縮圖片函數
        async function compressImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // 計算縮放比例
                        if (width > maxWidth) {
                            height = (maxWidth / width) * height;
                            width = maxWidth;
                        }
                        
                        if (height > maxHeight) {
                            width = (maxHeight / height) * width;
                            height = maxHeight;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 將畫布轉換為Blob
                        canvas.toBlob(blob => {
                            // 創建一個新文件，保持原始檔名
                            const compressedFile = new File([blob], file.name, {
                                type: file.type,
                                lastModified: Date.now()
                            });
                            
                            resolve(compressedFile);
                        }, file.type, 0.7); // 壓縮質量0.7
                    };
                    
                    img.onerror = function() {
                        reject(new Error('圖片加載失敗'));
                    };
                };
                
                reader.onerror = function() {
                    reject(new Error('文件讀取失敗'));
                };
            });
        }

        // 更新店家標籤
        async function updateVenueTags() {
            try {
                // 獲取按鈕並顯示載入狀態
                const saveBtn = document.querySelector("#activities-section .card-header .btn-primary");
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 儲存中...';
                saveBtn.disabled = true;
                
                // 收集標籤
                const tags = [];
                const tagElements = document.querySelectorAll("#tagContainer .tag");
                tagElements.forEach(tag => {
                    tags.push(tag.textContent.replace('×', '').trim());
                });
                
                // 更新 Firestore
                await db.collection("venues").doc(currentUser.uid).update({
                    tags: tags,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 更新本地數據
                if (!venueData) venueData = {};
                venueData.tags = tags;
                
                // 恢復按鈕狀態
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
                showAlert("標籤已成功更新", "success");
            } catch (error) {
                console.error("更新標籤錯誤:", error);
                showAlert("更新標籤失敗，請稍後再試", "danger");
                
                // 恢復按鈕狀態
                const saveBtn = document.querySelector("#activities-section .card-header .btn-primary");
                if (saveBtn) {
                    saveBtn.textContent = '儲存標籤';
                    saveBtn.disabled = false;
                }
            }
        }
        
        // 初始化優惠表單
        const promotionForm = document.querySelector("#promotions-section form");
        if (promotionForm) {
            promotionForm.addEventListener("submit", async function(e) {
            e.preventDefault();
            
            const titleInput = document.getElementById("promotionTitle");
            const typeSelect = document.getElementById("promotionType");
            const descInput = document.getElementById("promotionDesc");
            const startInput = document.getElementById("promotionStart");
            const endInput = document.getElementById("promotionEnd");
            const targetAudience = document.querySelector('input[name="targetAudience"]:checked');
            const imageUpload = document.getElementById("couponImageUpload");
            
            // 驗證數據
            if (!titleInput.value || !descInput.value || !startInput.value || !endInput.value) {
                showAlert("請填寫所有必填字段", "warning");
                return;
            }
            
            // 準備優惠數據
            const promotionData = {
                title: titleInput.value,
                type: typeSelect.value,
                description: descInput.value,
                startDate: firebase.firestore.Timestamp.fromDate(new Date(startInput.value)),
                endDate: firebase.firestore.Timestamp.fromDate(new Date(endInput.value)),
                targetAudience: targetAudience ? targetAudience.value : "所有用戶",
                // 自動生成優惠代碼
                promotionCode: generatePromotionCode()
            };
            
            // 如果有圖片
            if (imageUpload.files.length > 0) {
                promotionData.imageFile = imageUpload.files[0];
            }
            
            try {
                // 顯示加載
                showAlert("正在創建優惠，請稍候...", "info");
                
                // 創建優惠
                const result = await createPromotion(promotionData);
                
                if (result.success) {
                // 重置表單
                promotionForm.reset();
                
                showAlert("優惠已成功創建", "success");
                } else {
                showAlert("創建優惠失敗: " + result.error, "danger");
                }
            } catch (error) {
                console.error("創建優惠錯誤:", error);
                showAlert("創建優惠失敗，請稍後再試", "danger");
            }
            });
        }
        
        // 初始化側邊欄選項菜單
        initSidebar();


        // 生成隨機優惠代碼
        function generatePromotionCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // 初始化側邊欄
        function initSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        const navToggle = document.querySelector('.nav-toggle');
        
        if (navToggle) {
            navToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
            });
        }
        
        // 內容區塊切換
        const menuItems = document.querySelectorAll('.sidebar-menu li a');
        const contentSections = document.querySelectorAll('.content-section');
        
        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
            e.preventDefault();
            
            const target = item.getAttribute('href').substring(1);
            const targetSection = document.getElementById(target + '-section');
            
            // 更新活躍菜單項
            document.querySelector('.sidebar-menu li.active').classList.remove('active');
            item.parentElement.classList.add('active');
            
            // 顯示對應的內容區塊
            document.querySelector('.content-section.active').classList.remove('active');
            targetSection.classList.add('active');
            });
        });
        }
        
    </script>

    <script>
        let map;
        let marker;
        let geocoder;
        
        // 初始化地圖
        function initMap() {
            // 預設位置 (台北市中心)
            const defaultPosition = { lat: 25.033964, lng: 121.564468 };
            
            // 從Firestore中獲取店家位置（如果有）
            if (venueData && venueData.location) {
                defaultPosition.lat = venueData.location.latitude;
                defaultPosition.lng = venueData.location.longitude;
            }
            
            // 初始化地圖
            map = new google.maps.Map(document.getElementById('mapContainer'), {
                center: defaultPosition,
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
            });
            
            // 初始化地標標記
            marker = new google.maps.Marker({
                position: defaultPosition,
                map: map,
                draggable: true,
                animation: google.maps.Animation.DROP,
            });
            
            // 初始化地理編碼器
            geocoder = new google.maps.Geocoder();
            
            // 更新座標顯示
            document.getElementById('latitude').value = defaultPosition.lat.toFixed(6);
            document.getElementById('longitude').value = defaultPosition.lng.toFixed(6);
            
            // 獲取地標拖動後的位置
            google.maps.event.addListener(marker, 'dragend', function() {
                const position = marker.getPosition();
                updateLocationFields(position);
                
                // 根據經緯度取得地址
                geocoder.geocode({ location: position }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        document.getElementById('formattedAddress').value = results[0].formatted_address;
                    }
                });
            });
            
            // 搜尋地址按鈕事件
            document.getElementById('searchLocationBtn').addEventListener('click', function() {
                searchLocation();
            });
            
            // 地址搜尋框按下Enter事件
            document.getElementById('locationSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocation();
                }
            });
            
            // 如果已有地址信息，顯示在文本區
            if (venueData && venueData.address) {
                document.getElementById('formattedAddress').value = venueData.address;
            }
        }
        
        // 搜尋地址
        function searchLocation() {
            const address = document.getElementById('locationSearch').value;
            if (!address) return;
            
            geocoder.geocode({ address: address }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const position = results[0].geometry.location;
                    
                    // 更新地圖中心和標記位置
                    map.setCenter(position);
                    marker.setPosition(position);
                    
                    // 更新顯示欄位
                    updateLocationFields(position);
                    document.getElementById('formattedAddress').value = results[0].formatted_address;
                } else {
                    showAlert('無法找到該地址，請嘗試其他關鍵字', 'warning');
                }
            });
        }
        
        // 更新位置欄位
        function updateLocationFields(position) {
            document.getElementById('latitude').value = position.lat().toFixed(6);
            document.getElementById('longitude').value = position.lng().toFixed(6);
        }
        
        // 儲存位置按鈕事件
        document.getElementById('saveLocationBtn').addEventListener('click', async function() {
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            const formattedAddress = document.getElementById('formattedAddress').value;
            
            if (isNaN(lat) || isNaN(lng) || !formattedAddress) {
                showAlert('位置資訊不完整，請確保已設定位置', 'warning');
                return;
            }
            
            try {
                // 更新Firestore中的位置資訊
                await db.collection("venues").doc(currentUser.uid).update({
                    location: new firebase.firestore.GeoPoint(lat, lng),
                    address: formattedAddress,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 更新本地數據
                venueData.location = new firebase.firestore.GeoPoint(lat, lng);
                venueData.address = formattedAddress;
                
                showAlert('店家位置已成功更新', 'success');
            } catch (error) {
                console.error('更新位置時發生錯誤:', error);
                showAlert('更新位置失敗，請稍後再試', 'danger');
            }
        });
        
        // 在頁面載入完成後加載Google Maps API
        document.addEventListener('DOMContentLoaded', function() {
            // 頁面加載時檢查是否已登入
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // 加載Google Maps API (替換YOUR_API_KEY為您的Google Maps API金鑰)
                    loadGoogleMapsAPI();
                }
            });
        });
        
        // 加載Google Maps API
        function loadGoogleMapsAPI() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyByRzxE7olx04Q_-ckYIKNyI9uJnZ_p_-Y&libraries=places&callback=initMap`;
            script.defer = true;
            script.async = true;
            document.head.appendChild(script);
        }
    </script>

    <script>
        // 優惠管理相關功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化優惠圖片上傳預覽
            const couponImageUpload = document.getElementById('couponImageUpload');
            const promotionImagePreview = document.getElementById('promotionImagePreview');
            
            if (couponImageUpload) {
                couponImageUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // 檢查文件類型和大小
                    if (!file.type.match('image.*')) {
                        showAlert("請上傳圖片文件", "warning");
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) { // 5MB
                        showAlert("圖片大小不能超過 5MB", "warning");
                        return;
                    }
                    
                    // 創建預覽
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        promotionImagePreview.innerHTML = `
                            <img src="${e.target.result}" alt="優惠預覽" style="max-width: 100%; max-height: 200px; object-fit: contain;">
                            <div class="remove-image">
                                <i class="fas fa-times"></i>
                            </div>
                        `;
                        
                        // 添加刪除事件
                        const removeBtn = promotionImagePreview.querySelector('.remove-image');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function() {
                                promotionImagePreview.innerHTML = `
                                    <div class="upload-placeholder">
                                        <i class="fas fa-image"></i>
                                        <p>上傳優惠券圖片</p>
                                    </div>
                                `;
                                couponImageUpload.value = '';
                            });
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // 優惠表單提交
            const promotionForm = document.getElementById('promotionForm');
            if (promotionForm) {
                promotionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // 獲取表單數據
                    const title = document.getElementById('promotionTitle').value;
                    const type = document.getElementById('promotionType').value;
                    const description = document.getElementById('promotionDesc').value;
                    const startDate = document.getElementById('promotionStart').value;
                    const endDate = document.getElementById('promotionEnd').value;
                    const targetAudience = document.querySelector('input[name="targetAudience"]:checked').value;
                    const usageLimit = document.getElementById('usageLimit').value;
                    const statsEnabled = document.getElementById('statsEnabled').checked;
                    const imageFile = document.getElementById('couponImageUpload').files[0];
                    
                    // 驗證日期
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    if (start > end) {
                        showAlert("結束日期必須晚於開始日期", "warning");
                        return;
                    }
                    
                    try {
                        // 顯示加載
                        showAlert("正在創建優惠，請稍候...", "info");
                        
                        // 生成唯一的優惠代碼
                        const promotionCode = generatePromotionCode();
                        
                        // 上傳圖片
                        let imageUrl = null;
                        if (imageFile) {
                            const storageRef = storage.ref(`promotions/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
                            await storageRef.put(imageFile);
                            imageUrl = await storageRef.getDownloadURL();
                        }
                        
                        // 創建優惠數據
                        const promotionData = {
                            venueId: currentUser.uid,
                            title: title,
                            type: type,
                            description: description,
                            startDate: firebase.firestore.Timestamp.fromDate(start),
                            endDate: firebase.firestore.Timestamp.fromDate(end),
                            targetAudience: targetAudience,
                            usageLimit: usageLimit ? parseInt(usageLimit) : null,
                            statsEnabled: statsEnabled,
                            imageUrl: imageUrl,
                            promotionCode: promotionCode,
                            isActive: true,
                            viewCount: 0,
                            usageCount: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // 添加到Firestore
                        await db.collection("promotions").add(promotionData);
                        
                        // 重置表單
                        promotionForm.reset();
                        promotionImagePreview.innerHTML = `
                            <div class="upload-placeholder">
                                <i class="fas fa-image"></i>
                                <p>上傳優惠券圖片</p>
                            </div>
                        `;
                        
                        // 重新加載優惠列表
                        await loadPromotions();
                        
                        showAlert("優惠已成功創建", "success");
                    } catch (error) {
                        console.error("創建優惠時發生錯誤:", error);
                        showAlert("創建優惠失敗，請稍後再試", "danger");
                    }
                });
            }
            
            // 取消按鈕
            const resetPromotionForm = document.getElementById('resetPromotionForm');
            if (resetPromotionForm) {
                resetPromotionForm.addEventListener('click', function() {
                    promotionForm.reset();
                    promotionImagePreview.innerHTML = `
                        <div class="upload-placeholder">
                            <i class="fas fa-image"></i>
                            <p>上傳優惠券圖片</p>
                        </div>
                    `;
                });
            }
            
            // 優惠搜尋
            const searchPromotionBtn = document.getElementById('searchPromotionBtn');
            if (searchPromotionBtn) {
                searchPromotionBtn.addEventListener('click', filterPromotions);
            }
            
            const promotionSearch = document.getElementById('promotionSearch');
            if (promotionSearch) {
                promotionSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        filterPromotions();
                    }
                });
            }
            
            const promotionFilter = document.getElementById('promotionFilter');
            if (promotionFilter) {
                promotionFilter.addEventListener('change', filterPromotions);
            }
            
            // 初始化優惠效益分析圖表
            initPromotionAnalytics();
        });
        
        // 加載優惠列表
        async function loadPromotions() {
            try {
                const promotionsTableBody = document.getElementById('promotionsTableBody');
                if (!promotionsTableBody) return;
                
                // 顯示加載中
                promotionsTableBody.innerHTML = `
                    <tr class="text-center">
                        <td colspan="8" class="py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">載入中...</span>
                            </div>
                            <p class="mt-2 text-muted">載入優惠列表...</p>
                        </td>
                    </tr>
                `;
                
                // 查詢優惠
                const snapshot = await db.collection("promotions")
                    .where("venueId", "==", currentUser.uid)
                    .orderBy("createdAt", "desc")
                    .get();
                
                // 更新UI
                let tableHTML = '';
                let activeCount = 0;
                let inactiveCount = 0;
                
                if (snapshot.empty) {
                    tableHTML = `
                        <tr class="text-center">
                            <td colspan="8" class="py-4">
                                <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                                <p>尚未創建任何優惠</p>
                                <p class="text-muted">創建優惠吸引更多顧客！</p>
                            </td>
                        </tr>
                    `;
                } else {
                    snapshot.forEach(doc => {
                        const promotion = doc.data();
                        promotion.id = doc.id;
                        
                        // 檢查優惠是否在有效期內
                        const now = new Date();
                        const startDate = promotion.startDate.toDate();
                        const endDate = promotion.endDate.toDate();
                        const isTimeValid = now >= startDate && now <= endDate;
                        
                        // 更新計數
                        if (promotion.isActive && isTimeValid) {
                            activeCount++;
                        } else {
                            inactiveCount++;
                        }
                        
                        // 格式化日期
                        const startFormatted = startDate.toLocaleDateString();
                        const endFormatted = endDate.toLocaleDateString();
                        
                        // 翻譯目標受眾
                        let audienceText = "所有用戶";
                        if (promotion.targetAudience === "brewdate") {
                            audienceText = "BREWDATE用戶";
                        } else if (promotion.targetAudience === "first_visit") {
                            audienceText = "首次造訪用戶";
                        }
                        
                        // 生成表格行
                        tableHTML += `
                            <tr data-id="${promotion.id}" data-status="${promotion.isActive && isTimeValid ? 'active' : 'inactive'}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="promotion-icon me-2">
                                            ${getPromotionTypeIcon(promotion.type)}
                                        </div>
                                        <div>
                                            <div class="fw-bold">${promotion.title}</div>
                                            <div class="small text-muted">${promotion.promotionCode}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${translatePromotionType(promotion.type)}</td>
                                <td>${audienceText}</td>
                                <td>${startFormatted} - ${endFormatted}</td>
                                <td>
                                    <span class="status-badge ${promotion.isActive && isTimeValid ? 'active' : 'inactive'}">
                                        ${promotion.isActive && isTimeValid ? '進行中' : '已結束'}
                                    </span>
                                </td>
                                <td>${promotion.viewCount || 0}</td>
                                <td>
                                    <span class="fw-bold">${promotion.usageCount || 0}</span>
                                    ${promotion.usageLimit ? `<span class="text-muted small">/${promotion.usageLimit}</span>` : ''}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary edit-promotion-btn" data-id="${promotion.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-${promotion.isActive ? 'danger' : 'success'} toggle-promotion-btn" 
                                            data-id="${promotion.id}" data-status="${promotion.isActive}">
                                            <i class="fas fa-${promotion.isActive ? 'pause' : 'play'}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info view-qr-btn" data-id="${promotion.id}" 
                                            data-code="${promotion.promotionCode}" data-title="${promotion.title}">
                                            <i class="fas fa-qrcode"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                // 更新表格和計數
                promotionsTableBody.innerHTML = tableHTML;
                document.querySelector('.promotion-active-count').textContent = `${activeCount} 個進行中`;
                document.querySelector('.promotion-inactive-count').textContent = `${inactiveCount} 個已結束`;
                
                // 添加按鈕事件
                addPromotionButtonListeners();
                
                // 更新分析數據
                updatePromotionAnalytics();
            } catch (error) {
                console.error("載入優惠時發生錯誤:", error);
                promotionsTableBody.innerHTML = `
                    <tr class="text-center">
                        <td colspan="8" class="py-4">
                            <i class="fas fa-exclamation-triangle text-warning fa-2x mb-3"></i>
                            <p>載入優惠資料時出錯</p>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadPromotions()">重試</button>
                        </td>
                    </tr>
                `;
            }
        }

        // 添加優惠按鈕事件
        function addPromotionButtonListeners() {
            // 編輯按鈕
            document.querySelectorAll('.edit-promotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const promotionId = this.getAttribute('data-id');
                    editPromotion(promotionId);
                });
            });
            
            // 狀態切換按鈕
            document.querySelectorAll('.toggle-promotion-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const promotionId = this.getAttribute('data-id');
                    const isActive = this.getAttribute('data-status') === 'true';
                    togglePromotionStatus(promotionId, !isActive);
                });
            });
            
            // 查看QR碼按鈕
            document.querySelectorAll('.view-qr-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const promotionId = this.getAttribute('data-id');
                    const promotionCode = this.getAttribute('data-code');
                    const promotionTitle = this.getAttribute('data-title');
                    showPromotionQR(promotionId, promotionCode, promotionTitle);
                });
            });
        }

        // 編輯優惠
        async function editPromotion(promotionId) {
            try {
                // 獲取優惠詳情
                const doc = await db.collection("promotions").doc(promotionId).get();
                if (!doc.exists) {
                    showAlert("找不到此優惠", "warning");
                    return;
                }
                
                const promotion = doc.data();
                
                // 彈出編輯對話框
                showPromotionEditModal(promotionId, promotion);
            } catch (error) {
                console.error("獲取優惠詳情時發生錯誤:", error);
                showAlert("獲取優惠詳情失敗，請稍後再試", "danger");
            }
        }

        // 切換優惠狀態
        async function togglePromotionStatus(promotionId, newStatus) {
            try {
                await db.collection("promotions").doc(promotionId).update({
                    isActive: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 重新加載優惠列表
                await loadPromotions();
                
                showAlert(`優惠已${newStatus ? '啟用' : '暫停'}`, "success");
            } catch (error) {
                console.error("更新優惠狀態時發生錯誤:", error);
                showAlert("更新優惠狀態失敗，請稍後再試", "danger");
            }
        }

        // 顯示優惠QR碼和短連結
        function showPromotionQR(promotionId, promotionCode, promotionTitle) {
            // 創建QR碼數據
            const qrData = `https://brewdate.com/p/${promotionCode}`;
            
            // 創建模態框
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'qrCodeModal';
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('aria-hidden', 'true');
            
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">優惠兌換碼</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center">
                            <h6 class="mb-3">${promotionTitle}</h6>
                            <div class="mb-3">
                                <div id="qrcode" class="d-inline-block border p-2 rounded"></div>
                            </div>
                            <div class="mb-3">
                                <p class="mb-1 text-muted small">優惠碼</p>
                                <div class="d-flex align-items-center justify-content-center">
                                    <h4 class="text-monospace mb-0 me-2">${promotionCode}</h4>
                                    <button class="btn btn-sm btn-outline-primary copy-code-btn" data-code="${promotionCode}">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <p class="mb-1 text-muted small">短連結</p>
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="form-control-plaintext text-center me-2">brewdate.com/p/${promotionCode}</div>
                                    <button class="btn btn-sm btn-outline-primary copy-link-btn" data-link="https://brewdate.com/p/${promotionCode}">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle me-2"></i>
                                客戶可通過APP掃描此QR碼或輸入優惠碼來獲取此優惠
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                            <button type="button" class="btn btn-primary" id="downloadQRBtn">
                                <i class="fas fa-download me-2"></i>下載QR碼
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到文檔
            document.body.appendChild(modal);
            
            // 創建Bootstrap模態框實例
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
            
            // 使用 qrcode.js 庫生成QR碼
            // 注意：您需要在HTML中引入qrcode.js庫
            if (typeof QRCode !== 'undefined') {
                const qrcode = new QRCode(document.getElementById("qrcode"), {
                    text: qrData,
                    width: 200,
                    height: 200,
                    colorDark: "#4A4A4A",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            } else {
                document.getElementById("qrcode").innerHTML = `
                    <div class="alert alert-warning">
                        QR碼生成庫未載入，請確保已引入qrcode.js
                    </div>
                `;
            }
            
            // 複製優惠碼按鈕
            const copyCodeBtn = modal.querySelector('.copy-code-btn');
            if (copyCodeBtn) {
                copyCodeBtn.addEventListener('click', function() {
                    const code = this.getAttribute('data-code');
                    navigator.clipboard.writeText(code).then(() => {
                        this.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                });
            }
            
            // 複製連結按鈕
            const copyLinkBtn = modal.querySelector('.copy-link-btn');
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', function() {
                    const link = this.getAttribute('data-link');
                    navigator.clipboard.writeText(link).then(() => {
                        this.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-copy"></i>';
                        }, 2000);
                    });
                });
            }
            
            // 下載QR碼按鈕
            const downloadQRBtn = document.getElementById('downloadQRBtn');
            if (downloadQRBtn) {
                downloadQRBtn.addEventListener('click', function() {
                    const canvas = document.querySelector('#qrcode canvas');
                    if (canvas) {
                        const a = document.createElement('a');
                        a.href = canvas.toDataURL('image/png');
                        a.download = `BREWDATE-優惠碼-${promotionCode}.png`;
                        a.click();
                    }
                });
            }
            
            // 模態框關閉時清理
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        // 篩選優惠列表
        function filterPromotions() {
            const searchValue = document.getElementById('promotionSearch').value.toLowerCase();
            const filterValue = document.getElementById('promotionFilter').value;
            const rows = document.querySelectorAll('#promotionsTableBody tr[data-id]');
            
            rows.forEach(row => {
                const titleElement = row.querySelector('td:first-child .fw-bold');
                const status = row.getAttribute('data-status');
                
                if (!titleElement) return;
                
                const title = titleElement.textContent.toLowerCase();
                const shouldShowBySearch = !searchValue || title.includes(searchValue);
                const shouldShowByFilter = filterValue === 'all' || status === filterValue;
                
                row.style.display = shouldShowBySearch && shouldShowByFilter ? '' : 'none';
            });
        }

        // 初始化優惠分析圖表
        function initPromotionAnalytics() {
            if (typeof ApexCharts !== 'undefined' && document.getElementById('promotionUsageChart')) {
                const options = {
                    series: [{
                        name: '使用次數',
                        data: []
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '55%',
                            borderRadius: 5
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    xaxis: {
                        categories: []
                    },
                    yaxis: {
                        title: {
                            text: '使用次數'
                        }
                    },
                    fill: {
                        opacity: 1,
                        colors: ['#9D7F86']
                    },
                    tooltip: {
                        y: {
                            formatter: function(val) {
                                return val + " 次";
                            }
                        }
                    },
                    noData: {
                        text: '沒有可用的數據',
                        align: 'center',
                        verticalAlign: 'middle',
                        style: {
                            color: '#9D7F86',
                            fontSize: '18px',
                            fontFamily: 'Noto Sans TC'
                        }
                    }
                };
                
                window.promotionUsageChart = new ApexCharts(document.getElementById('promotionUsageChart'), options);
                window.promotionUsageChart.render();
                
                // 添加時間段選擇事件
                document.querySelectorAll('.card-header .btn-group .btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelector('.card-header .btn-group .btn.active').classList.remove('active');
                        this.classList.add('active');
                        
                        const period = parseInt(this.getAttribute('data-period'));
                        updatePromotionAnalytics(period);
                    });
                });
            }
        }

        // 更新優惠分析數據
        async function updatePromotionAnalytics(period = 7) {
            try {
                // 獲取優惠使用記錄
                const now = new Date();
                const startDate = new Date();
                startDate.setDate(now.getDate() - period);
                
                const snapshot = await db.collection("promotionUsage")
                    .where("venueId", "==", currentUser.uid)
                    .where("timestamp", ">=", firebase.firestore.Timestamp.fromDate(startDate))
                    .orderBy("timestamp", "asc")
                    .get();
                
                if (snapshot.empty) {
                    // 無數據時重置圖表
                    if (window.promotionUsageChart) {
                        window.promotionUsageChart.updateOptions({
                            series: [{
                                name: '使用次數',
                                data: []
                            }],
                            xaxis: {
                                categories: []
                            }
                        });
                    }
                    
                    // 更新統計數字
                    document.getElementById('totalPromotionUsage').textContent = '0';
                    document.getElementById('avgDailyUsage').textContent = '0';
                    document.getElementById('appGeneratedCustomers').textContent = '0';
                    document.getElementById('mostPopularPromotion').textContent = '-';
                    
                    return;
                }
                
                // 處理數據
                const usageData = [];
                let totalUsage = 0;
                const promotionUsage = {};
                const dailyUsage = {};
                
                snapshot.forEach(doc => {
                    const usage = doc.data();
                    totalUsage++;
                    
                    // 按優惠計數
                    if (!promotionUsage[usage.promotionId]) {
                        promotionUsage[usage.promotionId] = {
                            count: 0,
                            title: usage.promotionTitle
                        };
                    }
                    promotionUsage[usage.promotionId].count++;
                    
                    // 按日期計數
                    const date = usage.timestamp.toDate().toLocaleDateString();
                    if (!dailyUsage[date]) {
                        dailyUsage[date] = 0;
                    }
                    dailyUsage[date]++;
                    
                    usageData.push(usage);
                });
                
                // 找出最熱門優惠
                let mostPopularPromotion = null;
                let maxUsage = 0;
                
                for (const id in promotionUsage) {
                    if (promotionUsage[id].count > maxUsage) {
                        maxUsage = promotionUsage[id].count;
                        mostPopularPromotion = promotionUsage[id];
                    }
                }
                
                // 更新圖表
                if (window.promotionUsageChart) {
                    // 生成日期範圍
                    const dateRange = [];
                    const usageCounts = [];
                    
                    for (let d = new Date(startDate); d <= now; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toLocaleDateString();
                        dateRange.push(dateStr);
                        usageCounts.push(dailyUsage[dateStr] || 0);
                    }
                    
                    window.promotionUsageChart.updateOptions({
                        series: [{
                            name: '使用次數',
                            data: usageCounts
                        }],
                        xaxis: {
                            categories: dateRange
                        }
                    });
                }
                
                // 更新統計數字
                document.getElementById('totalPromotionUsage').textContent = totalUsage;
                document.getElementById('avgDailyUsage').textContent = (totalUsage / period).toFixed(1);
                document.getElementById('appGeneratedCustomers').textContent = usageData.filter(u => u.source === 'app').length;
                document.getElementById('mostPopularPromotion').textContent = mostPopularPromotion ? mostPopularPromotion.title : '-';
                
            } catch (error) {
                console.error("獲取優惠使用數據時發生錯誤:", error);
            }
        }

        // 輔助函數：獲取優惠類型圖標
        function getPromotionTypeIcon(type) {
            let iconClass = '';
            switch (type) {
                case 'discount':
                    iconClass = 'fa-percentage';
                    break;
                case 'gift':
                    iconClass = 'fa-gift';
                    break;
                case 'combo':
                    iconClass = 'fa-box';
                    break;
                case 'special':
                    iconClass = 'fa-star';
                    break;
                default:
                    iconClass = 'fa-ticket-alt';
            }
            
            return `<i class="fas ${iconClass}"></i>`;
        }

        // 翻譯優惠類型
        function translatePromotionType(type) {
            switch (type) {
                case 'discount':
                    return '折扣';
                case 'gift':
                    return '贈品';
                case 'combo':
                    return '套餐';
                case 'special':
                    return '特別優惠';
                default:
                    return '其他';
            }
        }

        // 生成隨機優惠代碼
        function generatePromotionCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        </script>

<script>
    // 等待 Firebase 初始化完成後再綁定事件
    document.addEventListener('firebase-ready', function() {
        console.log('Firebase 初始化完成，開始綁定登出按鈕');
        
        // 綁定所有登出按鈕
        const logoutButtons = document.querySelectorAll('#logoutLink, a[href="#"][id="logoutLink"]');
        logoutButtons.forEach(btn => {
            if (btn) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    performLogout();
                });
                console.log('已綁定登出按鈕:', btn);
            }
        });
    });
    
    // 改進的登出功能
    function performLogout() {
        console.log('開始登出流程...');
        
        // 顯示加載狀態
        const logoutButtons = document.querySelectorAll('#logoutLink, a[href="#"][id="logoutLink"]');
        logoutButtons.forEach(btn => {
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登出中...';
                btn.disabled = true;
                // 保存原始文本以便恢復
                btn.setAttribute('data-original-text', originalText);
            }
        });
        
        // 使用全局 auth 物件
        try {
            if (window.auth) {
                // 使用模組化方式登出
                window.auth.signOut().then(() => {
                    logoutSuccess();
                }).catch(error => {
                    logoutError(error);
                });
            } else if (window.firebase && window.firebase.auth) {
                // 使用全局 firebase 物件登出 (後備方案)
                window.firebase.auth.signOut().then(() => {
                    logoutSuccess();
                }).catch(error => {
                    logoutError(error);
                });
            } else {
                // 兩種方法都失敗，嘗試直接重定向
                console.error('找不到登出方法，嘗試直接重定向');
                forceRedirect();
            }
        } catch (error) {
            console.error('登出過程中發生錯誤:', error);
            logoutError(error);
        }
        
        // 設置超時，防止無限等待
        setTimeout(() => {
            forceRedirect();
        }, 5000);
    }
    
    // 登出成功處理
    function logoutSuccess() {
        console.log('登出成功');
        
        // 清除本地存儲
        try {
            localStorage.clear();
            sessionStorage.clear();
        } catch (e) {
            console.warn('清除存儲時出錯:', e);
        }
        
        // 顯示成功消息
        showAlert('登出成功，正在跳轉...', 'success');
        
        // 延遲重定向以顯示訊息
        setTimeout(() => {
            // 添加時間戳防止快取
            window.location.href = 'business-login.html?t=' + new Date().getTime();
        }, 1000);
    }
    
    // 登出錯誤處理
    function logoutError(error) {
        console.error('登出時發生錯誤:', error);
        
        // 恢復按鈕狀態
        const logoutButtons = document.querySelectorAll('#logoutLink, a[href="#"][id="logoutLink"]');
        logoutButtons.forEach(btn => {
            if (btn) {
                const originalText = btn.getAttribute('data-original-text') || '<i class="fas fa-sign-out-alt"></i> 登出';
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
        
        // 顯示錯誤訊息
        showAlert('登出失敗，請重新嘗試', 'danger');
    }
    
    // 強制重定向（最後的後備方案）
    function forceRedirect() {
        console.warn('強制重定向到登入頁面');
        showAlert('重新導向到登入頁面...', 'warning');
        
        setTimeout(() => {
            document.cookie = ""; // 清除 cookies
            window.location.href = 'business-login.html?forced=true&t=' + new Date().getTime();
        }, 1000);
    }
    
    // 顯示提示訊息
    function showAlert(message, type = 'info') {
        // 檢查是否已有提示，避免重複
        const existingAlerts = document.querySelectorAll('.alert-floating');
        existingAlerts.forEach(alert => alert.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '15px';
        alertDiv.style.left = '50%';
        alertDiv.style.transform = 'translateX(-50%)';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        alertDiv.style.minWidth = '300px';
        alertDiv.role = 'alert';
        
        alertDiv.innerHTML = `
            <strong>${type === 'success' ? '✓' : type === 'danger' ? '✗' : 'ℹ'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 自動關閉
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }
    </script>
</body>
</html>


