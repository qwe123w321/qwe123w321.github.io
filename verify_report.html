<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå°</title>
    <!-- Firebase SDK -->
    <!-- (1) å…ˆå¼•å…¥ Firebase SDK (compat ç‰ˆ) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>

    <!-- (2) è¼‰å…¥ reCAPTCHA v3 è…³æœ¬ï¼ˆæŠŠ render= åé¢çš„ SITE_KEY æ›æˆä½ è‡ªå·±çš„ï¼‰ -->
    <script 
        src="https://www.google.com/recaptcha/api.js?render=6Lf0pfMqAAAAAPWeK67sgdduOfMbWeB5w0-0bG6G"
        async 
        defer
        onload="console.log('reCAPTCHA è…³æœ¬åŠ è¼‰æˆåŠŸ')"
        onerror="console.error('reCAPTCHA è…³æœ¬åŠ è¼‰å¤±æ•—')"
    ></script>

    <!-- (3) è¼‰å…¥ App Check å…¼å®¹ç‰ˆ (compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-check-compat.js"></script>
    <!-- (4) åˆå§‹åŒ– Firebase + å•Ÿç”¨ App Check -->


    <style>
        :root {
            --primary-color: #9D7F86;
            --secondary-color: #D8CAB8;
            --background-color: #F5EDE6;
            --text-color: #4A4A4A;
            --light-color: #FFFFFF;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --success-color: #4CAF50;
            --info-color: #2196F3;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ä¿®å¾©é ­éƒ¨å€åŸŸæ¨£å¼ä»¥åŠç®¡ç†å“¡æŒ‰éˆ•é¡¯ç¤º */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            flex: 0 0 auto;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-button {
            background-color: #4CAF50;
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .admin-button:hover {
            background-color: #45a049;
        }

        .logout-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        #userStatus {
            color: white;
            font-size: 14px;
        }

        .card {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .login-section {
            padding: 20px;
        }

        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(157, 127, 134, 0.2);
        }

        button {
            cursor: pointer;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #8a6e74;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #ffb300;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #43a047;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #1e88e5;
        }

        .logout-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
        }

        .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 600;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background-color: rgba(157, 127, 134, 0.1);
        }

        .tab:hover:not(.active) {
            background-color: #f9f9f9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        

        .report-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .report-card {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid transparent;
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .report-card.pending {
            border-left-color: var(--warning-color);
        }

        .report-card.resolved {
            border-left-color: var(--success-color);
        }

        .report-card.rejected {
            border-left-color: var(--danger-color);
        }

        .report-card h3 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-pending {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-resolved {
            background-color: var(--success-color);
            color: white;
        }

        .badge-rejected {
            background-color: var(--danger-color);
            color: white;
        }

        .badge-warning {
            background-color: #ff9800;
            color: white;
        }

        .report-detail {
            display: none;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f9f9f9;
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .info-card h3 {
            margin-top: 0;
            font-size: 16px;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #eee;
        }

        .user-info h4 {
            margin: 0;
            font-size: 16px;
        }

        .user-info p {
            margin: 5px 0 0;
            font-size: 14px;
            color: #666;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .tag {
            background: rgba(157, 127, 134, 0.1);
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 0 0 250px;
            margin-right: 10px;
        }

        .search-box input {
            width: 100%;
            padding-left: 32px;
            box-sizing: border-box;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
            z-index: 1;
        }

        .filter-select {
            min-width: 120px;
            flex: 0 1 150px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-item.active {
            background: var(--primary-color);
            color: white;
        }

        .page-item:hover:not(.active) {
            background: #e0e0e0;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .notification-badge {
            position: relative;
        }

        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* ç…§ç‰‡é©—è­‰æ¨£å¼ */
        .verification-detail {
            display: none;
        }

        .photos-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            accent-color: #4caf50;
        }

        .photo-item .index {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .selfie-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .selfie-photo {
            width: 300px;
            max-width: 100%;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        /* åº—å®¶å¯©æ ¸è©³æƒ…é é¢æ¨£å¼ */
        .business-verification-detail {
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            min-height: 500px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .business-detail-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .business-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .business-detail-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }

        .business-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .business-info-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
        }

        .business-info-card h3 {
            margin-top: 0;
            font-size: 18px;
            color: #9D7F86;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .business-info-card p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .business-license-container {
            margin: 30px 0;
        }

        .business-license-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            text-align: center;
        }

        .business-photos-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .business-photos-container .business-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px;
        }

        .business-photos-container .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            background-color: #f5f5f5;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .business-photos-container .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* æ”¹é€²åœ–ç‰‡å®¹å™¨ï¼Œç¢ºä¿åœ–ç‰‡æ­£ç¢ºé¡¯ç¤º */
        .business-photos-container .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* æˆ–ä½¿ç”¨ 'contain' ä»¥å®Œæ•´é¡¯ç¤ºåœ–ç‰‡ */
            background-color: #f0f0f0;
            transition: opacity 0.3s;
        }

        /* åœ–ç‰‡è¼‰å…¥å‹•ç•« */
        .business-photos-container .photo-item .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2;
        }

        /* åœ–ç‰‡è¼‰å…¥éŒ¯èª¤æ™‚çš„æ¨£å¼ */
        .business-photos-container .photo-item .error-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            color: #9e9e9e;
            font-size: 14px;
            text-align: center;
            padding: 15px;
        }

        .business-photos-container .photo-item .error-placeholder svg {
            margin-bottom: 10px;
            opacity: 0.7;
        }

        /* ç‡ˆç®±æŸ¥çœ‹å™¨å„ªåŒ– */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .lightbox.active img {
            transform: scale(1);
        }

        .lightbox .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .lightbox .close:hover {
            opacity: 1;
        }

        /* åœ–ç‰‡è¼‰å…¥ä¸­æ¨£å¼ */
        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .image-loading .loading-spinner {
            width: 30px;
            height: 30px;
        }

        /* å¢å¼·åœ–åƒç´¢å¼•æ¨™ç±¤ */
        .photo-item .index {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 3;
        }

        /* æ–‡ä»¶é¡å‹æ¨™ç±¤ */
        .photo-item .file-type {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 3;
        }

        /* éæ¿¾æ¬„ä½å®¹å™¨æ¨£å¼ */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* æœç´¢æ¡†æ¨£å¼ */
        .search-box {
            position: relative;
            flex: 0 0 250px; /* å›ºå®šå¯¬åº¦ä¸”ä¸æ”¶ç¸® */
            margin-right: 10px;
        }

        .search-box input {
            width: 100%;
            padding-left: 40px;
            box-sizing: border-box; /* ç¢ºä¿paddingä¸å½±éŸ¿å¯¬åº¦ */
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* éæ¿¾é¸æ“‡å™¨åˆ†çµ„ */
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            flex: 1;
            gap: 10px;
            align-items: center;
        }

        /* éæ¿¾é¸æ“‡å™¨ */
        .filter-select {
            min-width: 120px;
            max-width: 200px;
            flex: 0 1 auto;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-box {
                flex: 1 1 100%;
                margin-right: 0;
                margin-bottom: 10px;
                max-width: none;
            }
            
            .filter-group {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-select, 
            .filter-bar button {
                width: 100%;
                max-width: none;
            }
        }
    </style>
    <style>
        @font-face {
          font-family: 'Material Icons';
          font-style: normal;
          font-weight: 400;
          src: local('Material Icons'), local('MaterialIcons-Regular'),
               url('path/to/MaterialIcons-Regular.woff2') format('woff2');
        }
        
        .material-icons {
          font-family: 'Material Icons';
          font-weight: normal;
          font-style: normal;
          font-size: 24px;
          line-height: 1;
          letter-spacing: normal;
          text-transform: none;
          display: inline-block;
          white-space: nowrap;
          word-wrap: normal;
          direction: ltr;
          -webkit-font-smoothing: antialiased;
        }
        </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="logo_s.png" type="image/png">
</head>
<body>
    <div class="header">
        <h1>ç³»çµ±ç®¡ç†å¾Œå°</h1>
        <div class="header-actions">
            <span id="userStatus" style="margin-right: 15px;"></span>
            <button id="adminButton" class="admin-button" style="display: none;">ç”³è«‹ç®¡ç†å“¡æ¬Šé™</button>
            <button id="logoutButton" class="logout-button" style="display: none;">ç™»å‡º</button>
        </div>
    </div>
    <div id="adminKeyModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 500px;">
            <h3>ç”³è«‹ç®¡ç†å“¡æ¬Šé™</h3>
            <p>ç³»çµ±å°‡è‡ªå‹•æª¢æŸ¥æ‚¨çš„IPåœ°å€æ˜¯å¦æœ‰æ¬Šé™ç”³è«‹ç®¡ç†å“¡ã€‚</p>
            <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                <button id="cancelAdminKey" style="margin-right: 10px; padding: 8px 16px; border-radius: 8px; border: none; background-color: #f0f0f0; cursor: pointer;">å–æ¶ˆ</button>
                <button id="submitAdminKey" style="padding: 8px 16px; border-radius: 8px; border: none; background-color: #9D7F86; color: white; cursor: pointer;">ç¢ºèªç”³è«‹</button>
            </div>
            <div id="adminKeyError" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>

    <!-- ç®¡ç†å“¡æˆåŠŸæç¤ºæ¡†ä¿æŒä¸è®Š -->
    <div id="adminSuccessModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 500px; text-align: center;">
            <h3 style="color: #4CAF50;">æ“ä½œæˆåŠŸ</h3>
            <p>æ‚¨å·²æˆåŠŸç²å¾—ç®¡ç†å“¡æ¬Šé™ï¼</p>
            <p>ç³»çµ±å°‡åœ¨ <span id="reloadCountdown">3</span> ç§’å¾Œè‡ªå‹•é‡æ–°è¼‰å…¥é é¢ã€‚</p>
            <button id="reloadNow" style="margin-top: 15px; padding: 8px 16px; border-radius: 8px; border: none; background-color: #9D7F86; color: white; cursor: pointer;">ç«‹å³é‡æ–°è¼‰å…¥</button>
        </div>
    </div>

        <!-- ç™»å…¥å€å¡Š -->
        <div class="card login-section" id="loginSection">
            <h2>ç®¡ç†å“¡ç™»å…¥</h2>
            <div class="login-form">
                <input type="email" id="emailInput" placeholder="ç®¡ç†å“¡éƒµç®±" required>
                <input type="password" id="passwordInput" placeholder="å¯†ç¢¼" required>
                <button id="loginButton" class="btn-primary">ç™»å…¥</button>
            </div>
            <div id="errorMessage" style="color: red; margin-top: 10px; display: none;"></div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div id="main-content" style="display: none;">
            <!-- æ¨™ç±¤é  -->
            <div class="tabs">
                <div class="tab" data-tab="verification">ç…§ç‰‡é©—è­‰</div>
                <div class="tab active" data-tab="report">æª¢èˆ‰ç®¡ç†</div>
                <div class="tab" data-tab="businessApproval">åº—å®¶å¯©æ ¸</div>
                <div class="tab" data-tab="statistics">çµ±è¨ˆåˆ†æ</div>
                <div class="tab" data-tab="settings">ç³»çµ±è¨­ç½®</div>
                <div class="tab notification-badge" data-tab="frequentReports" data-count="0">é‡è¤‡æª¢èˆ‰</div>
            </div>

            <!-- ç…§ç‰‡é©—è­‰æ¨™ç±¤é  -->
            <div class="tab-content" id="verification-tab">
                <div class="card">
                    <h2>å¾…è™•ç†çš„ç…§ç‰‡é©—è­‰è«‹æ±‚</h2>
                    <div id="verification-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>è¼‰å…¥é©—è­‰è«‹æ±‚ä¸­...</span>
                    </div>
                    <div id="verification-container" class="report-list"></div>
                    <div class="pagination" id="verification-pagination"></div>
                </div>
            </div>

            <!-- æª¢èˆ‰ç®¡ç†æ¨™ç±¤é  -->
            <div class="tab-content active" id="report-tab">
                <div class="card">
                    <div class="filter-bar">
                        <div class="search-box">
                            <div class="search-box">
                                <span class="search-icon">ğŸ”</span>
                                <input type="text" id="searchInput" placeholder="æœå°‹ç”¨æˆ¶åæˆ–æª¢èˆ‰ID...">
                            </div>
                        </div>
                        <div class="filter-group">
                            <select class="filter-select" id="statusFilter">
                                <option value="all">æ‰€æœ‰ç‹€æ…‹</option>
                                <option value="pending" selected>å¾…è™•ç†</option>
                                <option value="resolved">å·²è™•ç†</option>
                                <option value="rejected">å·²æ‹’çµ•</option>
                            </select>
                            <select class="filter-select" id="typeFilter">
                                <option value="all">æ‰€æœ‰é¡å‹</option>
                                <option value="harassment">é¨·æ“¾è¡Œç‚º</option>
                                <option value="inappropriate">ä¸ç•¶å…§å®¹</option>
                                <option value="scam">è©é¨™/é‡£é­š</option>
                                <option value="fake">å†’å……ä»–äºº</option>
                                <option value="spam">å»£å‘Š/åƒåœ¾è¨Šæ¯</option>
                                <option value="hate">ä»‡æ¨è¨€è«–</option>
                                <option value="violence">æš´åŠ›/å¨è„…è¡Œç‚º</option>
                                <option value="other">å…¶ä»–é•è¦</option>
                            </select>
                            <select class="filter-select" id="sortBy">
                                <option value="newest">æœ€æ–°å„ªå…ˆ</option>
                                <option value="oldest">æœ€èˆŠå„ªå…ˆ</option>
                                <option value="severity">åš´é‡åº¦</option>
                            </select>
                            <button class="btn-primary" id="applyFilters">æ‡‰ç”¨éæ¿¾</button>
                        </div>
                    </div>
                </div>

                <div id="reports-loading" class="loading">
                    <div class="loading-spinner"></div>
                    <span>è¼‰å…¥æª¢èˆ‰è³‡æ–™ä¸­...</span>
                </div>
                <div id="reports-container" class="report-list"></div>
                <div class="pagination" id="reports-pagination"></div>
            </div>

            <!-- åº—å®¶å¯©æ ¸æ¨™ç±¤é  -->
            <div class="tab-content" id="businessApproval-tab">
                <div class="card">
                    <h2>å¾…è™•ç†çš„åº—å®¶å¯©æ ¸è«‹æ±‚</h2>
                    <div id="business-approval-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>è¼‰å…¥å¯©æ ¸è«‹æ±‚ä¸­...</span>
                    </div>
                    <div id="business-approval-container" class="report-list"></div>
                    <div class="pagination" id="business-approval-pagination"></div>
                </div>
            </div>
          

            <!-- çµ±è¨ˆåˆ†ææ¨™ç±¤é  -->
            <div class="tab-content" id="statistics-tab">
                <div class="card">
                    <h2>æª¢èˆ‰çµ±è¨ˆ</h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>æª¢èˆ‰ä¿¡ç”¨åˆ†æ•¸åˆ†å¸ƒ</h3>
                            <div>
                              <p><strong>é«˜ä¿¡ç”¨åˆ†æ•¸ (â‰¥80):</strong> <span id="high-credit-count">0</span></p>
                              <p><strong>ä¸­ä¿¡ç”¨åˆ†æ•¸ (50-79):</strong> <span id="medium-credit-count">0</span></p>
                              <p><strong>ä½ä¿¡ç”¨åˆ†æ•¸ (<50):</strong> <span id="low-credit-count">0</span></p>
                            </div>
                          </div>
                          
                          <div class="info-card">
                            <h3>æœ€æ´»èºæª¢èˆ‰äºº</h3>
                            <ul id="most-active-reporters"></ul>
                          </div>
                          
                          <div class="info-card">
                            <h3>æœ€ä½ä¿¡ç”¨åˆ†æ•¸ç”¨æˆ¶</h3>
                            <ul id="lowest-credit-users"></ul>
                          </div>
                        <div class="info-card">
                            <h3>æª¢èˆ‰æ¦‚æ³</h3>
                            <div>
                                <p><strong>ç¸½æª¢èˆ‰æ•¸:</strong> <span id="total-reports">0</span></p>
                                <p><strong>è™•ç†ä¸­:</strong> <span id="pending-reports">0</span></p>
                                <p><strong>å·²è§£æ±º:</strong> <span id="resolved-reports">0</span></p>
                                <p><strong>å·²æ‹’çµ•:</strong> <span id="rejected-reports">0</span></p>
                            </div>
                        </div>
                        <div class="info-card">
                            <h3>æª¢èˆ‰é¡å‹åˆ†å¸ƒ</h3>
                            <ul id="report-types-stats"></ul>
                        </div>
                        <div class="info-card">
                            <h3>æª¢èˆ‰è™•ç†æ™‚é–“</h3>
                            <p><strong>å¹³å‡è™•ç†æ™‚é–“:</strong> <span id="avg-handle-time">0</span> å°æ™‚</p>
                            <p><strong>æœ¬é€±è™•ç†é‡:</strong> <span id="weekly-handled">0</span></p>
                        </div>
                        <div class="info-card">
                            <h3>æœ€å¸¸è¢«æª¢èˆ‰ç”¨æˆ¶</h3>
                            <ul id="most-reported-users"></ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>ç…§ç‰‡é©—è­‰çµ±è¨ˆ</h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>é©—è­‰æ¦‚æ³</h3>
                            <div>
                                <p><strong>ç¸½é©—è­‰è«‹æ±‚:</strong> <span id="total-verifications">0</span></p>
                                <p><strong>å¾…è™•ç†:</strong> <span id="pending-verifications">0</span></p>
                                <p><strong>å·²é€šé:</strong> <span id="approved-verifications">0</span></p>
                                <p><strong>å·²æ‹’çµ•:</strong> <span id="rejected-verifications">0</span></p>
                            </div>
                        </div>
                        <div class="info-card">
                            <h3>é©—è­‰è™•ç†æ™‚é–“</h3>
                            <p><strong>å¹³å‡è™•ç†æ™‚é–“:</strong> <span id="avg-verification-time">0</span> å°æ™‚</p>
                            <p><strong>æœ¬é€±è™•ç†é‡:</strong> <span id="weekly-verifications">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç³»çµ±è¨­ç½®æ¨™ç±¤é  -->
            <div class="tab-content" id="settings-tab">
                <div class="card">
                    <h2>ç³»çµ±è¨­ç½®</h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>æª¢èˆ‰è™•ç†è¦å‰‡</h3>
                            <form id="reportRulesForm">
                                <div>
                                    <label for="multipleReportThreshold">å¤šæ¬¡æª¢èˆ‰é–¾å€¼:</label>
                                    <input type="number" id="multipleReportThreshold" min="2" max="10" value="3">
                                    <p class="description">ç•¶ç”¨æˆ¶è¢«æª¢èˆ‰é”åˆ°æ­¤æ¬¡æ•¸æ™‚ç«‹å³é€²è¡Œè™•ç†</p>
                                </div>
                                <div>
                                    <label for="falseReportPenalty">è™›å‡æª¢èˆ‰æ‡²ç½°:</label>
                                    <select id="falseReportPenalty">
                                        <option value="none">ç„¡</option>
                                        <option value="warning">è­¦å‘Š</option>
                                        <option value="limit" selected>é™åˆ¶æª¢èˆ‰åŠŸèƒ½</option>
                                        <option value="ban">æš«æ™‚ç¦ç”¨</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="defaultPunishDays">é è¨­æ‡²ç½°å¤©æ•¸:</label>
                                    <input type="number" id="defaultPunishDays" min="1" max="90" value="7">
                                </div>
                                <button type="submit" class="btn-primary">ä¿å­˜è¨­ç½®</button>
                            </form>
                        </div>
                        
                        <div class="info-card">
                            <h3>é©—è­‰è¨­ç½®</h3>
                            <form id="verificationSettingsForm">
                                <div>
                                    <label for="autoApproveVerification">
                                        <input type="checkbox" id="autoApproveVerification">
                                        å•Ÿç”¨è‡ªå‹•é©—è­‰é€šé (AIè¼”åŠ©)
                                    </label>
                                </div>
                                <div>
                                    <label for="verificationExpireDays">é©—è­‰éæœŸå¤©æ•¸:</label>
                                    <input type="number" id="verificationExpireDays" min="1" max="90" value="30">
                                    <p class="description">é€šéé©—è­‰å¾Œå¤šå°‘å¤©éœ€è¦é‡æ–°é©—è­‰</p>
                                </div>
                                <div>
                                    <label for="requiredPhotoCount">æœ€å°‘éœ€é©—è­‰ç…§ç‰‡æ•¸:</label>
                                    <input type="number" id="requiredPhotoCount" min="1" max="6" value="1">
                                </div>
                                <button type="submit" class="btn-primary">ä¿å­˜è¨­ç½®</button>
                            </form>
                        </div>
                        
                        <div class="info-card">
                            <h3>è‡ªå‹•åŒ–æµç¨‹</h3>
                            <form id="automationForm">
                                <div>
                                    <label>
                                        <input type="checkbox" id="autoRejectFalseReports" checked>
                                        è‡ªå‹•æ‹’çµ•è™›å‡æª¢èˆ‰
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        <input type="checkbox" id="autoNotifyUser" checked>
                                        è‡ªå‹•é€šçŸ¥è¢«æª¢èˆ‰ç”¨æˆ¶
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        <input type="checkbox" id="prioritizeMultipleReports" checked>
                                        å¤šäººæª¢èˆ‰å„ªå…ˆè™•ç†
                                    </label>
                                </div>
                                <button type="submit" class="btn-primary">ä¿å­˜è¨­ç½®</button>
                            </form>
                        </div>
                        
                        <div class="info-card">
                            <h3>è¨Šæ¯æ¨¡æ¿</h3>
                            <form id="messageTemplateForm">
                                <div>
                                    <label for="warningTemplate">è­¦å‘Šæ¨¡æ¿:</label>
                                    <textarea id="warningTemplate" rows="4">è¦ªæ„›çš„ç”¨æˆ¶ï¼Œæ‚¨å› {reason}è¢«æª¢èˆ‰ï¼Œæˆ‘å€‘æé†’æ‚¨éµå®ˆç¤¾å€è¦ç¯„ã€‚é‡è¤‡é•è¦å¯èƒ½å°è‡´å¸³è™Ÿé™åˆ¶æˆ–æš«åœã€‚</textarea>
                                </div>
                                <div>
                                    <label for="suspensionTemplate">å¸³è™Ÿæš«åœæ¨¡æ¿:</label>
                                    <textarea id="suspensionTemplate" rows="4">è¦ªæ„›çš„ç”¨æˆ¶ï¼Œæ‚¨å› {reason}çš„è¡Œç‚ºï¼Œå¸³è™Ÿå·²è¢«æš«åœä½¿ç”¨{days}å¤©ã€‚å¦‚æœ‰ç–‘å•è«‹è¯ç¹«å®¢æœã€‚</textarea>
                                </div>
                                <button type="submit" class="btn-primary">ä¿å­˜æ¨¡æ¿</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‡è¤‡æª¢èˆ‰æ¨™ç±¤é  -->
            <div class="tab-content" id="frequentReports-tab">
                <div class="card">
                    <h2>é‡è¤‡è¢«æª¢èˆ‰ç”¨æˆ¶</h2>
                    <p>ä»¥ä¸‹ç”¨æˆ¶åœ¨çŸ­æ™‚é–“å…§è¢«æª¢èˆ‰å¤šæ¬¡ï¼Œå¯èƒ½éœ€è¦å„ªå…ˆè™•ç†</p>
                    <div id="frequent-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>è¼‰å…¥æ•¸æ“šä¸­...</span>
                    </div>
                    <div id="frequent-reports-container" class="report-list"></div>
                </div>
            </div>
        </div>


        <!-- æª¢èˆ‰è©³æƒ…é é¢ -->
        <div id="report-detail" class="report-detail">
            <div class="card">
                <div class="detail-header">
                    <h2>æª¢èˆ‰è©³æƒ…</h2>
                    <button id="backToList" class="btn-info">è¿”å›åˆ—è¡¨</button>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>æª¢èˆ‰è³‡è¨Š</h3>
                        <p><strong>æª¢èˆ‰ID:</strong> <span id="report-id"></span></p>
                        <p><strong>æäº¤æ™‚é–“:</strong> <span id="report-time"></span></p>
                        <p><strong>ç‹€æ…‹:</strong> <span id="report-status"></span></p>
                        <p><strong>è™•ç†äººå“¡:</strong> <span id="report-handler">å°šæœªè™•ç†</span></p>
                    </div>
                    
                    <div class="info-card">
                        <h3>æª¢èˆ‰äººè³‡æ–™</h3>
                        <div class="user-profile">
                            <img id="reporter-avatar" class="avatar" src="https://placehold.co/60" alt="æª¢èˆ‰äººé ­åƒ">
                            <div class="user-info">
                                <h4 id="reporter-name">æª¢èˆ‰äººå§“å</h4>
                                <p id="reporter-id">ID: ABC123</p>
                                <!-- æ–°å¢ï¼šæª¢èˆ‰ä¿¡ç”¨åˆ†æ•¸ -->
                                <div>
                                    <span id="reporter-credit" class="credit-score">ä¿¡ç”¨åˆ†æ•¸: 100</span>
                                    <span class="credit-tooltip">
                                        <i class="material-icons" style="font-size: 16px;">info</i>
                                        <span class="tooltip-text">ä¿¡ç”¨åˆ†æ•¸æ ¹æ“šæª¢èˆ‰æœ‰æ•ˆæ€§è¨ˆç®—ï¼Œå½±éŸ¿æª¢èˆ‰å¯ä¿¡åº¦</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p><strong>æª¢èˆ‰æ­·å²:</strong> <span id="reporter-history">3æ¬¡ (2æ¬¡æœ‰æ•ˆ)</span></p>
                        <p><strong>å¸³æˆ¶ç‹€æ…‹:</strong> <span id="reporter-status">æ­£å¸¸</span></p>
                    </div>
                    
                    <div class="info-card">
                        <h3>è¢«æª¢èˆ‰äººè³‡æ–™</h3>
                        <div class="user-profile">
                            <img id="reported-avatar" class="avatar" src="https://via.placeholder.com/60" alt="è¢«æª¢èˆ‰äººé ­åƒ">
                            <div class="user-info">
                                <h4 id="reported-name">è¢«æª¢èˆ‰äººå§“å</h4>
                                <p id="reported-id">ID: XYZ789</p>
                            </div>
                        </div>
                        <p><strong>è¢«æª¢èˆ‰æ­·å²:</strong> <span id="reported-history">1æ¬¡ (0æ¬¡æˆç«‹)</span></p>
                        <p><strong>å¸³æˆ¶ç‹€æ…‹:</strong> <span id="reported-status">æ­£å¸¸</span></p>
                        <!-- æ–°å¢ï¼šé¡¯ç¤ºä¹‹å‰çš„è™•ç½°è¨˜éŒ„ -->
                        <div id="previous-punishments">
                            <p><strong>è™•ç½°è¨˜éŒ„:</strong></p>
                            <ul id="punishment-history"></ul>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>æª¢èˆ‰åŸå› </h3>
                    <ul class="reasons-list" id="report-reasons">
                        <!-- æª¢èˆ‰åŸå› å°‡å‹•æ…‹è¼‰å…¥ -->
                    </ul>
                    <div style="margin-top: 15px;">
                        <p><strong>è©³ç´°æè¿°:</strong></p>
                        <p id="report-detail-text"></p>
                    </div>
                </div>
                
                <div class="evidence-container">
                    <h3>æª¢èˆ‰è­‰æ“š</h3>
                    <div class="evidence-grid" id="evidence-container">
                        <!-- è­‰æ“šåœ–ç‰‡å°‡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
                
                <div class="action-panel">
                    <h3>è™•ç†æ±ºå®š</h3>
                    
                    <div class="punishment-options">
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="ignore" checked>
                                æ‹’çµ•æª¢èˆ‰ (ç„¡é•è¦è¡Œç‚º)
                            </label>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="warning">
                                ç™¼å‡ºè­¦å‘Š
                            </label>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="restrict">
                                åŠŸèƒ½é™åˆ¶
                            </label>
                            <div style="margin-left: 25px; margin-top: 10px;">
                                <select id="restrictType">
                                    <option value="chat">èŠå¤©åŠŸèƒ½</option>
                                    <option value="match">é…å°åŠŸèƒ½</option>
                                    <option value="photo">ä¸Šå‚³ç…§ç‰‡</option>
                                    <option value="all">æ‰€æœ‰åŠŸèƒ½</option>
                                </select>
                                <input type="number" id="restrictDays" min="1" max="30" value="7" style="width: 60px; margin-left: 10px;"> å¤©
                            </div>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="suspend">
                                æš«åœå¸³è™Ÿ
                            </label>
                            <div style="margin-left: 25px; margin-top: 10px;">
                                <input type="number" id="suspendDays" min="1" max="90" value="30" style="width: 60px;"> å¤©
                            </div>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="ban">
                                æ°¸ä¹…å°ç¦
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label for="actionNote">è™•ç†å‚™è¨» (åƒ…ç®¡ç†å“¡å¯è¦‹):</label>
                        <textarea id="actionNote" rows="3" style="width: 100%; margin-top: 10px;"></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="submitAction" class="btn-success">ç¢ºèªè™•ç†</button>
                        <button id="cancelAction" class="btn-danger">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº—å®¶å¯©æ ¸è©³æƒ…é é¢ -->
        <div id="business-approval-detail" class="business-verification-detail" style="display: none;">
            <div class="business-detail-card">
                <div class="business-detail-header">
                    <h2>åº—å®¶å¯©æ ¸è©³æƒ…</h2>
                    <button id="business-approval-back" class="btn-info">è¿”å›åˆ—è¡¨</button>
                </div>
                
                <input type="hidden" id="business-approval-requestid">
                
                <div class="business-info-grid">
                    <div class="business-info-card">
                        <h3>åŸºæœ¬è³‡è¨Š</h3>
                        <p><strong>åº—å®¶åç¨±:</strong> <span id="business-name">æœªçŸ¥åº—å®¶</span></p>
                        <p><strong>ç”¨æˆ¶ID:</strong> <span id="business-userid">æœªçŸ¥</span></p>
                        <p><strong>åº—å®¶é¡å‹:</strong> <span id="business-type">æœªçŸ¥</span></p>
                        <p><strong>æäº¤æ™‚é–“:</strong> <span id="business-time">æœªçŸ¥</span></p>
                    </div>
                    
                    <div class="business-info-card">
                        <h3>è¯çµ¡è³‡è¨Š</h3>
                        <p><strong>åº—å®¶åœ°å€:</strong> <span id="business-address">æœªçŸ¥</span></p>
                        <p><strong>åº—å®¶é›»è©±:</strong> <span id="business-phone">æœªçŸ¥</span></p>
                        <p><strong>è¯çµ¡äººå§“å:</strong> <span id="business-contact-name">æœªçŸ¥</span></p>
                        <p><strong>è¯çµ¡äººé›»è©±:</strong> <span id="business-contact-phone">æœªçŸ¥</span></p>
                    </div>
                </div>
                
                <div class="business-license-container">
                    <h3>ç‡Ÿæ¥­åŸ·ç…§/å•†æ¥­è­‰æ˜</h3>
                    <div id="business-licenses" class="business-photos-container">
                        <!-- è­‰ç…§ç…§ç‰‡å°‡åœ¨é€™è£¡å‹•æ…‹åŠ è¼‰ -->
                        <div class="business-loading">
                            <div class="loading-spinner"></div>
                            <span>è¼‰å…¥è­‰æ˜æ–‡ä»¶ä¸­...</span>
                        </div>
                    </div>
                </div>
                
                <div class="business-rejection-section">
                    <h3>å¯©æ ¸çµæœ</h3>
                    <div class="form-group">
                        <label for="reject-reason">æ‹’çµ•åŸå›  (åƒ…åœ¨æ‹’çµ•æ™‚éœ€å¡«å¯«):</label>
                        <textarea id="reject-reason" class="form-control" rows="3" placeholder="è«‹å¡«å¯«æ‹’çµ•åŸå› ï¼Œå°‡é€šçŸ¥åº—å®¶é€²è¡Œä¿®æ­£..."></textarea>
                    </div>
                </div>
                
                <div class="business-button-group">
                    <button id="business-approve" class="btn-success">æ ¸å‡†åº—å®¶</button>
                    <button id="business-reject" class="btn-danger">æ‹’çµ•å¯©æ ¸</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å…¨å±åœ–ç‰‡æŸ¥çœ‹ -->
    <div class="lightbox" id="imageLightbox">
        <span class="close material-icons">close</span>
        <img id="lightboxImage" src="">
    </div>
    <script src="admin-manager.js"></script>
    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDslE4rgN8ZiUam3MCT_bJiSfusUxZS-wU",
            authDomain: "test1-b1d68.firebaseapp.com",
            databaseURL: "https://test1-b1d68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "test1-b1d68",
            storageBucket: "test1-b1d68.appspot.com",
            messagingSenderId: "1010412789448",
            appId: "1:1010412789448:web:2843afa459b3644d118ffd",
            measurementId: "G-X7RQ8DRZ7P"
        };

        // ç¢ºä¿ reCAPTCHA å·²åŠ è¼‰
        function waitForRecaptcha(callback) {
            if (typeof grecaptcha !== 'undefined' && typeof grecaptcha.ready === 'function') {
                console.log('reCAPTCHA å·²æº–å‚™å¥½');
                grecaptcha.ready(() => {
                    console.log('reCAPTCHA å·²è¼‰å…¥å®Œæˆ');
                    callback();
                });
            } else {
                console.log('ç­‰å¾… reCAPTCHA åŠ è¼‰...');
                setTimeout(() => waitForRecaptcha(callback), 200); // ç¨å¾®å¢åŠ å»¶é²æ™‚é–“
            }
        }

        // åœ¨é é¢åŠ è¼‰å®Œæˆå¾Œç­‰å¾… reCAPTCHA ä¸¦åˆå§‹åŒ– Firebase
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMå·²åŠ è¼‰ï¼Œç­‰å¾…reCAPTCHA...');
            waitForRecaptcha(initializeFirebaseWithAppCheck);
        });

        // åˆå§‹åŒ– Firebase å’Œ App Check
        function initializeFirebaseWithAppCheck() {
            console.log('é–‹å§‹åˆå§‹åŒ– Firebase å’Œ App Check');
            
            try {
                // å¦‚æœå°šæœªåˆå§‹åŒ– Firebaseï¼ŒåŸ·è¡Œåˆå§‹åŒ–
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('Firebase æˆåŠŸåˆå§‹åŒ–');
                } else {
                    console.log('Firebase å·²ç¶“åˆå§‹åŒ–éäº†');
                }

                // ç²å– Firestore / Auth / Storage ç­‰æœå‹™
                window.db = firebase.firestore();
                window.auth = firebase.auth();
                window.storage = firebase.storage();
                
                // å˜—è©¦å•Ÿç”¨ App Check
                try {
                    // åƒ…åœ¨é–‹ç™¼ç’°å¢ƒä½¿ç”¨ debug token
                    if (window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' || 
                        window.location.hostname.includes('192.168.')) {
                        console.log('é–‹ç™¼ç’°å¢ƒä¸­å•Ÿç”¨ debug token');
                        self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;
                    }
                    
                    var appCheck = firebase.appCheck();
                    appCheck.activate('6Lf0pfMqAAAAAPWeK67sgdduOfMbWeB5w0-0bG6G', {
                        isTokenAutoRefreshEnabled: true
                    });
                    
                    console.log('App Check åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('App Check åˆå§‹åŒ–å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ:', error);
                }
                
                console.log('Firebase å’Œ App Check åˆå§‹åŒ–å®Œæˆ');
                
                // è¨­ç½®ä¸€æ¬¡æ€§çš„èªè­‰ç‹€æ…‹ç›£è½å™¨
                setupAuthStateListener();
                
                // è§¸ç™¼é é¢åˆå§‹åŒ–
                initializePage();
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                alert('ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–è¯çµ¡ç®¡ç†å“¡');
            }
        }

        function setupAuthStateListener() {
            console.log('è¨­ç½®èªè­‰ç‹€æ…‹ç›£è½å™¨');
            
            let isProcessingAuthChange = false;
            
            auth.onAuthStateChanged(user => {
                if (isProcessingAuthChange) {
                    console.log('æ­£åœ¨è™•ç†èªè­‰ç‹€æ…‹è®Šæ›´ï¼Œå¿½ç•¥é‡è¤‡äº‹ä»¶');
                    return;
                }
                
                isProcessingAuthChange = true;
                console.log(`èªè­‰ç‹€æ…‹è®Šæ›´: ${user ? 'å·²ç™»å…¥ ' + user.email : 'å·²ç™»å‡º'}`);
                
                try {
                    if (user) {
                        onLoginSuccess(user);
                    } else {
                        onLogout();
                    }
                } catch (error) {
                    console.error('è™•ç†èªè­‰ç‹€æ…‹è®Šæ›´æ™‚å‡ºéŒ¯:', error);
                }
                
                // å»¶é²é‡ç½®è™•ç†æ¨™è¨˜ï¼Œé¿å…è™•ç†å¤šæ¬¡å¿«é€Ÿè§¸ç™¼çš„äº‹ä»¶
                setTimeout(() => {
                    isProcessingAuthChange = false;
                }, 500);
            });
        }


        // DOM å…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const userStatus = document.getElementById('userStatus');
        const errorMessage = document.getElementById('errorMessage');
        const mainContent = document.getElementById('main-content');
        const reportsContainer = document.getElementById('reports-container');
        const reportDetail = document.getElementById('report-detail');
        const backToListBtn = document.getElementById('backToList');
        
        // å…¨å±€è®Šæ•¸
        let currentReportId = null;
        let currentPage = 1;
        let reportsPerPage = 12;
        let totalReports = 0;
        let isProcessingAuthChange = false;
        
        // åˆå§‹åŒ–é é¢
        function initializePage() {
            console.log('é–‹å§‹åˆå§‹åŒ–é é¢');
            
            // æª¢æŸ¥DOMå…ƒç´ æ˜¯å¦æ­£ç¢ºç²å–
            if (!loginSection) console.error('ç„¡æ³•æ‰¾åˆ°loginSectionå…ƒç´ ');
            if (!mainContent) console.error('ç„¡æ³•æ‰¾åˆ°mainContentå…ƒç´ ');
            if (!logoutButton) console.error('ç„¡æ³•æ‰¾åˆ°logoutButtonå…ƒç´ ');
            if (!userStatus) console.error('ç„¡æ³•æ‰¾åˆ°userStatuså…ƒç´ ');
            
            // ç™»å…¥æŒ‰éˆ•äº‹ä»¶
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);
                console.log('å·²ç¶å®šç™»å…¥æŒ‰éˆ•äº‹ä»¶');
            }
            
            // ç™»å‡ºæŒ‰éˆ•äº‹ä»¶
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
                console.log('å·²ç¶å®šç™»å‡ºæŒ‰éˆ•äº‹ä»¶');
            }
            
            // è¿”å›åˆ—è¡¨æŒ‰éˆ•äº‹ä»¶
            if (backToListBtn) {
                backToListBtn.addEventListener('click', function() {
                    reportDetail.style.display = 'none';
                    mainContent.style.display = 'block';
                });
                console.log('å·²ç¶å®šè¿”å›åˆ—è¡¨æŒ‰éˆ•äº‹ä»¶');
            }
            
            // æ¨™ç±¤é åˆ‡æ›äº‹ä»¶
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // åˆ‡æ›æ¨™ç±¤é æ¨£å¼
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // åˆ‡æ›å…§å®¹å€
                    const tabContents = document.querySelectorAll('.tab-content');
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    const targetContent = document.getElementById(`${tabId}-tab`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // æ ¹æ“šæ¨™ç±¤é åŠ è¼‰ç›¸æ‡‰æ•¸æ“š
                        if (tabId === 'statistics') {
                            loadStatistics();
                        } else if (tabId === 'history') {
                            loadHistory();
                        } else if (tabId === 'frequentReports') {
                            loadFrequentReports();
                        } else if (tabId === 'verification') {
                            loadVerificationRequests();
                        } else if (tabId === 'report') {
                            loadReports();
                        } else if (tabId === 'businessApproval') {
                            loadBusinessApprovalRequests();
                        }
                    } else {
                        console.error(`æ‰¾ä¸åˆ°æ¨™ç±¤é å…§å®¹å…ƒç´ : ${tabId}-tab`);
                    }
                });
            });
            console.log('å·²ç¶å®šæ¨™ç±¤é åˆ‡æ›äº‹ä»¶');
            
            // æ‡‰ç”¨éæ¿¾æŒ‰éˆ•äº‹ä»¶
            const applyFiltersBtn = document.getElementById('applyFilters');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', function() {
                    currentPage = 1;
                    loadReports();
                });
                console.log('å·²ç¶å®šæ‡‰ç”¨éæ¿¾æŒ‰éˆ•äº‹ä»¶');
            }
            
            // æäº¤è™•ç†æŒ‰éˆ•äº‹ä»¶
            const submitActionBtn = document.getElementById('submitAction');
            if (submitActionBtn) {
                submitActionBtn.addEventListener('click', handleReportAction);
                console.log('å·²ç¶å®šæäº¤è™•ç†æŒ‰éˆ•äº‹ä»¶');
            }
            
            // å–æ¶ˆè™•ç†æŒ‰éˆ•äº‹ä»¶
            const cancelActionBtn = document.getElementById('cancelAction');
            if (cancelActionBtn) {
                cancelActionBtn.addEventListener('click', function() {
                    reportDetail.style.display = 'none';
                    mainContent.style.display = 'block';
                });
                console.log('å·²ç¶å®šå–æ¶ˆè™•ç†æŒ‰éˆ•äº‹ä»¶');
            }
            
            // è¨­ç½®è¡¨å–®æäº¤äº‹ä»¶
            const reportRulesForm = document.getElementById('reportRulesForm');
            if (reportRulesForm) {
                reportRulesForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings('reportRules');
                });
                console.log('å·²ç¶å®šå ±å‘Šè¦å‰‡è¡¨å–®æäº¤äº‹ä»¶');
            }
            
            const automationForm = document.getElementById('automationForm');
            if (automationForm) {
                automationForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings('automation');
                });
                console.log('å·²ç¶å®šè‡ªå‹•åŒ–è¡¨å–®æäº¤äº‹ä»¶');
            }
            
            const messageTemplateForm = document.getElementById('messageTemplateForm');
            if (messageTemplateForm) {
                messageTemplateForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings('messageTemplates');
                });
                console.log('å·²ç¶å®šæ¶ˆæ¯æ¨¡æ¿è¡¨å–®æäº¤äº‹ä»¶');
            }
            
            // åœ–ç‰‡æŸ¥çœ‹äº‹ä»¶
            const lightboxClose = document.querySelector('.lightbox .close');
            if (lightboxClose) {
                lightboxClose.addEventListener('click', function() {
                    document.getElementById('imageLightbox').style.display = 'none';
                });
                console.log('å·²ç¶å®šç‡ˆç®±é—œé–‰äº‹ä»¶');
            }

            // è¨­ç½®Enteréµç™»å…¥
            if (passwordInput) {
                passwordInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        handleLogin();
                    }
                });
                console.log('å·²è¨­ç½®Enteréµç™»å…¥');
            }

            // æ·»åŠ åº—å®¶å¯©æ ¸æ¨™ç±¤é é»æ“Šè™•ç†
            const businessApprovalTab = document.querySelector('.tab[data-tab="businessApproval"]');
            if (businessApprovalTab) {
                businessApprovalTab.addEventListener('click', function() {
                    loadBusinessApprovalRequests();
                });
                console.log('å·²è¨­ç½®åº—å®¶å¯©æ ¸æ¨™ç±¤é é»æ“Šäº‹ä»¶');
            }
            
            // åˆå§‹åŒ–ç®¡ç†å“¡ç”³è«‹æŒ‰éˆ•
            initAdminButtons();
            
            console.log('é é¢åˆå§‹åŒ–å®Œæˆ');
        }

        // åˆå§‹åŒ–ç®¡ç†å“¡ç”³è«‹æŒ‰éˆ•
        function initAdminButtons() {
            console.log('åˆå§‹åŒ–ç®¡ç†å“¡ç”³è«‹æŒ‰éˆ•');
            
            const adminButton = document.getElementById('adminButton');
            const adminKeyModal = document.getElementById('adminKeyModal');
            const cancelAdminKey = document.getElementById('cancelAdminKey');
            const submitAdminKey = document.getElementById('submitAdminKey');
            
            if (adminButton && adminKeyModal) {
                adminButton.addEventListener('click', function() {
                    console.log('é»æ“Šç®¡ç†å“¡ç”³è«‹æŒ‰éˆ•');
                    adminKeyModal.style.display = 'block';
                });
                
                if (cancelAdminKey) {
                    cancelAdminKey.addEventListener('click', function() {
                        adminKeyModal.style.display = 'none';
                    });
                }
                
                if (submitAdminKey) {
                    submitAdminKey.addEventListener('click', function() {
                        applyForAdmin();
                    });
                }
                
                console.log('ç®¡ç†å“¡ç”³è«‹æŒ‰éˆ•åˆå§‹åŒ–å®Œæˆ');
            } else {
                console.log('æ‰¾ä¸åˆ°ç®¡ç†å“¡ç”³è«‹æŒ‰éˆ•æˆ–å°è©±æ¡†');
            }
        }

        // ç®¡ç†å“¡ç”³è«‹åŠŸèƒ½
        async function applyForAdmin() {
            const adminKeyError = document.getElementById('adminKeyError');
            const submitAdminKey = document.getElementById('submitAdminKey');
            
            try {
                if (!auth.currentUser) {
                    throw new Error('è«‹å…ˆç™»å…¥');
                }
                
                // é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
                submitAdminKey.disabled = true;
                submitAdminKey.innerHTML = '<div class="loading-spinner"></div> è™•ç†ä¸­...';
                
                if (adminKeyError) adminKeyError.style.display = 'none';
                
                console.log('å˜—è©¦ç”³è«‹ç®¡ç†å“¡æ¬Šé™');
                
                // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æœ‰ç®¡ç†å“¡æ¬Šé™
                const adminDoc = await db.collection('admins').doc(auth.currentUser.uid).get();
                if (adminDoc.exists) {
                    throw new Error('æ‚¨å·²å…·æœ‰ç®¡ç†å“¡æ¬Šé™');
                }
                
                // å‰µå»ºç®¡ç†å“¡è«‹æ±‚
                await db.collection('adminRequests').add({
                    userId: auth.currentUser.uid,
                    email: auth.currentUser.email,
                    status: 'pending',
                    ipAddress: 'è‡ªå‹•æª¢æ¸¬', // å¯¦éš›æ‡‰ç”¨ä¸­å¯ä½¿ç”¨å‡½æ•¸ç²å–
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // é¡¯ç¤ºæˆåŠŸæç¤º
                document.getElementById('adminKeyModal').style.display = 'none';
                const adminSuccessModal = document.getElementById('adminSuccessModal');
                if (adminSuccessModal) {
                    adminSuccessModal.style.display = 'block';
                    
                    // è‡ªå‹•é‡è¼‰å€’è¨ˆæ™‚
                    let countdown = 3;
                    const countdownElem = document.getElementById('reloadCountdown');
                    if (countdownElem) {
                        const timer = setInterval(() => {
                            countdown--;
                            countdownElem.textContent = countdown;
                            if (countdown <= 0) {
                                clearInterval(timer);
                                window.location.reload();
                            }
                        }, 1000);
                    }
                    
                    // ç«‹å³é‡è¼‰æŒ‰éˆ•
                    const reloadNow = document.getElementById('reloadNow');
                    if (reloadNow) {
                        reloadNow.addEventListener('click', () => {
                            window.location.reload();
                        });
                    }
                } else {
                    alert('ç”³è«‹æˆåŠŸï¼è«‹ç­‰å¾…å¯©æ ¸ã€‚');
                    window.location.reload();
                }
                
            } catch (error) {
                console.error('ç”³è«‹ç®¡ç†å“¡æ¬Šé™å¤±æ•—:', error);
                
                if (adminKeyError) {
                    adminKeyError.textContent = error.message;
                    adminKeyError.style.display = 'block';
                } else {
                    alert('ç”³è«‹å¤±æ•—: ' + error.message);
                }
                
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                if (submitAdminKey) {
                    submitAdminKey.disabled = false;
                    submitAdminKey.textContent = 'ç¢ºèªç”³è«‹';
                }
            }
        }

        
        // è™•ç†ç™»å…¥
        async function handleLogin() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            if (!email || !password) {
                showError('è«‹å¡«å¯«éƒµç®±å’Œå¯†ç¢¼');
                return;
            }
            
            try {
                // é¡¯ç¤ºç™»å…¥ä¸­ç‹€æ…‹
                loginButton.innerHTML = '<div class="loading-spinner"></div> ç™»å…¥ä¸­...';
                loginButton.disabled = true;
                errorMessage.style.display = 'none';
                
                console.log('å˜—è©¦ç™»å…¥:', email);
                
                // è¨­ç½®èªè­‰æŒä¹…æ€§
                try {
                    await firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    console.log('æˆåŠŸè¨­ç½®èªè­‰æŒä¹…æ€§ç‚º LOCAL');
                } catch (persistenceError) {
                    console.error('è¨­ç½®èªè­‰æŒä¹…æ€§å¤±æ•—:', persistenceError);
                    // ç¹¼çºŒå˜—è©¦ç™»å…¥ï¼ŒæŒä¹…æ€§éŒ¯èª¤ä¸ä¸€å®šæœƒé˜»æ­¢ç™»å…¥æµç¨‹
                }
                
                // å˜—è©¦ç™»å…¥
                console.log('é–‹å§‹åŸ·è¡Œç™»å…¥...');
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('ç™»å…¥æˆåŠŸ:', userCredential.user.email);
                
                // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè™•ç†å…¶é¤˜çš„æ“ä½œ
                // æ­¤è™•å¯ä»¥æ¸…é™¤è¼¸å…¥å­—æ®µ
                emailInput.value = '';
                passwordInput.value = '';
                
            } catch (error) {
                console.error('ç™»å…¥éŒ¯èª¤:', error);
                showError(getErrorMessage(error));
                
                // å³ä½¿å‡ºéŒ¯ï¼Œä¹Ÿè¦é‡ç½®ç™»å…¥æŒ‰éˆ•ç‹€æ…‹
                loginButton.textContent = 'ç™»å…¥';
                loginButton.disabled = false;
            }
        }
        
        // è™•ç†ç™»å‡º
        async function handleLogout() {
            try {
                logoutButton.innerHTML = '<div class="loading-spinner"></div> ç™»å‡ºä¸­...';
                logoutButton.disabled = true;
                
                console.log('å˜—è©¦ç™»å‡º');
                await auth.signOut();
                console.log('ç™»å‡ºæˆåŠŸ');
                
                // onAuthStateChanged æœƒè™•ç†å…¶é¤˜çš„æ“ä½œ
            } catch (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
                alert('ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                
                // é‡ç½®ç™»å‡ºæŒ‰éˆ•
                logoutButton.textContent = 'ç™»å‡º';
                logoutButton.disabled = false;
            }
        }
        
        // ç™»å…¥æˆåŠŸ
        function onLoginSuccess(user) {
            try {
                console.log('ç™»å…¥æˆåŠŸè™•ç†é–‹å§‹ï¼Œç”¨æˆ¶éƒµç®±:', user.email);
                
                // æ›´æ–°ç”¨æˆ¶ç•Œé¢
                userStatus.textContent = `å·²ç™»å…¥: ${user.email}`;
                loginSection.style.display = 'none';
                logoutButton.style.display = 'block';
                mainContent.style.display = 'block';
                
                // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡
                checkAdminStatus(user.uid);
                
                // åˆå§‹åŒ–æ´»å‹•æ¨™ç±¤é 
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabId = activeTab.getAttribute('data-tab');
                    console.log(`åˆå§‹åŒ–æ´»å‹•æ¨™ç±¤é : ${tabId}`);
                    
                    // ä½¿ç”¨ setTimeout ç¢ºä¿ UI å·²æ›´æ–°
                    setTimeout(() => {
                        if (tabId === 'report') {
                            console.log("å»¶é²åŠ è¼‰å ±å‘Š");
                            loadReports();
                        } else if (tabId === 'verification') {
                            loadVerificationRequests();
                        } else if (tabId === 'businessApproval') {
                            loadBusinessApprovalRequests();
                        } else if (tabId === 'statistics') {
                            loadStatistics();
                        }
                    }, 500);
                }
                
                // é‡ç½®ç™»å…¥æŒ‰éˆ•
                loginButton.textContent = 'ç™»å…¥';
                loginButton.disabled = false;
                
                console.log('ç™»å…¥æˆåŠŸè™•ç†å®Œæˆ');
            } catch (error) {
                console.error('ç™»å…¥æˆåŠŸè™•ç†å‡ºéŒ¯:', error);
                
                // ç¢ºä¿ç•Œé¢æ­£ç¢ºé¡¯ç¤ºï¼Œå³ä½¿å‡ºéŒ¯
                userStatus.textContent = `å·²ç™»å…¥: ${user.email}`;
                loginSection.style.display = 'none';
                logoutButton.style.display = 'block';
                mainContent.style.display = 'block';
                
                loginButton.textContent = 'ç™»å…¥';
                loginButton.disabled = false;
            }
        }

        // æ·»åŠ æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹çš„å‡½æ•¸
        async function checkAdminStatus(userId) {
            try {
                const adminDoc = await db.collection('admins').doc(userId).get();
                
                if (adminDoc.exists) {
                    console.log('ç”¨æˆ¶å·²æ˜¯ç®¡ç†å“¡');
                    // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹é¡¯ç¤º
                    userStatus.innerHTML = `${userStatus.textContent} <span style="color: #4CAF50; font-weight: bold; margin-left: 5px;">[ç®¡ç†å“¡]</span>`;
                    
                    // éš±è—ç”³è«‹ç®¡ç†å“¡æŒ‰éˆ•
                    if (document.getElementById('adminButton')) {
                        document.getElementById('adminButton').style.display = 'none';
                    }
                } else {
                    console.log('ç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç”³è«‹æŒ‰éˆ•');
                    if (document.getElementById('adminButton')) {
                        document.getElementById('adminButton').style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—:', error);
            }
        }
 
        // ç™»å‡ºæˆåŠŸè™•ç†å‡½æ•¸
        function onLogout() {
            console.log('åŸ·è¡Œç™»å‡ºå¾Œè™•ç†');
            
            // æ›´æ–°ç•Œé¢
            userStatus.textContent = '';
            loginSection.style.display = 'block';
            logoutButton.style.display = 'none';
            mainContent.style.display = 'none';
            
            // éš±è—æ‰€æœ‰å¯èƒ½é–‹å•Ÿçš„è©³æƒ…é é¢
            if (document.getElementById('report-detail')) {
                document.getElementById('report-detail').style.display = 'none';
            }
            
            if (document.getElementById('verification-detail')) {
                document.getElementById('verification-detail').style.display = 'none';
            }
            
            if (document.getElementById('business-approval-detail')) {
                document.getElementById('business-approval-detail').style.display = 'none';
            }
            
            // é‡ç½®ç™»å‡ºæŒ‰éˆ•
            logoutButton.textContent = 'ç™»å‡º';
            logoutButton.disabled = false;
            
            console.log('ç™»å‡ºå¾Œè™•ç†å®Œæˆ');
        }
                
        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // ç²å–éŒ¯èª¤ä¿¡æ¯
        function getErrorMessage(error) {
            switch(error.code) {
                case 'auth/invalid-email':
                    return 'ç„¡æ•ˆçš„éƒµç®±æ ¼å¼';
                case 'auth/user-disabled':
                    return 'æ­¤ç”¨æˆ¶å·²è¢«ç¦ç”¨';
                case 'auth/user-not-found':
                    return 'æ‰¾ä¸åˆ°å°æ‡‰çš„ç”¨æˆ¶';
                case 'auth/wrong-password':
                    return 'å¯†ç¢¼éŒ¯èª¤';
                default:
                    return `éŒ¯èª¤: ${error.message}`;
            }
        }
        
        // 1. è¼‰å…¥åº—å®¶å¯©æ ¸è«‹æ±‚ - ç¢ºä¿æ­£ç¢ºé¡¯ç¤ºåº—å®¶åˆ—è¡¨
        async function loadBusinessApprovalRequests() {
            const container = document.getElementById('business-approval-container');
            const loadingElement = document.getElementById('business-approval-loading');
            
            if (!container || !loadingElement) {
                console.error('åº—å®¶å¯©æ ¸å®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            container.innerHTML = '';
            loadingElement.style.display = 'flex';
            
            try {
                console.log("é–‹å§‹è¼‰å…¥åº—å®¶å¯©æ ¸è«‹æ±‚åˆ—è¡¨...");
                // ç²å–æ‰€æœ‰å¾…è™•ç†å¯©æ ¸è«‹æ±‚
                const querySnapshot = await db.collection('businessApprovalRequests')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                loadingElement.style.display = 'none';
                
                if (querySnapshot.empty) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;">æ²’æœ‰å¾…è™•ç†çš„åº—å®¶å¯©æ ¸è«‹æ±‚</div>';
                    return;
                }
                
                console.log(`ç™¼ç¾ ${querySnapshot.size} å€‹å¾…è™•ç†åº—å®¶å¯©æ ¸è«‹æ±‚`);
                
                // é¡¯ç¤ºå¯©æ ¸è«‹æ±‚å¡ç‰‡
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const requestCard = document.createElement('div');
                    requestCard.className = 'report-card pending';
                    
                    // æ ¼å¼åŒ–æ—¥æœŸ
                    const createdAt = data.createdAt ? new Date(data.createdAt.toDate()) : new Date();
                    const formattedDate = formatDate(createdAt);
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºé‡æ–°ç”³è«‹
                    const reapplyBadge = data.isReapply ? 
                        '<span class="status-badge badge-warning" style="margin-left: 5px;">é‡æ–°ç”³è«‹</span>' : '';
                    
                    requestCard.innerHTML = `
                        <h3>
                            <span class="status-badge badge-pending">å¾…å¯©æ ¸</span>
                            <span style="margin-left: 5px;">${data.businessName || 'æœªçŸ¥åº—å®¶'}</span>
                            ${reapplyBadge}
                        </h3>
                        <p><strong>åº—å®¶é¡å‹:</strong> ${getBusinessTypeText(data.businessType)}</p>
                        <p><strong>æäº¤æ™‚é–“:</strong> ${formattedDate}</p>
                        <p><strong>è¯çµ¡äºº:</strong> ${data.contactName || 'æœªçŸ¥'}</p>
                    `;
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    requestCard.addEventListener('click', () => {
                        console.log(`é»æ“Šåº—å®¶å¡ç‰‡ - ID: ${doc.id}, åº—å®¶åç¨±: ${data.businessName || 'æœªçŸ¥'}`);
                        showBusinessApprovalDetail(doc.id);
                    });
                    
                    container.appendChild(requestCard);
                });
                
            } catch (error) {
                console.error('åŠ è¼‰åº—å®¶å¯©æ ¸è«‹æ±‚éŒ¯èª¤:', error);
                loadingElement.style.display = 'none';
                container.innerHTML = `<div style="text-align: center; padding: 30px;">åŠ è¼‰å¯©æ ¸è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }
            
        // 2. é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ… - ä¿®å¾©é¡¯ç¤ºè©³æƒ…é é¢å•é¡Œ
        async function showBusinessApprovalDetail(requestId) {
            try {
                console.log(`é–‹å§‹é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ…ï¼Œè«‹æ±‚ID: ${requestId}`);
                
                // éš±è—ä¸»å…§å®¹
                mainContent.style.display = 'none';
                
                // ä½¿ç”¨æº–ç¢ºçš„é¡åé¸æ“‡å™¨ï¼Œé¿å…IDè¡çª
                const detailContainer = document.querySelector('.business-verification-detail');
                if (!detailContainer) {
                    console.error('æ‰¾ä¸åˆ°åº—å®¶å¯©æ ¸è©³æƒ…å®¹å™¨');
                    alert('é é¢å…ƒç´ éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
                    backToBusinessApprovalList();
                    return;
                }
                
                detailContainer.style.display = 'block';
                
                // è¨­ç½®è«‹æ±‚IDåˆ°éš±è—å­—æ®µ
                const requestIdField = document.getElementById('business-approval-requestid');
                if (!requestIdField) {
                    console.error('æ‰¾ä¸åˆ°business-approval-requestidå…ƒç´ ');
                    alert('é é¢å…ƒç´ éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
                    backToBusinessApprovalList();
                    return;
                }
                
                requestIdField.value = requestId;
                
                try {
                    // ç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š
                    console.log(`é–‹å§‹å¾Firebaseç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š...`);
                    const requestDoc = await db.collection('businessApprovalRequests').doc(requestId).get();
                    
                    if (!requestDoc.exists) {
                        console.error('æ‰¾ä¸åˆ°å¯©æ ¸è«‹æ±‚æ•¸æ“š');
                        alert('æ‰¾ä¸åˆ°å¯©æ ¸è«‹æ±‚');
                        backToBusinessApprovalList();
                        return;
                    }
                    
                    const requestData = requestDoc.data();
                    console.log(`æˆåŠŸç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š:`, requestData);
                    
                    // å¡«å……è©³æƒ…é æ•¸æ“š
                    document.getElementById('business-name').textContent = requestData.businessName || 'æœªçŸ¥åº—å®¶';
                    document.getElementById('business-userid').textContent = requestData.userId || 'æœªçŸ¥';
                    document.getElementById('business-type').textContent = getBusinessTypeText(requestData.businessType);
                    document.getElementById('business-time').textContent = formatDate(
                        requestData.createdAt ? new Date(requestData.createdAt.toDate()) : new Date()
                    );
                    document.getElementById('business-address').textContent = requestData.address || 'æœªçŸ¥';
                    document.getElementById('business-phone').textContent = requestData.phoneNumber || 'æœªçŸ¥';
                    document.getElementById('business-contact-name').textContent = requestData.contactName || 'æœªçŸ¥';
                    document.getElementById('business-contact-phone').textContent = requestData.contactPhone || 'æœªçŸ¥';
                    
                    // è™•ç†è­‰ç…§ç…§ç‰‡
                    const licensesContainer = document.getElementById('business-licenses');
                    if (!licensesContainer) {
                        console.error('æ‰¾ä¸åˆ°business-licenseså®¹å™¨');
                        return;
                    }
                    
                    licensesContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
                    
                    const licenseUrls = requestData.licenseUrls || [];
                    console.log(`è­‰ç…§ç…§ç‰‡æ•¸é‡: ${licenseUrls.length}`);
                    
                    if (licenseUrls.length === 0) {
                        licensesContainer.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">æ²’æœ‰ä¸Šå‚³è­‰æ˜æ–‡ä»¶</p>';
                    } else {
                        // å°æ¯å€‹æ–‡ä»¶URLé€²è¡Œè™•ç†
                        for (let index = 0; index < licenseUrls.length; index++) {
                            const url = licenseUrls[index];
                            
                            try {
                                // å‰µå»ºç…§ç‰‡é …ç›®å…ƒç´ 
                                const photoItem = document.createElement('div');
                                photoItem.className = 'photo-item';
                                
                                // åˆ¤æ–·æª”æ¡ˆé¡å‹
                                const isImage = url.toLowerCase().match(/\.(jpeg|jpg|gif|png|webp|bmp)$/i);
                                const isPdf = url.toLowerCase().endsWith('.pdf');
                                
                                if (isImage) {
                                    // åœ–ç‰‡é è¦½ - æ·»åŠ æ›´å¥½çš„éŒ¯èª¤è™•ç†
                                    photoItem.innerHTML = `
                                        <img src="${url}" alt="è­‰æ˜æ–‡ä»¶ ${index + 1}" 
                                            onerror="this.src='https://placehold.co/300x300?text=è¼‰å…¥å¤±æ•—'; this.onerror=null;"
                                            loading="lazy" style="object-fit: contain;">
                                        <span class="index">#${index + 1}</span>
                                    `;
                                    
                                    // é åŠ è¼‰åœ–ç‰‡ä¸¦æª¢æŸ¥æ˜¯å¦èƒ½æ­£ç¢ºè¼‰å…¥
                                    const preloadImg = new Image();
                                    preloadImg.onload = function() {
                                        console.log(`åœ–ç‰‡ #${index + 1} é åŠ è¼‰æˆåŠŸ`);
                                    };
                                    preloadImg.onerror = function() {
                                        console.error(`åœ–ç‰‡ #${index + 1} è¼‰å…¥å¤±æ•—ï¼ŒURL: ${url}`);
                                        // å¦‚æœæ˜¯Firebase Storage URLï¼Œå˜—è©¦ä½¿ç”¨å…¶ä»–æ–¹æ³•ç²å–
                                        if (url.includes('firebasestorage.googleapis.com')) {
                                            console.log(`å˜—è©¦ä½¿ç”¨Firebase Storageç›´æ¥ç²å–åœ–ç‰‡ #${index + 1}`);
                                            // é€™è£¡å¯ä»¥æ·»åŠ é¡å¤–çš„Firebase Storageè™•ç†é‚è¼¯
                                        }
                                    };
                                    preloadImg.src = url;
                                } else if (isPdf) {
                                    // PDF é è¦½
                                    photoItem.innerHTML = `
                                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f8f9fa;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                <path d="M9 15h6"></path>
                                                <path d="M9 18h6"></path>
                                                <path d="M9 12h2"></path>
                                            </svg>
                                            <span style="margin-top: 10px;">PDF æ–‡ä»¶</span>
                                        </div>
                                        <span class="index">#${index + 1}</span>
                                    `;
                                } else {
                                    // å˜—è©¦æª¢æ¸¬æ˜¯å¦ç‚ºåœ–ç‰‡æ ¼å¼ï¼ˆæ²’æœ‰æ˜ç¢ºå‰¯æª”åçš„æƒ…æ³ï¼‰
                                    const testImage = new Image();
                                    testImage.onload = function() {
                                        // å¦‚æœæˆåŠŸè¼‰å…¥ï¼Œå‰‡ç¢ºå¯¦æ˜¯åœ–ç‰‡
                                        photoItem.innerHTML = `
                                            <img src="${url}" alt="è­‰æ˜æ–‡ä»¶ ${index + 1}" 
                                                onerror="this.src='https://placehold.co/300x300?text=è¼‰å…¥å¤±æ•—'; this.onerror=null;"
                                                loading="lazy" style="object-fit: contain;">
                                            <span class="index">#${index + 1}</span>
                                        `;
                                    };
                                    testImage.onerror = function() {
                                        // ä¸æ˜¯åœ–ç‰‡ï¼Œé¡¯ç¤ºç‚ºä¸€èˆ¬æª”æ¡ˆ
                                        photoItem.innerHTML = `
                                            <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f8f9fa;">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                                    <polyline points="13 2 13 9 20 9"></polyline>
                                                </svg>
                                                <span style="margin-top: 10px;">æœªçŸ¥æª”æ¡ˆ</span>
                                            </div>
                                            <span class="index">#${index + 1}</span>
                                        `;
                                    };
                                    // å…ˆé¡¯ç¤ºä¸€å€‹é€šç”¨çš„æ–‡ä»¶åœ–æ¨™
                                    photoItem.innerHTML = `
                                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f8f9fa;">
                                            <div class="loading-spinner"></div>
                                            <span style="margin-top: 10px;">æª¢æ¸¬æ–‡ä»¶é¡å‹...</span>
                                        </div>
                                        <span class="index">#${index + 1}</span>
                                    `;
                                    testImage.src = url;
                                }
                                
                                // é»æ“Šæ”¾å¤§æŸ¥çœ‹
                                photoItem.addEventListener('click', () => {
                                    if (isImage) {
                                        // åœ–ç‰‡ç”¨ç‡ˆç®±æŸ¥çœ‹
                                        document.getElementById('lightboxImage').src = url;
                                        document.getElementById('lightboxImage').onerror = function() {
                                            this.src = 'https://placehold.co/800x600?text=è¼‰å…¥å¤±æ•—';
                                            this.onerror = null;
                                        };
                                        document.getElementById('imageLightbox').style.display = 'flex';
                                    } else if (isPdf) {
                                        // PDF åœ¨æ–°çª—å£æ‰“é–‹
                                        window.open(url, '_blank');
                                    } else {
                                        // å…¶ä»–æª”æ¡ˆä¸‹è¼‰
                                        window.open(url, '_blank');
                                    }
                                });
                                
                                licensesContainer.appendChild(photoItem);
                            } catch (imageError) {
                                console.error(`è™•ç†åœ–ç‰‡ #${index + 1} æ™‚ç™¼ç”ŸéŒ¯èª¤:`, imageError);
                                // å¦‚æœè™•ç†ç‰¹å®šåœ–ç‰‡æ™‚å‡ºéŒ¯ï¼Œç¹¼çºŒè™•ç†å…¶ä»–åœ–ç‰‡
                                continue;
                            }
                        }
                    }
                    
                    // ç¢ºä¿äº‹ä»¶è™•ç†ç¶å®šåªåŸ·è¡Œä¸€æ¬¡
                    const backBtn = document.getElementById('business-approval-back');
                    const approveBtn = document.getElementById('business-approve');
                    const rejectBtn = document.getElementById('business-reject');
                    
                    // å…ˆç§»é™¤èˆŠçš„äº‹ä»¶è™•ç†ç¨‹åºï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    if (backBtn) {
                        const newBackBtn = backBtn.cloneNode(true);
                        backBtn.parentNode.replaceChild(newBackBtn, backBtn);
                        newBackBtn.addEventListener('click', backToBusinessApprovalList);
                    }
                    
                    if (approveBtn) {
                        const newApproveBtn = approveBtn.cloneNode(true);
                        approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);
                        newApproveBtn.addEventListener('click', approveBusinessRequest);
                    }
                    
                    if (rejectBtn) {
                        const newRejectBtn = rejectBtn.cloneNode(true);
                        rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
                        newRejectBtn.addEventListener('click', rejectBusinessRequest);
                    }
                    
                    console.log("åº—å®¶å¯©æ ¸è©³æƒ…è¼‰å…¥å®Œæˆ:", requestId);
                    
                } catch (error) {
                    console.error('é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ…éŒ¯èª¤:', error);
                    alert(`è¼‰å…¥å¯©æ ¸è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                    backToBusinessApprovalList();
                }
            } catch (error) {
                console.error('é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ…é é¢éŒ¯èª¤:', error);
                alert('é é¢è¼‰å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦');
                mainContent.style.display = 'block';
            }
        }

        // å¢å¼·ç‰ˆçš„è™•ç†Firebase Storage URLå‡½æ•¸
        function getOptimizedImageUrl(url) {
            // å¦‚æœæ˜¯Firebase Storage URLï¼Œå˜—è©¦å„ªåŒ–URL
            if (url && url.includes('firebasestorage.googleapis.com')) {
                // ç§»é™¤å¤šé¤˜çš„æŸ¥è©¢åƒæ•¸ï¼Œé€™äº›å¯èƒ½å°è‡´è·¨åŸŸå•é¡Œ
                const cleanUrl = url.split('?')[0];
                return cleanUrl;
            }
            return url;
        }

        // ç”¨æ–¼è™•ç†åœ–ç‰‡è¼‰å…¥éŒ¯èª¤çš„é€šç”¨å‡½æ•¸
        function handleImageLoadError(img, fallbackText) {
            img.onerror = function() {
                // å‰µå»ºä¸€å€‹æ›¿ä»£çš„å…§å®¹é¡¯ç¤º
                const container = img.parentElement;
                const placeholder = document.createElement('div');
                placeholder.style.width = '100%';
                placeholder.style.height = '100%';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.style.backgroundColor = '#f8f9fa';
                placeholder.style.color = '#999';
                placeholder.textContent = fallbackText || 'åœ–ç‰‡ç„¡æ³•è¼‰å…¥';
                
                // æ›¿æ›åœ–ç‰‡å…ƒç´ 
                container.replaceChild(placeholder, img);
            };
        }
            
        // 3. è¿”å›åº—å®¶å¯©æ ¸åˆ—è¡¨
        function backToBusinessApprovalList() {
            console.log('è¿”å›åº—å®¶å¯©æ ¸åˆ—è¡¨');
            
            // ä½¿ç”¨é¡åé¸æ“‡å™¨ï¼Œé¿å…IDè¡çª
            const detailContainer = document.querySelector('.business-verification-detail');
            if (detailContainer) {
                detailContainer.style.display = 'none';
            }
            
            mainContent.style.display = 'block';
            
            // æ¸…ç©ºæ‹’çµ•åŸå› 
            if (document.getElementById('reject-reason')) {
                document.getElementById('reject-reason').value = '';
            }
            
            // é‡æ–°å•Ÿç”¨æŒ‰éˆ•ï¼ˆä»¥é˜²ä¹‹å‰è¢«ç¦ç”¨ï¼‰
            const approveBtn = document.getElementById('business-approve');
            const rejectBtn = document.getElementById('business-reject');
            
            if (approveBtn) {
                approveBtn.disabled = false;
                approveBtn.textContent = 'æ ¸å‡†åº—å®¶';
            }
            
            if (rejectBtn) {
                rejectBtn.disabled = false;
                rejectBtn.textContent = 'æ‹’çµ•å¯©æ ¸';
            }
        }


        // 4. æ ¸å‡†åº—å®¶å¯©æ ¸
        async function approveBusinessRequest() {
            const requestId = document.getElementById('business-approval-requestid').value;
            
            if (!requestId) {
                alert('ç„¡æ•ˆçš„è«‹æ±‚ID');
                return;
            }
            
            try {
                console.log(`é–‹å§‹æ ¸å‡†åº—å®¶å¯©æ ¸ï¼Œè«‹æ±‚ID: ${requestId}`);
                
                const approveBtn = document.getElementById('business-approve');
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<div class="loading-spinner"></div> è™•ç†ä¸­...';
                
                // ç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š
                const requestDoc = await db.collection('businessApprovalRequests').doc(requestId).get();
                if (!requestDoc.exists) {
                    throw new Error('æ‰¾ä¸åˆ°å¯©æ ¸è«‹æ±‚');
                }
                
                const requestData = requestDoc.data();
                const userId = requestData.userId;
                
                console.log(`æ ¸å‡†ç”¨æˆ¶ID: ${userId} çš„åº—å®¶ç”³è«‹`);
                
                // 1. æ›´æ–°åº—å®¶ç‹€æ…‹ç‚ºå·²æ ¸å‡†
                await db.collection('businesses').doc(userId).set({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: auth.currentUser ? auth.currentUser.uid : 'admin',
                    businessName: requestData.businessName,
                    businessType: requestData.businessType,
                    address: requestData.address,
                    phoneNumber: requestData.phoneNumber,
                    contactName: requestData.contactName,
                    contactPhone: requestData.contactPhone,
                    licenseUrls: requestData.licenseUrls || [],
                    createdAt: requestData.createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // // 2. æ›´æ–°ç”¨æˆ¶è³‡æ–™
                // await db.collection('ç”¨æˆ¶è³‡æ–™').doc(userId).update({
                //     isBusiness: true,
                //     businessVerified: true,
                //     updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                // });
                
                // 3. ç™¼é€é€šçŸ¥
                await db.collection('notifications').add({
                    userId: userId,
                    type: 'business_approval',
                    message: 'æ­å–œï¼æ‚¨çš„åº—å®¶å¸³è™Ÿå·²é€šéå¯©æ ¸ï¼Œç¾åœ¨å¯ä»¥ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½ã€‚',
                    isRead: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 4. åˆªé™¤å¯©æ ¸è«‹æ±‚ (ç¢ºä¿é€™ä¸€æ­¥ä¸æœƒå¤±æ•—)
                await db.collection('businessApprovalRequests').doc(requestId).delete();
                
                alert('å·²æ ¸å‡†åº—å®¶å¸³è™Ÿ');
                backToBusinessApprovalList();
                
                // é‡æ–°åŠ è¼‰å¯©æ ¸åˆ—è¡¨
                loadBusinessApprovalRequests();
                
            } catch (error) {
                console.error('æ ¸å‡†åº—å®¶å¯©æ ¸éŒ¯èª¤:', error);
                alert(`æ ¸å‡†åº—å®¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                
                const approveBtn = document.getElementById('business-approve');
                approveBtn.disabled = false;
                approveBtn.textContent = 'æ ¸å‡†åº—å®¶';
            }
        }
        

        // 5. æ‹’çµ•åº—å®¶å¯©æ ¸
        async function rejectBusinessRequest() {
            const requestId = document.getElementById('business-approval-requestid').value;
            const rejectReason = document.getElementById('reject-reason').value.trim();
            
            if (!requestId) {
                alert('ç„¡æ•ˆçš„è«‹æ±‚ID');
                return;
            }
            
            if (!rejectReason) {
                alert('è«‹å¡«å¯«æ‹’çµ•åŸå› ');
                return;
            }
            
            try {
                console.log(`é–‹å§‹æ‹’çµ•åº—å®¶å¯©æ ¸ï¼Œè«‹æ±‚ID: ${requestId}`);
                
                const rejectBtn = document.getElementById('business-reject');
                rejectBtn.disabled = true;
                rejectBtn.innerHTML = '<div class="loading-spinner"></div> è™•ç†ä¸­...';
                
                // ç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š
                const requestDoc = await db.collection('businessApprovalRequests').doc(requestId).get();
                if (!requestDoc.exists) {
                    throw new Error('æ‰¾ä¸åˆ°å¯©æ ¸è«‹æ±‚');
                }
                
                const requestData = requestDoc.data();
                const userId = requestData.userId;
                
                console.log(`æ‹’çµ•ç”¨æˆ¶ID: ${userId} çš„åº—å®¶ç”³è«‹`);
                
                // 1. æ›´æ–°åº—å®¶ç‹€æ…‹ç‚ºå·²æ‹’çµ•
                await db.collection('businesses').doc(userId).set({
                    status: 'rejected',
                    rejectReason: rejectReason,
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: auth.currentUser ? auth.currentUser.uid : 'admin',
                    businessName: requestData.businessName,
                    businessType: requestData.businessType,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // // 2. æ›´æ–°ç”¨æˆ¶è³‡æ–™
                // await db.collection('ç”¨æˆ¶è³‡æ–™').doc(userId).update({
                //     businessVerified: false,
                //     updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                // });
                
                // 3. ç™¼é€é€šçŸ¥
                await db.collection('notifications').add({
                    userId: userId,
                    type: 'business_rejection',
                    message: `å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„åº—å®¶å¸³è™Ÿç”³è«‹æœªé€šéå¯©æ ¸ã€‚åŸå› : ${rejectReason}`,
                    data: {
                        rejectReason: rejectReason
                    },
                    isRead: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 4. åˆªé™¤å¯©æ ¸è«‹æ±‚ (ç¢ºä¿é€™ä¸€æ­¥ä¸æœƒå¤±æ•—)
                await db.collection('businessApprovalRequests').doc(requestId).delete();
                
                alert('å·²æ‹’çµ•åº—å®¶å¯©æ ¸ç”³è«‹');
                backToBusinessApprovalList();
                
                // é‡æ–°åŠ è¼‰å¯©æ ¸åˆ—è¡¨
                loadBusinessApprovalRequests();
                
            } catch (error) {
                console.error('æ‹’çµ•åº—å®¶å¯©æ ¸éŒ¯èª¤:', error);
                alert(`æ‹’çµ•åº—å®¶æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                
                const rejectBtn = document.getElementById('business-reject');
                rejectBtn.disabled = false;
                rejectBtn.textContent = 'æ‹’çµ•å¯©æ ¸';
            }
        }

        // å¢å¼·çš„ç‡ˆç®±åŠŸèƒ½ï¼Œæ”¯æŒæ›´å¥½çš„åœ–ç‰‡é è¦½

        // ç•¶DOMåŠ è¼‰å®Œæˆå¾Œè¨­ç½®ç‡ˆç®±åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            setupEnhancedLightbox();
        });

        // è¨­ç½®å¢å¼·çš„ç‡ˆç®±åŠŸèƒ½
        function setupEnhancedLightbox() {
            const lightbox = document.getElementById('imageLightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            const closeButton = lightbox.querySelector('.close');
            
            // ç¢ºä¿ç‡ˆç®±å…ƒç´ å­˜åœ¨
            if (!lightbox || !lightboxImage || !closeButton) {
                console.error('ç‡ˆç®±å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            // é—œé–‰ç‡ˆç®±çš„å‡½æ•¸
            function closeLightbox() {
                lightbox.classList.remove('active');
                setTimeout(() => {
                    lightbox.style.display = 'none';
                }, 300); // ç­‰å¾…éæ¸¡æ•ˆæœå®Œæˆ
            }
            
            // ç¶å®šé—œé–‰æŒ‰éˆ•äº‹ä»¶
            closeButton.addEventListener('click', closeLightbox);
            
            // æŒ‰ESCéµé—œé–‰ç‡ˆç®±
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && lightbox.classList.contains('active')) {
                    closeLightbox();
                }
            });
            
            // é»æ“Šç‡ˆç®±èƒŒæ™¯é—œé–‰
            lightbox.addEventListener('click', function(e) {
                // åªæœ‰ç•¶é»æ“Šçš„æ˜¯ç‡ˆç®±æœ¬èº«è€Œä¸æ˜¯å…¶ä¸­çš„åœ–ç‰‡æ™‚æ‰é—œé–‰
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            // ç‚ºlightboxImageæ·»åŠ è¼‰å…¥äº‹ä»¶
            lightboxImage.addEventListener('load', function() {
                console.log('ç‡ˆç®±åœ–ç‰‡è¼‰å…¥æˆåŠŸ');
            });
            
            // ç‚ºlightboxImageæ·»åŠ éŒ¯èª¤è™•ç†
            lightboxImage.addEventListener('error', function() {
                this.src = 'https://placehold.co/800x600?text=åœ–ç‰‡è¼‰å…¥å¤±æ•—';
                console.error('ç‡ˆç®±åœ–ç‰‡è¼‰å…¥å¤±æ•—');
            });
            
            // ä¿®æ”¹åŸæœ‰çš„ç‡ˆç®±æ‰“é–‹æ–¹æ³•
            window.openLightbox = function(imageUrl) {
                if (!imageUrl) {
                    console.error('å˜—è©¦æ‰“é–‹ç‡ˆç®±ä½†æ²’æœ‰æä¾›åœ–ç‰‡URL');
                    return;
                }
                
                // è¨­ç½®è¼‰å…¥ä¸­çš„ç‹€æ…‹
                lightboxImage.src = 'https://placehold.co/50x50?text=è¼‰å…¥ä¸­';
                
                // é¡¯ç¤ºç‡ˆç®±
                lightbox.style.display = 'flex';
                
                // ä½¿ç”¨setTimeoutç¢ºä¿éæ¸¡æ•ˆæœç”Ÿæ•ˆ
                setTimeout(() => {
                    lightbox.classList.add('active');
                }, 10);
                
                // è¼‰å…¥å¯¦éš›åœ–ç‰‡
                lightboxImage.src = imageUrl;
            };
        }

        // å¢å¼·çš„ç…§ç‰‡è™•ç†å‡½æ•¸ - ç”¨æ–¼åº—å®¶å¯©æ ¸è©³æƒ…é é¢
        function setupBusinessPhotosView(containerId, photoUrls) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`æ‰¾ä¸åˆ°å®¹å™¨: #${containerId}`);
                return;
            }
            
            container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            
            if (!photoUrls || photoUrls.length === 0) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">æ²’æœ‰ä¸Šå‚³è­‰æ˜æ–‡ä»¶</p>';
                return;
            }
            
            photoUrls.forEach((url, index) => {
                const photoItem = createPhotoItem(url, index);
                container.appendChild(photoItem);
            });
        }

        // å‰µå»ºç…§ç‰‡é …ç›®å…ƒç´ 
        function createPhotoItem(url, index) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­çš„ç‹€æ…‹
            photoItem.innerHTML = `
                <div class="image-loading">
                    <div class="loading-spinner"></div>
                </div>
                <span class="index">#${index + 1}</span>
            `;
            
            // åˆ¤æ–·æª”æ¡ˆé¡å‹
            const fileExtension = url.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExtension);
            const isPdf = fileExtension === 'pdf';
            
            if (isImage) {
                // åœ–ç‰‡é è¦½
                const img = document.createElement('img');
                img.alt = `è­‰æ˜æ–‡ä»¶ ${index + 1}`;
                img.loading = 'lazy';
                
                // åœ–ç‰‡è¼‰å…¥æˆåŠŸ
                img.onload = function() {
                    // ç§»é™¤è¼‰å…¥æŒ‡ç¤ºå™¨
                    const loadingElement = photoItem.querySelector('.image-loading');
                    if (loadingElement) {
                        photoItem.removeChild(loadingElement);
                    }
                    
                    // æ·»åŠ æ–‡ä»¶é¡å‹æ¨™ç±¤
                    const fileTypeTag = document.createElement('span');
                    fileTypeTag.className = 'file-type';
                    fileTypeTag.textContent = fileExtension.toUpperCase();
                    photoItem.appendChild(fileTypeTag);
                };
                
                // åœ–ç‰‡è¼‰å…¥å¤±æ•—
                img.onerror = function() {
                    // æ›¿æ›ç‚ºéŒ¯èª¤é¡¯ç¤º
                    photoItem.innerHTML = `
                        <div class="error-placeholder">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            <p>åœ–ç‰‡ç„¡æ³•è¼‰å…¥</p>
                        </div>
                        <span class="index">#${index + 1}</span>
                    `;
                };
                
                // è¨­ç½®åœ–ç‰‡ä¾†æº
                img.src = url;
                photoItem.appendChild(img);
                
                // é»æ“Šæ”¾å¤§æŸ¥çœ‹
                photoItem.addEventListener('click', () => {
                    window.openLightbox(url);
                });
            } else if (isPdf) {
                // PDF é è¦½
                photoItem.innerHTML = `
                    <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f8f9fa;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#dc3545" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <path d="M9 15h6"></path>
                            <path d="M9 18h6"></path>
                            <path d="M9 12h2"></path>
                        </svg>
                        <span style="margin-top: 10px;">PDF æ–‡ä»¶</span>
                    </div>
                    <span class="index">#${index + 1}</span>
                    <span class="file-type">PDF</span>
                `;
                
                // é»æ“Šåœ¨æ–°çª—å£æ‰“é–‹
                photoItem.addEventListener('click', () => {
                    window.open(url, '_blank');
                });
            } else {
                // æœªçŸ¥æ–‡ä»¶é¡å‹ - å˜—è©¦åˆ¤æ–·æ˜¯å¦ç‚ºåœ–ç‰‡
                const testImage = new Image();
                
                testImage.onload = function() {
                    // æ˜¯åœ–ç‰‡ï¼Œæ›´æ–°ç‚ºåœ–ç‰‡é¡¯ç¤º
                    photoItem.innerHTML = `
                        <img src="${url}" alt="è­‰æ˜æ–‡ä»¶ ${index + 1}" 
                            onerror="this.onerror=null; this.src='https://placehold.co/300x300?text=è¼‰å…¥å¤±æ•—';"
                            loading="lazy">
                        <span class="index">#${index + 1}</span>
                        <span class="file-type">åœ–ç‰‡</span>
                    `;
                    
                    // é»æ“Šæ”¾å¤§æŸ¥çœ‹
                    photoItem.addEventListener('click', () => {
                        window.openLightbox(url);
                    });
                };
                
                testImage.onerror = function() {
                    // ä¸æ˜¯åœ–ç‰‡ï¼Œé¡¯ç¤ºé€šç”¨æ–‡ä»¶åœ–æ¨™
                    photoItem.innerHTML = `
                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #f8f9fa;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                <polyline points="13 2 13 9 20 9"></polyline>
                            </svg>
                            <span style="margin-top: 10px;">æœªçŸ¥æª”æ¡ˆ</span>
                        </div>
                        <span class="index">#${index + 1}</span>
                        <span class="file-type">æª”æ¡ˆ</span>
                    `;
                    
                    // é»æ“Šä¸‹è¼‰æ–‡ä»¶
                    photoItem.addEventListener('click', () => {
                        window.open(url, '_blank');
                    });
                };
                
                // é–‹å§‹æª¢æ¸¬
                testImage.src = url;
            }
            
            return photoItem;
        }

        // ä¿®æ”¹åº—å®¶å¯©æ ¸è©³æƒ…å‡½æ•¸ï¼Œä½¿ç”¨å¢å¼·çš„ç…§ç‰‡è™•ç†
        function enhancedShowBusinessApprovalDetail(requestId) {
            // ä¿ç•™åŸæœ‰å‡½æ•¸çš„å¤§éƒ¨åˆ†é‚è¼¯
            // ä½†åœ¨è™•ç†ç…§ç‰‡çš„éƒ¨åˆ†æ”¹ç”¨æ–°çš„æ–¹æ³•
            
            try {
                console.log(`é–‹å§‹é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ…ï¼Œè«‹æ±‚ID: ${requestId}`);
                
                // éš±è—ä¸»å…§å®¹
                mainContent.style.display = 'none';
                
                // ä½¿ç”¨æº–ç¢ºçš„é¡åé¸æ“‡å™¨ï¼Œé¿å…IDè¡çª
                const detailContainer = document.querySelector('.business-verification-detail');
                if (!detailContainer) {
                    console.error('æ‰¾ä¸åˆ°åº—å®¶å¯©æ ¸è©³æƒ…å®¹å™¨');
                    alert('é é¢å…ƒç´ éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
                    backToBusinessApprovalList();
                    return;
                }
                
                detailContainer.style.display = 'block';
                
                // è¨­ç½®è«‹æ±‚IDåˆ°éš±è—å­—æ®µ
                const requestIdField = document.getElementById('business-approval-requestid');
                if (!requestIdField) {
                    console.error('æ‰¾ä¸åˆ°business-approval-requestidå…ƒç´ ');
                    alert('é é¢å…ƒç´ éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡');
                    backToBusinessApprovalList();
                    return;
                }
                
                requestIdField.value = requestId;
                
                // ç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š
                db.collection('businessApprovalRequests').doc(requestId).get()
                    .then(requestDoc => {
                        if (!requestDoc.exists) {
                            console.error('æ‰¾ä¸åˆ°å¯©æ ¸è«‹æ±‚æ•¸æ“š');
                            alert('æ‰¾ä¸åˆ°å¯©æ ¸è«‹æ±‚');
                            backToBusinessApprovalList();
                            return;
                        }
                        
                        const requestData = requestDoc.data();
                        console.log(`æˆåŠŸç²å–å¯©æ ¸è«‹æ±‚æ•¸æ“š:`, requestData);
                        
                        // å¡«å……è©³æƒ…é æ•¸æ“š
                        document.getElementById('business-name').textContent = requestData.businessName || 'æœªçŸ¥åº—å®¶';
                        document.getElementById('business-userid').textContent = requestData.userId || 'æœªçŸ¥';
                        document.getElementById('business-type').textContent = getBusinessTypeText(requestData.businessType);
                        document.getElementById('business-time').textContent = formatDate(
                            requestData.createdAt ? new Date(requestData.createdAt.toDate()) : new Date()
                        );
                        document.getElementById('business-address').textContent = requestData.address || 'æœªçŸ¥';
                        document.getElementById('business-phone').textContent = requestData.phoneNumber || 'æœªçŸ¥';
                        document.getElementById('business-contact-name').textContent = requestData.contactName || 'æœªçŸ¥';
                        document.getElementById('business-contact-phone').textContent = requestData.contactPhone || 'æœªçŸ¥';
                        
                        // ä½¿ç”¨å¢å¼·çš„ç…§ç‰‡é¡¯ç¤ºå‡½æ•¸
                        setupBusinessPhotosView('business-licenses', requestData.licenseUrls || []);
                        
                        // ç¢ºä¿äº‹ä»¶è™•ç†ç¶å®šåªåŸ·è¡Œä¸€æ¬¡
                        const backBtn = document.getElementById('business-approval-back');
                        const approveBtn = document.getElementById('business-approve');
                        const rejectBtn = document.getElementById('business-reject');
                        
                        // å…ˆç§»é™¤èˆŠçš„äº‹ä»¶è™•ç†ç¨‹åºï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                        if (backBtn) {
                            const newBackBtn = backBtn.cloneNode(true);
                            backBtn.parentNode.replaceChild(newBackBtn, backBtn);
                            newBackBtn.addEventListener('click', backToBusinessApprovalList);
                        }
                        
                        if (approveBtn) {
                            const newApproveBtn = approveBtn.cloneNode(true);
                            approveBtn.parentNode.replaceChild(newApproveBtn, approveBtn);
                            newApproveBtn.addEventListener('click', approveBusinessRequest);
                        }
                        
                        if (rejectBtn) {
                            const newRejectBtn = rejectBtn.cloneNode(true);
                            rejectBtn.parentNode.replaceChild(newRejectBtn, rejectBtn);
                            newRejectBtn.addEventListener('click', rejectBusinessRequest);
                        }
                        
                        console.log("åº—å®¶å¯©æ ¸è©³æƒ…è¼‰å…¥å®Œæˆ:", requestId);
                        
                    })
                    .catch(error => {
                        console.error('é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ…éŒ¯èª¤:', error);
                        alert(`è¼‰å…¥å¯©æ ¸è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                        backToBusinessApprovalList();
                    });
                    
            } catch (error) {
                console.error('é¡¯ç¤ºåº—å®¶å¯©æ ¸è©³æƒ…é é¢éŒ¯èª¤:', error);
                alert('é é¢è¼‰å…¥éŒ¯èª¤ï¼Œè«‹é‡è©¦');
                mainContent.style.display = 'block';
            }
        }
            
        // ç²å–åº—å®¶é¡å‹æ–‡å­—æè¿°
        function getBusinessTypeText(type) {
            switch (type) {
                case 'cafe': return 'å’–å•¡å»³';
                case 'restaurant': return 'é¤å»³';
                case 'bar': return 'é…’å§';
                case 'dessert': return 'ç”œé»åº—';
                case 'tea': return 'èŒ¶é£²åº—';
                case 'other': return 'å…¶ä»–';
                default: return type || 'æœªçŸ¥';
            }
        }

        // åŠ è¼‰æª¢èˆ‰åˆ—è¡¨
        async function loadReports() {
            try {
                // é¡¯ç¤ºè¼‰å…¥ä¸­
                reportsContainer.innerHTML = '';
                document.getElementById('reports-loading').style.display = 'flex';
                
                console.log("é–‹å§‹è¼‰å…¥å ±å‘Šæ•¸æ“š...");
                
                // ç²å–éæ¿¾æ¢ä»¶
                const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                const sortBy = document.getElementById('sortBy').value;
                
                // æ§‹å»ºæŸ¥è©¢
                let query = db.collection('reports');
                
                // å˜—è©¦å…ˆç²å–æ–‡æª”è¨ˆæ•¸ï¼Œæ¸¬è©¦æ¬Šé™
                try {
                    const testDoc = await db.collection('reports').limit(1).get();
                    console.log("æˆåŠŸç²å–å ±å‘Šæ¸¬è©¦æ•¸æ“š");
                } catch (permError) {
                    console.error("å ±å‘Šé›†åˆæ¬Šé™æ¸¬è©¦å¤±æ•—:", permError);
                    // é¡¯ç¤ºæ¬Šé™éŒ¯èª¤ä½†ä¸ç™»å‡ºç”¨æˆ¶
                    document.getElementById('reports-loading').style.display = 'none';
                    reportsContainer.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 50px;">
                            <h3>æ¬Šé™éŒ¯èª¤</h3>
                            <p>æ‚¨æ²’æœ‰æ¬Šé™æŸ¥çœ‹å ±å‘Šæ•¸æ“šã€‚è«‹ç¢ºä¿æ‚¨æœ‰é©ç•¶çš„æ¬Šé™æˆ–è¯ç¹«ç®¡ç†å“¡ã€‚</p>
                            <p>æŠ€è¡“éŒ¯èª¤: ${permError.message}</p>
                        </div>`;
                    return;
                }
                
                // æ‡‰ç”¨ç‹€æ…‹éæ¿¾
                if (statusFilter !== 'all') {
                    query = query.where('status', '==', statusFilter);
                }
                
                // æ‡‰ç”¨é¡å‹éæ¿¾
                if (typeFilter !== 'all') {
                    query = query.where('reasons', 'array-contains', typeFilter);
                }
                
                // æ‡‰ç”¨æ’åº
                switch (sortBy) {
                    case 'newest':
                        query = query.orderBy('createdAt', 'desc');
                        break;
                    case 'oldest':
                        query = query.orderBy('createdAt', 'asc');
                        break;
                    case 'severity':
                        // å‡è¨­æœ‰åš´é‡åº¦å­—æ®µ
                        query = query.orderBy('severity', 'desc');
                        break;
                    case 'reporterCredit':
                        // é€™å€‹å¯èƒ½éœ€è¦å¤šæ®µè™•ç†ï¼Œå…ˆç²å–æ‰€æœ‰æ•¸æ“š
                        break;
                }
                
                // åˆ†é æŸ¥è©¢
                const querySnapshot = await query.get();
                totalReports = querySnapshot.size;
                
                // è¨ˆç®—åˆ†é 
                const totalPages = Math.ceil(totalReports / reportsPerPage);
                updatePagination(totalPages);
                
                // æ¨¡æ“¬åˆ†é  (å¯¦éš›æ‡‰ç”¨ä¸­æ‡‰è©²ä½¿ç”¨ startAfter)
                const reports = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    reports.push(data);
                });
                
                // æœå°‹éæ¿¾ (Firestore ä¸æ”¯æŒæ–‡æœ¬æœç´¢ï¼Œæ‰€ä»¥åœ¨å®¢æˆ¶ç«¯éæ¿¾)
                let filteredReports = reports;
                if (searchTerm) {
                    filteredReports = reports.filter(report => {
                        return (
                            (report.reportedUserName && report.reportedUserName.toLowerCase().includes(searchTerm)) ||
                            (report.reporterId && report.reporterId.toLowerCase().includes(searchTerm)) ||
                            (report.reportedUserId && report.reportedUserId.toLowerCase().includes(searchTerm)) ||
                            (report.id && report.id.toLowerCase().includes(searchTerm))
                        );
                    });
                }
                
                // å¦‚æœæ˜¯æŒ‰æª¢èˆ‰äººä¿¡ç”¨æ’åºï¼Œéœ€è¦é¡å¤–è™•ç†
                if (sortBy === 'reporterCredit') {
                    // ç²å–æ‰€æœ‰æª¢èˆ‰äººçš„ä¿¡ç”¨åˆ†æ•¸
                    const reporterIds = [...new Set(filteredReports.map(report => report.reporterId))];
                    const credibilityPromises = reporterIds.map(id => 
                        db.collection('userReportCredibility').doc(id).get()
                    );
                    
                    const credibilityDocs = await Promise.all(credibilityPromises);
                    const creditScores = {};
                    
                    credibilityDocs.forEach(doc => {
                        if (doc.exists) {
                            creditScores[doc.id] = doc.data().score || 100;
                        } else {
                            creditScores[doc.id] = 100; // é è¨­åˆ†æ•¸
                        }
                    });
                    
                    // æ ¹æ“šæª¢èˆ‰äººä¿¡ç”¨åˆ†æ•¸æ’åº
                    filteredReports.sort((a, b) => {
                        const scoreA = creditScores[a.reporterId] || 100;
                        const scoreB = creditScores[b.reporterId] || 100;
                        return scoreA - scoreB; // å¾ä½åˆ°é«˜æ’åº
                    });
                }
                
                // æ‡‰ç”¨åˆ†é 
                const start = (currentPage - 1) * reportsPerPage;
                const paginatedReports = filteredReports.slice(start, start + reportsPerPage);
                
                // éš±è—è¼‰å…¥ä¸­
                document.getElementById('reports-loading').style.display = 'none';
                
                // æª¢æŸ¥æ˜¯å¦æœ‰çµæœ
                if (paginatedReports.length === 0) {
                    reportsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 50px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æª¢èˆ‰è¨˜éŒ„</div>';
                    return;
                }
                
                // æ¸²æŸ“æª¢èˆ‰å¡ç‰‡
                paginatedReports.forEach(report => {
                    const card = createReportCard(report);
                    reportsContainer.appendChild(card);
                });
                
            } catch (error) {
                console.error('åŠ è¼‰æª¢èˆ‰åˆ—è¡¨éŒ¯èª¤:', error);
                document.getElementById('reports-loading').style.display = 'none';
                reportsContainer.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 50px;">åŠ è¼‰æª¢èˆ‰åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }
        
        // å‰µå»ºæª¢èˆ‰å¡ç‰‡
        function createReportCard(report) {
            const card = document.createElement('div');
            card.className = `report-card ${report.status}`;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šæ¬¡æª¢èˆ‰
            if (report.reportCount && report.reportCount > 2) {
                card.classList.add('multiple-reports');
            }
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const createdAt = report.createdAt ? new Date(report.createdAt.toDate()) : new Date();
            const formattedDate = formatDate(createdAt);
            
            // æ§‹å»ºç‹€æ…‹æ¨™ç±¤
            let statusBadge = '';
            switch (report.status) {
                case 'pending':
                    statusBadge = '<span class="status-badge badge-pending">å¾…è™•ç†</span>';
                    break;
                case 'resolved':
                    statusBadge = '<span class="status-badge badge-resolved">å·²è™•ç†</span>';
                    break;
                case 'rejected':
                    statusBadge = '<span class="status-badge badge-rejected">å·²æ‹’çµ•</span>';
                    break;
            }
            
            // æª¢èˆ‰åŸå› 
            const reasons = report.reasons || [];
            const reasonsList = reasons.map(reason => {
                return `<span class="tag">${getReasonText(reason)}</span>`;
            }).join('');
            
            // æª¢èˆ‰äººä¿¡ç”¨åˆ†æ•¸æ¨™è¨˜
            let creditBadge = '';
            if (report.reporterCredit) {
                let creditClass = '';
                if (report.reporterCredit >= 80) {
                    creditClass = 'credit-high';
                } else if (report.reporterCredit >= 50) {
                    creditClass = 'credit-medium';
                } else {
                    creditClass = 'credit-low';
                }
                
                creditBadge = `<span class="credit-score ${creditClass}">ä¿¡ç”¨: ${report.reporterCredit}</span>`;
            }
            
            card.innerHTML = `
                <h3>
                    ${statusBadge}
                    <span style="margin-left: 5px;">${report.reportedUserName || 'æœªçŸ¥ç”¨æˆ¶'}</span>
                    ${creditBadge}
                </h3>
                <p><strong>æª¢èˆ‰äºº:</strong> ${report.reporterName || 'æœªçŸ¥'}</p>
                <p><strong>æäº¤æ™‚é–“:</strong> ${formattedDate}</p>
                <div class="tag-list">
                    ${reasonsList}
                </div>
            `;
            
            // æ·»åŠ é»æ“Šäº‹ä»¶
            card.addEventListener('click', () => {
                showReportDetail(report.id);
            });
            
            return card;
        }
        
        // æ›´æ–°åˆ†é 
        function updatePagination(totalPages) {
            const paginationContainer = document.getElementById('reports-pagination');
            paginationContainer.innerHTML = '';
            
            if (totalPages <= 1) {
                return;
            }
            
            // ä¸Šä¸€é æŒ‰éˆ•
            const prevBtn = document.createElement('div');
            prevBtn.className = 'page-item';
            prevBtn.innerHTML = '<span class="material-icons">chevron_left</span>';
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadReports();
                }
            });
            paginationContainer.appendChild(prevBtn);
            
            // é ç¢¼æŒ‰éˆ•
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('div');
                pageBtn.className = 'page-item';
                pageBtn.textContent = i;
                
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    loadReports();
                });
                
                paginationContainer.appendChild(pageBtn);
            }
            
            // ä¸‹ä¸€é æŒ‰éˆ•
            const nextBtn = document.createElement('div');
            nextBtn.className = 'page-item';
            nextBtn.innerHTML = '<span class="material-icons">chevron_right</span>';
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadReports();
                }
            });
            paginationContainer.appendChild(nextBtn);
        }
        
        // é¡¯ç¤ºæª¢èˆ‰è©³æƒ…
        async function showReportDetail(reportId) {
            currentReportId = reportId;
            
            // åˆ‡æ›è¦–åœ–
            mainContent.style.display = 'none';
            reportDetail.style.display = 'block';
            
            try {
                // ç²å–æª¢èˆ‰æ•¸æ“š
                const reportDoc = await db.collection('reports').doc(reportId).get();
                
                if (!reportDoc.exists) {
                    alert('æ‰¾ä¸åˆ°è©²æª¢èˆ‰è¨˜éŒ„');
                    reportDetail.style.display = 'none';
                    mainContent.style.display = 'block';
                    return;
                }
                
                const reportData = reportDoc.data();
                
                // å¡«å……åŸºæœ¬ä¿¡æ¯
                document.getElementById('report-id').textContent = reportId;
                document.getElementById('report-time').textContent = formatDate(reportData.createdAt.toDate());
                
                // ç‹€æ…‹
                const statusElement = document.getElementById('report-status');
                statusElement.textContent = getStatusText(reportData.status);
                statusElement.className = 'status-badge badge-' + reportData.status;
                
                // è™•ç†äººå“¡
                if (reportData.handledBy) {
                    document.getElementById('report-handler').textContent = reportData.handlerName || reportData.handledBy;
                } else {
                    document.getElementById('report-handler').textContent = 'å°šæœªè™•ç†';
                }
                
                // æª¢èˆ‰åŸå› 
                const reasonsContainer = document.getElementById('report-reasons');
                reasonsContainer.innerHTML = '';
                
                if (reportData.reasons && reportData.reasons.length > 0) {
                    reportData.reasons.forEach(reason => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="material-icons">error</span> ${getReasonText(reason)}`;
                        reasonsContainer.appendChild(li);
                    });
                } else {
                    reasonsContainer.innerHTML = '<li>æ²’æœ‰æŒ‡å®šåŸå› </li>';
                }
                
                // è©³ç´°æè¿°
                document.getElementById('report-detail-text').textContent = reportData.detail || 'ç„¡è©³ç´°æè¿°';
                
                // è­‰æ“šåœ–ç‰‡
                const evidenceContainer = document.getElementById('evidence-container');
                evidenceContainer.innerHTML = '';
                
                if (reportData.imageUrls && reportData.imageUrls.length > 0) {
                    reportData.imageUrls.forEach((url, index) => {
                        const evidenceItem = document.createElement('div');
                        evidenceItem.className = 'evidence-item';
                        evidenceItem.innerHTML = `
                            <img src="${url}" alt="è­‰æ“š ${index+1}">
                            <div class="view-full">æŸ¥çœ‹åŸåœ–</div>
                        `;
                        
                        // æŸ¥çœ‹åŸåœ–
                        evidenceItem.querySelector('.view-full').addEventListener('click', () => {
                            document.getElementById('lightboxImage').src = url;
                            document.getElementById('imageLightbox').style.display = 'flex';
                        });
                        
                        evidenceContainer.appendChild(evidenceItem);
                    });
                } else {
                    evidenceContainer.innerHTML = '<p>æ²’æœ‰ä¸Šå‚³è­‰æ“šåœ–ç‰‡</p>';
                }
                
                // åŠ è¼‰æª¢èˆ‰äººè³‡æ–™
                if (reportData.reporterId) {
                    loadUserProfile(reportData.reporterId, 'reporter');
                }
                
                // åŠ è¼‰è¢«æª¢èˆ‰äººè³‡æ–™
                if (reportData.reportedUserId) {
                    loadUserProfile(reportData.reportedUserId, 'reported');
                    loadPunishmentHistory(reportData.reportedUserId);
                }
                
            } catch (error) {
                console.error('é¡¯ç¤ºæª¢èˆ‰è©³æƒ…éŒ¯èª¤:', error);
                alert('è¼‰å…¥æª¢èˆ‰è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                reportDetail.style.display = 'none';
                mainContent.style.display = 'block';
            }
        }
        
        // åŠ è¼‰ç”¨æˆ¶è³‡æ–™
        async function loadUserProfile(userId, type) {
            try {
                const userDoc = await db.collection('userprofileData').doc(userId).get();
                
                if (!userDoc.exists) {
                    document.getElementById(`${type}-name`).textContent = 'æ‰¾ä¸åˆ°ç”¨æˆ¶è³‡æ–™';
                    document.getElementById(`${type}-id`).textContent = `ID: ${userId}`;
                    return;
                }
                
                const userData = userDoc.data();
                
                // è¨­ç½®ç”¨æˆ¶åç¨±å’ŒID
                document.getElementById(`${type}-name`).textContent = userData.name || 'æœªè¨­å®šåç¨±';
                document.getElementById(`${type}-id`).textContent = `ID: ${userId}`;
                
                // è¨­ç½®é ­åƒ
                if (userData.photoUrls && userData.photoUrls.length > 0) {
                    let photoUrl;
                    if (userData.photoOrder && userData.photoOrder.length > 0) {
                        const mainPhotoIndex = userData.photoOrder[0];
                        photoUrl = userData.photoUrls[mainPhotoIndex];
                    } else {
                        photoUrl = userData.photoUrls[0];
                    }
                    document.getElementById(`${type}-avatar`).src = photoUrl;
                } else {
                    document.getElementById(`${type}-avatar`).src = 'https://via.placeholder.com/60?text=ç„¡ç…§ç‰‡';
                }
                
                // å¦‚æœæ˜¯æª¢èˆ‰äººï¼ŒåŠ è¼‰æª¢èˆ‰ä¿¡ç”¨åˆ†æ•¸
                if (type === 'reporter') {
                    loadReporterCredibility(userId);
                }
                
                // åŠ è¼‰æª¢èˆ‰æ­·å²
                await loadReportHistory(userId, type);
                
            } catch (error) {
                console.error(`åŠ è¼‰${type}è³‡æ–™éŒ¯èª¤:`, error);
                document.getElementById(`${type}-name`).textContent = 'è¼‰å…¥å¤±æ•—';
                document.getElementById(`${type}-id`).textContent = `ID: ${userId}`;
            }
        }
        
        // åŠ è¼‰æª¢èˆ‰äººä¿¡ç”¨åˆ†æ•¸
        async function loadReporterCredibility(userId) {
            try {
                const credibilityDoc = await db.collection('userReportCredibility').doc(userId).get();
                const creditElement = document.getElementById('reporter-credit');
                
                if (credibilityDoc.exists) {
                    const data = credibilityDoc.data();
                    const score = data.score || 100;
                    
                    // è¨­ç½®ä¿¡ç”¨åˆ†æ•¸çš„é¡è‰²
                    let creditClass = '';
                    if (score >= 80) {
                        creditClass = 'credit-high';
                    } else if (score >= 50) {
                        creditClass = 'credit-medium';
                    } else {
                        creditClass = 'credit-low';
                    }
                    
                    creditElement.textContent = `ä¿¡ç”¨åˆ†æ•¸: ${score}`;
                    creditElement.className = `credit-score ${creditClass}`;
                } else {
                    // æ²’æœ‰è¨˜éŒ„æ™‚çš„é è¨­å€¼
                    creditElement.textContent = 'ä¿¡ç”¨åˆ†æ•¸: 100';
                    creditElement.className = 'credit-score credit-high';
                }
            } catch (error) {
                console.error('åŠ è¼‰æª¢èˆ‰äººä¿¡ç”¨åˆ†æ•¸éŒ¯èª¤:', error);
                document.getElementById('reporter-credit').textContent = 'ä¿¡ç”¨åˆ†æ•¸: --';
            }
        }
        
        // åŠ è¼‰è™•ç½°æ­·å²
        async function loadPunishmentHistory(userId) {
            try {
                const historyContainer = document.getElementById('punishment-history');
                historyContainer.innerHTML = '';
                
                const reportsSnapshot = await db.collection('reports')
                    .where('reportedUserId', '==', userId)
                    .where('status', '==', 'resolved')
                    .orderBy('handledAt', 'desc')
                    .limit(5)
                    .get();
                
                if (reportsSnapshot.empty) {
                    historyContainer.innerHTML = '<li>ç„¡è™•ç½°è¨˜éŒ„</li>';
                    return;
                }
                
                reportsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.punishment) {
                        const handledAt = data.handledAt ? formatDate(data.handledAt.toDate()) : 'æœªçŸ¥æ™‚é–“';
                        const li = document.createElement('li');
                        
                        let punishmentText = '';
                        switch (data.punishment.type) {
                            case 'warning':
                                punishmentText = 'ç™¼å‡ºè­¦å‘Š';
                                break;
                            case 'restrict':
                                punishmentText = `é™åˆ¶${getRestrictionTypeText(data.punishment.restrictType)}åŠŸèƒ½ ${data.punishment.duration} å¤©`;
                                break;
                            case 'suspend':
                                punishmentText = `æš«åœå¸³è™Ÿ ${data.punishment.duration} å¤©`;
                                break;
                            case 'ban':
                                punishmentText = 'æ°¸ä¹…å°ç¦å¸³è™Ÿ';
                                break;
                        }
                        
                        li.innerHTML = `${handledAt}: ${punishmentText}`;
                        historyContainer.appendChild(li);
                    }
                });
                
            } catch (error) {
                console.error('åŠ è¼‰è™•ç½°æ­·å²éŒ¯èª¤:', error);
                document.getElementById('punishment-history').innerHTML = '<li>è¼‰å…¥å¤±æ•—</li>';
            }
        }
        
        // åŠ è¼‰æª¢èˆ‰æ­·å²
        async function loadReportHistory(userId, type) {
            try {
                let query;
                
                // ä¾æ“šé¡å‹é¸æ“‡æŸ¥è©¢æ–¹å¼
                if (type === 'reporter') {
                    // ä½œç‚ºæª¢èˆ‰äººçš„æ­·å²
                    query = db.collection('reports')
                        .where('reporterId', '==', userId)
                        .where('status', 'in', ['resolved', 'rejected']);
                } else {
                    // ä½œç‚ºè¢«æª¢èˆ‰äººçš„æ­·å²
                    query = db.collection('reports')
                        .where('reportedUserId', '==', userId);
                }
                
                const snapshot = await query.get();
                
                // çµ±è¨ˆæœ‰æ•ˆå’Œç„¡æ•ˆæª¢èˆ‰
                let validCount = 0;
                let invalidCount = 0;
                let pendingCount = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'resolved') {
                        validCount++;
                    } else if (data.status === 'rejected') {
                        invalidCount++;
                    } else if (data.status === 'pending') {
                        pendingCount++;
                    }
                });
                
                // é¡¯ç¤ºçµ±è¨ˆçµæœ
                const totalCount = validCount + invalidCount + pendingCount;
                const historyText = type === 'reporter'
                    ? `${totalCount}æ¬¡ (${validCount}æ¬¡æœ‰æ•ˆ)`
                    : `${totalCount}æ¬¡ (${validCount}æ¬¡æˆç«‹, ${pendingCount}æ¬¡å¾…è™•ç†)`;
                
                document.getElementById(`${type}-history`).textContent = historyText;
                
                // æª¢æŸ¥ç”¨æˆ¶ç‹€æ…‹
                const statusElement = document.getElementById(`${type}-status`);
                
                const userDoc = await db.collection('userStatus').doc(userId).get();
                if (userDoc.exists) {
                    const statusData = userDoc.data();
                    
                    if (statusData.isBanned) {
                        statusElement.textContent = 'å·²å°ç¦';
                        statusElement.className = 'status-badge badge-danger';
                    } else if (statusData.isSuspended) {
                        statusElement.textContent = 'å·²æš«åœ';
                        statusElement.className = 'status-badge badge-warning';
                    } else if (statusData.restrictions && Object.keys(statusData.restrictions).length > 0) {
                        statusElement.textContent = 'åŠŸèƒ½å—é™';
                        statusElement.className = 'status-badge badge-warning';
                    } else {
                        statusElement.textContent = 'æ­£å¸¸';
                    }
                } else {
                    statusElement.textContent = 'æ­£å¸¸';
                }
                
            } catch (error) {
                console.error(`åŠ è¼‰${type}æª¢èˆ‰æ­·å²éŒ¯èª¤:`, error);
                document.getElementById(`${type}-history`).textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }
        
        // è™•ç†æª¢èˆ‰è¡Œå‹•
        async function handleReportAction() {
            if (!currentReportId) return;
            
            // ç²å–é¸æ“‡çš„è¡Œå‹•
            const actionType = document.querySelector('input[name="action"]:checked').value;
            const actionNote = document.getElementById('actionNote').value.trim();
            
            if (!actionType) {
                alert('è«‹é¸æ“‡è™•ç†æ–¹å¼');
                return;
            }
            
            try {
                const actionButton = document.getElementById('submitAction');
                actionButton.innerHTML = '<div class="loading-spinner"></div> è™•ç†ä¸­...';
                actionButton.disabled = true;
                
                // ç²å–æª¢èˆ‰è³‡æ–™
                const reportDoc = await db.collection('reports').doc(currentReportId).get();
                
                if (!reportDoc.exists) {
                    throw new Error('æ‰¾ä¸åˆ°æª¢èˆ‰è¨˜éŒ„');
                }
                
                const reportData = reportDoc.data();
                const reportedUserId = reportData.reportedUserId;
                
                // æº–å‚™æ›´æ–°æª¢èˆ‰ç‹€æ…‹
                const updateData = {
                    status: actionType === 'ignore' ? 'rejected' : 'resolved',
                    handledBy: auth.currentUser.uid,
                    handlerName: auth.currentUser.email,
                    handledAt: firebase.firestore.FieldValue.serverTimestamp(),
                    actionType: actionType,
                    actionNote: actionNote || null
                };
                
                // å¦‚æœé¸æ“‡æ‡²ç½°ï¼Œæ·»åŠ ç›¸é—œæ•¸æ“š
                if (actionType === 'restrict') {
                    const restrictType = document.getElementById('restrictType').value;
                    const restrictDays = parseInt(document.getElementById('restrictDays').value);
                    
                    updateData.punishment = {
                        type: 'restrict',
                        restrictType: restrictType,
                        duration: restrictDays,
                        expireAt: new Date(Date.now() + restrictDays * 24 * 60 * 60 * 1000)
                    };
                    
                    // åŒæ™‚æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                    await applyUserRestriction(reportedUserId, restrictType, restrictDays);
                    
                } else if (actionType === 'suspend') {
                    const suspendDays = parseInt(document.getElementById('suspendDays').value);
                    
                    updateData.punishment = {
                        type: 'suspend',
                        duration: suspendDays,
                        expireAt: new Date(Date.now() + suspendDays * 24 * 60 * 60 * 1000)
                    };
                    
                    // åŒæ™‚æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                    await suspendUser(reportedUserId, suspendDays);
                    
                } else if (actionType === 'ban') {
                    updateData.punishment = {
                        type: 'ban',
                        permanent: true
                    };
                    
                    // åŒæ™‚æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                    await banUser(reportedUserId);
                    
                } else if (actionType === 'warning') {
                    updateData.punishment = {
                        type: 'warning',
                        warningCount: firebase.firestore.FieldValue.increment(1)
                    };
                    
                    // åŒæ™‚æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                    await warnUser(reportedUserId, reportData.reasons);
                }
                
                // æ›´æ–°æª¢èˆ‰è¨˜éŒ„
                await db.collection('reports').doc(currentReportId).update(updateData);
                
                // æ›´æ–°æª¢èˆ‰äººçš„æª¢èˆ‰ä¿¡ç”¨åˆ†æ•¸
                if (reportData.reporterId) {
                    await updateReporterCredibility(
                        reportData.reporterId, 
                        actionType === 'ignore' ? -5 : 10
                    );
                }
                
                // è™•ç†ç›¸åŒè¢«æª¢èˆ‰è€…çš„å…¶ä»–æª¢èˆ‰
                if (actionType !== 'ignore' && reportData.reportedUserId) {
                    await handleRelatedReports(reportData.reportedUserId);
                }
                
                // é‡ç½®
                actionButton.textContent = 'ç¢ºèªè™•ç†';
                actionButton.disabled = false;
                
                alert('æª¢èˆ‰è™•ç†å®Œæˆ');
                
                // è¿”å›åˆ—è¡¨ä¸¦é‡æ–°åŠ è¼‰
                reportDetail.style.display = 'none';
                mainContent.style.display = 'block';
                loadReports();
                checkFrequentReports(); // æ›´æ–°é‡è¤‡æª¢èˆ‰æ•¸æ“š
                
            } catch (error) {
                console.error('è™•ç†æª¢èˆ‰æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('è™•ç†æª¢èˆ‰æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                
                const actionButton = document.getElementById('submitAction');
                actionButton.textContent = 'ç¢ºèªè™•ç†';
                actionButton.disabled = false;
            }
        }
        
        // è™•ç†ç›¸é—œæª¢èˆ‰ - ç•¶ç”¨æˆ¶è¢«è™•ç½°æ™‚ï¼Œå¯ä»¥è‡ªå‹•è™•ç†å…¶ä»–é‡å°è©²ç”¨æˆ¶çš„æª¢èˆ‰
        async function handleRelatedReports(userId) {
            try {
                // ç²å–è©²ç”¨æˆ¶çš„æ‰€æœ‰å¾…è™•ç†æª¢èˆ‰
                const relatedReportsSnapshot = await db.collection('reports')
                    .where('reportedUserId', '==', userId)
                    .where('status', '==', 'pending')
                    .get();
                
                if (relatedReportsSnapshot.empty) {
                    return; // æ²’æœ‰å…¶ä»–å¾…è™•ç†æª¢èˆ‰
                }
                
                // è©¢å•ç®¡ç†å“¡æ˜¯å¦è¦ä¸€ä½µè™•ç†
                const confirmHandle = confirm(`ç™¼ç¾è©²ç”¨æˆ¶æœ‰${relatedReportsSnapshot.size}å€‹å…¶ä»–å¾…è™•ç†æª¢èˆ‰ï¼Œæ˜¯å¦ä¸€ä½µæ¨™è¨˜ç‚ºå·²è™•ç†ï¼Ÿ`);
                
                if (!confirmHandle) {
                    return; // ç®¡ç†å“¡é¸æ“‡ä¸è™•ç†
                }
                
                // æ‰¹é‡è™•ç†å…¶ä»–æª¢èˆ‰
                const batch = db.batch();
                
                relatedReportsSnapshot.forEach(doc => {
                    batch.update(doc.ref, {
                        status: 'resolved',
                        handledBy: auth.currentUser.uid,
                        handlerName: auth.currentUser.email,
                        handledAt: firebase.firestore.FieldValue.serverTimestamp(),
                        actionType: 'auto_resolved',
                        actionNote: 'ç”¨æˆ¶å·²å› å…¶ä»–æª¢èˆ‰å—åˆ°è™•ç½°ï¼Œè‡ªå‹•è™•ç†'
                    });
                });
                
                await batch.commit();
                
                // æ›´æ–°ä¿¡ç”¨åˆ†æ•¸
                const docData = relatedReportsSnapshot.docs.map(doc => doc.data());
                const reporterIds = [...new Set(docData.map(data => data.reporterId))];
                
                for (const reporterId of reporterIds) {
                    if (reporterId) {
                        await updateReporterCredibility(reporterId, 5); // çµ¦äºˆè¼ƒå°‘çš„åŠ åˆ†
                    }
                }
                
            } catch (error) {
                console.error('è™•ç†ç›¸é—œæª¢èˆ‰æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œä»¥å…å½±éŸ¿ä¸»è¦æµç¨‹
            }
        }
        
        // æ›´æ–°æª¢èˆ‰äººçš„ä¿¡ç”¨åˆ†æ•¸
        async function updateReporterCredibility(userId, points) {
            try {
                // ç²å–ç”¨æˆ¶æª¢èˆ‰ä¿¡ç”¨ç´€éŒ„
                const credibilityRef = db.collection('userReportCredibility').doc(userId);
                const doc = await credibilityRef.get();
                
                if (doc.exists) {
                    // ç¾æœ‰è¨˜éŒ„ï¼Œæ›´æ–°åˆ†æ•¸
                    await credibilityRef.update({
                        score: firebase.firestore.FieldValue.increment(points),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        [points > 0 ? 'validReports' : 'invalidReports']: firebase.firestore.FieldValue.increment(1),
                        reportCount: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    // æ–°ç´€éŒ„ï¼Œåˆå§‹åŒ–
                    await credibilityRef.set({
                        userId: userId,
                        score: 100 + points, // åŸºç¤åˆ†æ•¸ 100
                        reportCount: 1,
                        validReports: points > 0 ? 1 : 0,
                        invalidReports: points < 0 ? 1 : 0,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦é™åˆ¶æª¢èˆ‰åŠŸèƒ½
                if (points < 0) {
                    const updatedDoc = await credibilityRef.get();
                    const score = updatedDoc.data().score;
                    
                    // ç²å–ç³»çµ±è¨­ç½®
                    const settingsDoc = await db.collection('systemSettings').doc('reportManagement').get();
                    const settings = settingsDoc.exists ? settingsDoc.data() : {};
                    const threshold = settings.automation?.creditThreshold || 40;
                    
                    // å¦‚æœåˆ†æ•¸ä½æ–¼é–¾å€¼ï¼Œé™åˆ¶æª¢èˆ‰åŠŸèƒ½
                    if (score < threshold) {
                        await applyReportRestriction(userId);
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°æª¢èˆ‰äººä¿¡ç”¨åˆ†æ•¸éŒ¯èª¤:', error);
                // é€™è£¡çš„éŒ¯èª¤ä¸æ‡‰è©²å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œæ‰€ä»¥åªè¨˜éŒ„ä¸æ‹‹å‡º
            }
        }
        
        // é™åˆ¶æª¢èˆ‰åŠŸèƒ½
        async function applyReportRestriction(userId) {
            try {
                // ç²å–ç³»çµ±è¨­ç½®
                const settingsDoc = await db.collection('systemSettings').doc('reportManagement').get();
                const settings = settingsDoc.exists ? settingsDoc.data() : {};
                const penaltyType = settings.reportRules?.falseReportPenalty || 'limit';
                const days = settings.reportRules?.defaultPunishDays || 7;
                
                if (penaltyType === 'none') {
                    return; // ä¸è™•ç½°
                }
                
                // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                const userStatusRef = db.collection('userStatus').doc(userId);
                const expireAt = new Date(Date.now() + days * 24 * 60 * 60 * 1000);
                
                await userStatusRef.set({
                    userId: userId,
                    restrictions: {
                        report: {
                            active: true,
                            expireAt: expireAt,
                            reason: 'low_credit_score',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    },
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // ç™¼é€é€šçŸ¥
                await db.collection('notifications').add({
                    userId: userId,
                    type: 'report_restriction',
                    message: 'ç”±æ–¼å¤šæ¬¡æäº¤ç„¡æ•ˆæª¢èˆ‰ï¼Œæ‚¨çš„æª¢èˆ‰åŠŸèƒ½å·²è¢«é™åˆ¶ä½¿ç”¨ï¼Œè«‹ç¢ºä¿æª¢èˆ‰å…§å®¹çœŸå¯¦æœ‰æ•ˆã€‚',
                    data: {
                        expireAt: expireAt
                    },
                    isRead: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('é™åˆ¶æª¢èˆ‰åŠŸèƒ½éŒ¯èª¤:', error);
                // ä¸æ‹‹å‡ºéŒ¯èª¤
            }
        }
        
        // é™åˆ¶ç”¨æˆ¶åŠŸèƒ½
        async function applyUserRestriction(userId, restrictType, days) {
            try {
                const expireAt = new Date(Date.now() + days * 24 * 60 * 60 * 1000);
                
                // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                const userStatusRef = db.collection('userStatus').doc(userId);
                const doc = await userStatusRef.get();
                
                if (doc.exists) {
                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                    await userStatusRef.update({
                        [`restrictions.${restrictType}`]: {
                            active: true,
                            expireAt: expireAt,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        },
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // å‰µå»ºæ–°è¨˜éŒ„
                    await userStatusRef.set({
                        userId: userId,
                        isBanned: false,
                        restrictions: {
                            [restrictType]: {
                                active: true,
                                expireAt: expireAt,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }
                        },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
                await sendUserNotification(userId, 'restriction', {
                    restrictType: restrictType,
                    duration: days
                });
                
            } catch (error) {
                console.error('é™åˆ¶ç”¨æˆ¶åŠŸèƒ½éŒ¯èª¤:', error);
                throw error;
            }
        }
        
        // æš«åœç”¨æˆ¶å¸³è™Ÿ
        async function suspendUser(userId, days) {
            try {
                const expireAt = new Date(Date.now() + days * 24 * 60 * 60 * 1000);
                
                // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                const userStatusRef = db.collection('userStatus').doc(userId);
                await userStatusRef.set({
                    userId: userId,
                    isSuspended: true,
                    suspendExpireAt: expireAt,
                    suspendedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    suspendReason: 'violation',
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
                await sendUserNotification(userId, 'suspension', {
                    duration: days
                });
                
            } catch (error) {
                console.error('æš«åœç”¨æˆ¶å¸³è™ŸéŒ¯èª¤:', error);
                throw error;
            }
        }
        
        // æ°¸ä¹…å°ç¦ç”¨æˆ¶
        async function banUser(userId) {
            try {
                // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                const userStatusRef = db.collection('userStatus').doc(userId);
                await userStatusRef.set({
                    userId: userId,
                    isBanned: true,
                    bannedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    banReason: 'severe_violation',
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                // ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
                await sendUserNotification(userId, 'ban', {});
                
            } catch (error) {
                console.error('å°ç¦ç”¨æˆ¶éŒ¯èª¤:', error);
                throw error;
            }
        }
        
        // è­¦å‘Šç”¨æˆ¶
        async function warnUser(userId, reasons) {
            try {
                // æ›´æ–°ç”¨æˆ¶è­¦å‘Šè¨ˆæ•¸
                const userStatusRef = db.collection('userStatus').doc(userId);
                const doc = await userStatusRef.get();
                
                if (doc.exists) {
                    await userStatusRef.update({
                        warningCount: firebase.firestore.FieldValue.increment(1),
                        lastWarningAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await userStatusRef.set({
                        userId: userId,
                        warningCount: 1,
                        lastWarningAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
                await sendUserNotification(userId, 'warning', {
                    reasons: reasons
                });
                
            } catch (error) {
                console.error('è­¦å‘Šç”¨æˆ¶éŒ¯èª¤:', error);
                throw error;
            }
        }
        
        // ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
        async function sendUserNotification(userId, type, data) {
            try {
                // æ ¹æ“šé€šçŸ¥é¡å‹ç²å–æ¨¡æ¿
                let message = '';
                
                switch (type) {
                    case 'warning':
                        message = document.getElementById('warningTemplate').value;
                        message = message.replace('{reason}', data.reasons ? data.reasons.map(r => getReasonText(r)).join('ã€') : 'é•åç¤¾å€è¦ç¯„');
                        break;
                    case 'restriction':
                        message = `æ‚¨çš„å¸³è™Ÿå› é•åç¤¾å€è¦ç¯„ï¼Œ${getRestrictionTypeText(data.restrictType)}åŠŸèƒ½å·²è¢«é™åˆ¶${data.duration}å¤©ã€‚`;
                        break;
                    case 'suspension':
                        message = document.getElementById('suspensionTemplate').value;
                        message = message.replace('{reason}', 'é•åç¤¾å€è¦ç¯„').replace('{days}', data.duration);
                        break;
                    case 'ban':
                        message = 'æ‚¨çš„å¸³è™Ÿå› åš´é‡é•åç¤¾å€è¦ç¯„å·²è¢«æ°¸ä¹…å°ç¦ã€‚';
                        break;
                }
                
                // å‰µå»ºé€šçŸ¥
                await db.collection('notifications').add({
                    userId: userId,
                    type: type,
                    message: message,
                    data: data,
                    isRead: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('ç™¼é€é€šçŸ¥éŒ¯èª¤:', error);
                // é€™è£¡çš„éŒ¯èª¤ä¸æ‡‰è©²å½±éŸ¿ä¸»è¦æµç¨‹ï¼Œæ‰€ä»¥åªè¨˜éŒ„ä¸æ‹‹å‡º
            }
        }
        
        // æª¢æŸ¥é‡è¤‡æª¢èˆ‰æƒ…æ³
        async function checkFrequentReports() {
            try {
                // ç²å–æ‰€æœ‰å¾…è™•ç†æª¢èˆ‰
                const pendingReportsSnapshot = await db.collection('reports')
                    .where('status', '==', 'pending')
                    .get();
                
                if (pendingReportsSnapshot.empty) {
                    document.querySelector('.tab[data-tab="frequentReports"]').setAttribute('data-count', '0');
                    return;
                }
                
                // çµ±è¨ˆæ¯å€‹è¢«æª¢èˆ‰ç”¨æˆ¶çš„æª¢èˆ‰æ•¸é‡
                const reportCounts = {};
                
                pendingReportsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.reportedUserId) {
                        reportCounts[data.reportedUserId] = (reportCounts[data.reportedUserId] || 0) + 1;
                    }
                });
                
                // ç¯©é¸å‡ºè¢«å¤šæ¬¡æª¢èˆ‰çš„ç”¨æˆ¶
                const multiReportedUsers = Object.keys(reportCounts).filter(userId => 
                    reportCounts[userId] >= 3  // å¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´é–¾å€¼
                );
                
                // æ›´æ–°æ¨™ç±¤é å¾½ç« æ•¸å­—
                document.querySelector('.tab[data-tab="frequentReports"]').setAttribute('data-count', multiReportedUsers.length.toString());
                
                // å¦‚æœæœ‰å¤šæ¬¡æª¢èˆ‰çš„ç”¨æˆ¶ï¼Œæ·»åŠ è¦–è¦ºæç¤º
                if (multiReportedUsers.length > 0) {
                    document.querySelector('.tab[data-tab="frequentReports"]').classList.add('notification-badge');
                } else {
                    document.querySelector('.tab[data-tab="frequentReports"]').classList.remove('notification-badge');
                }
                
            } catch (error) {
                console.error('æª¢æŸ¥é‡è¤‡æª¢èˆ‰éŒ¯èª¤:', error);
                // ä¸å½±éŸ¿ä¸»è¦æµç¨‹
            }
        }
        
        // åŠ è¼‰é‡è¤‡æª¢èˆ‰æ¨™ç±¤é 
        async function loadFrequentReports() {
            const container = document.getElementById('frequent-reports-container');
            const loadingElement = document.getElementById('frequent-loading');
            
            container.innerHTML = '';
            loadingElement.style.display = 'flex';
            
            try {
                // ç²å–æ‰€æœ‰å¾…è™•ç†æª¢èˆ‰
                const pendingReportsSnapshot = await db.collection('reports')
                    .where('status', '==', 'pending')
                    .get();
                
                if (pendingReportsSnapshot.empty) {
                    loadingElement.style.display = 'none';
                    container.innerHTML = '<div style="text-align: center; padding: 30px;">æ²’æœ‰å¾…è™•ç†æª¢èˆ‰</div>';
                    return;
                }
                
                // çµ±è¨ˆæ¯å€‹è¢«æª¢èˆ‰ç”¨æˆ¶çš„æª¢èˆ‰æ•¸é‡å’Œæª¢èˆ‰
                const reportCounts = {};
                const userReports = {};
                
                pendingReportsSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    if (data.reportedUserId) {
                        reportCounts[data.reportedUserId] = (reportCounts[data.reportedUserId] || 0) + 1;
                        
                        if (!userReports[data.reportedUserId]) {
                            userReports[data.reportedUserId] = [];
                        }
                        userReports[data.reportedUserId].push(data);
                    }
                });
                
                // ç¯©é¸å‡ºè¢«å¤šæ¬¡æª¢èˆ‰çš„ç”¨æˆ¶
                const multiReportedUsers = Object.keys(reportCounts).filter(userId => 
                    reportCounts[userId] >= 3  // å¯ä»¥æ ¹æ“šéœ€è¦èª¿æ•´é–¾å€¼
                );
                
                loadingElement.style.display = 'none';
                
                if (multiReportedUsers.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;">æ²’æœ‰è¢«å¤šæ¬¡æª¢èˆ‰çš„ç”¨æˆ¶</div>';
                    return;
                }
                
                // ç‚ºæ¯å€‹å¤šæ¬¡è¢«æª¢èˆ‰çš„ç”¨æˆ¶å‰µå»ºå¡ç‰‡
                for (const userId of multiReportedUsers) {
                    const reports = userReports[userId];
                    const reportCount = reportCounts[userId];
                    
                    // ç²å–ç”¨æˆ¶ä¿¡æ¯
                    const userDoc = await db.collection('userStatus').doc(userId).get();
                    const userData = userDoc.exists ? userDoc.data() : null;
                    const userName = userData ? (userData.name || 'æœªçŸ¥ç”¨æˆ¶') : 'æœªçŸ¥ç”¨æˆ¶';
                    
                    // å‰µå»ºç”¨æˆ¶å¡ç‰‡
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.marginBottom = '20px';
                    
                    // æ”¶é›†æ‰€æœ‰æª¢èˆ‰åŸå› 
                    const allReasons = new Set();
                    reports.forEach(report => {
                        if (report.reasons && report.reasons.length > 0) {
                            report.reasons.forEach(reason => allReasons.add(reason));
                        }
                    });
                    
                    const reasonTags = Array.from(allReasons).map(reason => 
                        `<span class="tag">${getReasonText(reason)}</span>`
                    ).join('');
                    
                    card.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>${userName}</h3>
                            <span class="status-badge badge-warning">è¢«æª¢èˆ‰ ${reportCount} æ¬¡</span>
                        </div>
                        <p><strong>æª¢èˆ‰åŸå› :</strong></p>
                        <div class="tag-list">${reasonTags}</div>
                        <div style="margin-top: 15px;">
                            <button class="btn-primary view-reports" data-id="${userId}">æŸ¥çœ‹æ‰€æœ‰æª¢èˆ‰</button>
                            <button class="btn-danger handle-all" data-id="${userId}">æ‰¹é‡è™•ç†</button>
                        </div>
                    `;
                    
                    // æ·»åŠ æŸ¥çœ‹æ‰€æœ‰æª¢èˆ‰äº‹ä»¶
                    card.querySelector('.view-reports').addEventListener('click', () => {
                        showUserReports(userId, reports);
                    });
                    
                    // æ·»åŠ æ‰¹é‡è™•ç†äº‹ä»¶
                    card.querySelector('.handle-all').addEventListener('click', () => {
                        batchHandleReports(userId, reports);
                    });
                    
                    container.appendChild(card);
                }
                
            } catch (error) {
                console.error('åŠ è¼‰é‡è¤‡æª¢èˆ‰éŒ¯èª¤:', error);
                loadingElement.style.display = 'none';
                container.innerHTML = `<div style="text-align: center; padding: 30px;">åŠ è¼‰è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }
        
        // é¡¯ç¤ºç”¨æˆ¶æ‰€æœ‰æª¢èˆ‰
        function showUserReports(userId, reports) {
            // å‰µå»ºä¸€å€‹æ¨¡æ…‹å°è©±æ¡†ä¾†é¡¯ç¤ºæ‰€æœ‰æª¢èˆ‰
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';
            
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '12px';
            dialog.style.padding = '20px';
            dialog.style.maxWidth = '800px';
            dialog.style.width = '90%';
            dialog.style.maxHeight = '80vh';
            dialog.style.overflowY = 'auto';
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>ç”¨æˆ¶æª¢èˆ‰åˆ—è¡¨</h2>
                    <button id="close-modal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <div id="reports-list"></div>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // å¡«å……æª¢èˆ‰åˆ—è¡¨
            const reportsList = document.getElementById('reports-list');
            
            reports.forEach(report => {
                const createdAt = report.createdAt ? formatDate(report.createdAt.toDate()) : 'æœªçŸ¥æ™‚é–“';
                const reasons = report.reasons ? report.reasons.map(r => getReasonText(r)).join('ã€') : 'æœªæŒ‡å®š';
                
                const reportItem = document.createElement('div');
                reportItem.style.borderBottom = '1px solid #eee';
                reportItem.style.padding = '15px 0';
                
                reportItem.innerHTML = `
                    <p><strong>æª¢èˆ‰äºº:</strong> ${report.reporterName || 'æœªçŸ¥'}</p>
                    <p><strong>æ™‚é–“:</strong> ${createdAt}</p>
                    <p><strong>åŸå› :</strong> ${reasons}</p>
                    <p><strong>è©³ç´°æè¿°:</strong> ${report.detail || 'ç„¡'}</p>
                    <button class="btn-primary view-detail" data-id="${report.id}">æŸ¥çœ‹è©³æƒ…</button>
                `;
                
                // æ·»åŠ æŸ¥çœ‹è©³æƒ…äº‹ä»¶
                reportItem.querySelector('.view-detail').addEventListener('click', () => {
                    document.body.removeChild(modal);
                    showReportDetail(report.id);
                });
                
                reportsList.appendChild(reportItem);
            });
        }
        
        // æ‰¹é‡è™•ç†æª¢èˆ‰
        async function batchHandleReports(userId, reports) {
            if (reports.length === 0) return;
            
            // å‰µå»ºé¸æ“‡è™•ç†æ–¹å¼çš„å°è©±æ¡†
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';
            
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '12px';
            dialog.style.padding = '20px';
            dialog.style.maxWidth = '500px';
            dialog.style.width = '90%';
            
            dialog.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>æ‰¹é‡è™•ç†æª¢èˆ‰</h2>
                    <button id="close-batch-modal" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                </div>
                <p>æ‚¨æ­£åœ¨è™•ç† <strong>${reports.length}</strong> å€‹é‡å°åŒä¸€ç”¨æˆ¶çš„æª¢èˆ‰ã€‚</p>
                <form id="batch-form">
                    <div class="punishment-options">
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="batchAction" value="warning" checked>
                                ç™¼å‡ºè­¦å‘Š
                            </label>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="batchAction" value="restrict">
                                åŠŸèƒ½é™åˆ¶
                            </label>
                            <div style="margin-left: 25px; margin-top: 10px;">
                                <select id="batchRestrictType">
                                    <option value="chat">èŠå¤©åŠŸèƒ½</option>
                                    <option value="match">é…å°åŠŸèƒ½</option>
                                    <option value="photo">ä¸Šå‚³ç…§ç‰‡</option>
                                    <option value="all">æ‰€æœ‰åŠŸèƒ½</option>
                                </select>
                                <input type="number" id="batchRestrictDays" min="1" max="30" value="7" style="width: 60px; margin-left: 10px;"> å¤©
                            </div>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="batchAction" value="suspend">
                                æš«åœå¸³è™Ÿ
                            </label>
                            <div style="margin-left: 25px; margin-top: 10px;">
                                <input type="number" id="batchSuspendDays" min="1" max="90" value="30" style="width: 60px;"> å¤©
                            </div>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="batchAction" value="ban">
                                æ°¸ä¹…å°ç¦
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label for="batchActionNote">è™•ç†å‚™è¨» (åƒ…ç®¡ç†å“¡å¯è¦‹):</label>
                        <textarea id="batchActionNote" rows="3" style="width: 100%; margin-top: 10px;"></textarea>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                        <button type="button" id="cancel-batch" class="btn-danger">å–æ¶ˆ</button>
                        <button type="button" id="confirm-batch" class="btn-success">ç¢ºèªè™•ç†</button>
                    </div>
                </form>
            `;
            
            modal.appendChild(dialog);
            document.body.appendChild(modal);
            
            // é—œé–‰æŒ‰éˆ•äº‹ä»¶
            document.getElementById('close-batch-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            document.getElementById('cancel-batch').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // æäº¤è™•ç†
            document.getElementById('confirm-batch').addEventListener('click', async () => {
                const actionType = document.querySelector('input[name="batchAction"]:checked').value;
                const actionNote = document.getElementById('batchActionNote').value.trim();
                
                if (!actionType) {
                    alert('è«‹é¸æ“‡è™•ç†æ–¹å¼');
                    return;
                }
                
                try {
                    // é¡¯ç¤ºè™•ç†ä¸­
                    document.getElementById('confirm-batch').disabled = true;
                    document.getElementById('confirm-batch').textContent = 'è™•ç†ä¸­...';
                    
                    // æ ¹æ“šé¸æ“‡çš„è™•ç†æ–¹å¼é€²è¡Œè™•ç†
                    let punishment = null;
                    
                    if (actionType === 'restrict') {
                        const restrictType = document.getElementById('batchRestrictType').value;
                        const restrictDays = parseInt(document.getElementById('batchRestrictDays').value);
                        
                        punishment = {
                            type: 'restrict',
                            restrictType: restrictType,
                            duration: restrictDays,
                            expireAt: new Date(Date.now() + restrictDays * 24 * 60 * 60 * 1000)
                        };
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        await applyUserRestriction(userId, restrictType, restrictDays);
                        
                    } else if (actionType === 'suspend') {
                        const suspendDays = parseInt(document.getElementById('batchSuspendDays').value);
                        
                        punishment = {
                            type: 'suspend',
                            duration: suspendDays,
                            expireAt: new Date(Date.now() + suspendDays * 24 * 60 * 60 * 1000)
                        };
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        await suspendUser(userId, suspendDays);
                        
                    } else if (actionType === 'ban') {
                        punishment = {
                            type: 'ban',
                            permanent: true
                        };
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        await banUser(userId);
                        
                    } else if (actionType === 'warning') {
                        punishment = {
                            type: 'warning',
                            warningCount: firebase.firestore.FieldValue.increment(1)
                        };
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        const allReasons = new Set();
                        reports.forEach(report => {
                            if (report.reasons && report.reasons.length > 0) {
                                report.reasons.forEach(reason => allReasons.add(reason));
                            }
                        });
                        
                        await warnUser(userId, Array.from(allReasons));
                    }
                    
                    // æ‰¹é‡æ›´æ–°æª¢èˆ‰è¨˜éŒ„
                    const batch = db.batch();
                    
                    reports.forEach(report => {
                        const reportRef = db.collection('reports').doc(report.id);
                        
                        batch.update(reportRef, {
                            status: 'resolved',
                            handledBy: auth.currentUser.uid,
                            handlerName: auth.currentUser.email,
                            handledAt: firebase.firestore.FieldValue.serverTimestamp(),
                            actionType: actionType,
                            actionNote: actionNote || 'æ‰¹é‡è™•ç†',
                            punishment: punishment
                        });
                        
                        // æ›´æ–°æª¢èˆ‰äººä¿¡ç”¨åˆ†æ•¸
                        if (report.reporterId) {
                            updateReporterCredibility(report.reporterId, 5);
                        }
                    });
                    
                    await batch.commit();
                    
                    // é—œé–‰å°è©±æ¡†
                    document.body.removeChild(modal);
                    
                    // é¡¯ç¤ºè™•ç†æˆåŠŸ
                    alert(`å·²æˆåŠŸè™•ç† ${reports.length} å€‹æª¢èˆ‰`);
                    
                    // é‡æ–°åŠ è¼‰æ•¸æ“š
                    loadFrequentReports();
                    loadReports();
                    
                } catch (error) {
                    console.error('æ‰¹é‡è™•ç†æª¢èˆ‰éŒ¯èª¤:', error);
                    alert('è™•ç†æª¢èˆ‰æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
                    
                    if (document.getElementById('confirm-batch')) {
                        document.getElementById('confirm-batch').disabled = false;
                        document.getElementById('confirm-batch').textContent = 'ç¢ºèªè™•ç†';
                    }
                }
            });
        }
        
        // åŠ è¼‰çµ±è¨ˆæ•¸æ“š
        async function loadStatistics() {
            try {
                // ç²å–æ‰€æœ‰æª¢èˆ‰è¨˜éŒ„
                const reportsSnapshot = await db.collection('reports').get();
                const reports = [];
                
                reportsSnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    reports.push(data);
                });
                
                // æ·»åŠ ç…§ç‰‡é©—è­‰çµ±è¨ˆ
                const verificationsSnapshot = await db.collection('PhotoVerificationRequest').get();
                const totalVerifications = verificationsSnapshot.size;
                const pendingVerifications = verificationsSnapshot.docs.filter(doc => doc.data().status === 'pending').length;
                const approvedVerifications = verificationsSnapshot.docs.filter(doc => doc.data().status === 'approved').length;
                const rejectedVerifications = verificationsSnapshot.docs.filter(doc => doc.data().status === 'rejected').length;

                document.getElementById('total-verifications').textContent = totalVerifications;
                document.getElementById('pending-verifications').textContent = pendingVerifications;
                document.getElementById('approved-verifications').textContent = approvedVerifications;
                document.getElementById('rejected-verifications').textContent = rejectedVerifications;
        
                
                // çµ±è¨ˆæª¢èˆ‰é¡å‹
                const typeCounts = {};
                reports.forEach(report => {
                    if (report.reasons && report.reasons.length > 0) {
                        report.reasons.forEach(reason => {
                            typeCounts[reason] = (typeCounts[reason] || 0) + 1;
                        });
                    }
                });
                
                // é¡¯ç¤ºæª¢èˆ‰é¡å‹åˆ†å¸ƒ
                const typeStatsContainer = document.getElementById('report-types-stats');
                typeStatsContainer.innerHTML = '';
                
                const sortedTypes = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
                
                sortedTypes.forEach(([type, count]) => {
                    const percentage = Math.round((count / totalReports) * 100);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>${getReasonText(type)}</span>
                            <span>${count} (${percentage}%)</span>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    `;
                    
                    typeStatsContainer.appendChild(li);
                });
                
                // çµ±è¨ˆå¹³å‡è™•ç†æ™‚é–“
                const handledReports = reports.filter(report => 
                    report.status !== 'pending' && report.createdAt && report.handledAt
                );
                
                let totalHandleTime = 0;
                
                handledReports.forEach(report => {
                    const createdAt = report.createdAt.toDate();
                    const handledAt = report.handledAt.toDate();
                    const handleTimeHours = (handledAt - createdAt) / (1000 * 60 * 60);
                    totalHandleTime += handleTimeHours;
                });
                
                const avgHandleTime = handledReports.length > 0 
                    ? (totalHandleTime / handledReports.length).toFixed(1) 
                    : 0;
                
                document.getElementById('avg-handle-time').textContent = avgHandleTime;
                
                // æœ¬é€±è™•ç†é‡
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                const weeklyHandled = handledReports.filter(report => 
                    report.handledAt.toDate() >= oneWeekAgo
                ).length;
                
                document.getElementById('weekly-handled').textContent = weeklyHandled;
                
                // æœ€å¸¸è¢«æª¢èˆ‰ç”¨æˆ¶
                const reportedUserCounts = {};
                reports.forEach(report => {
                    if (report.reportedUserId) {
                        reportedUserCounts[report.reportedUserId] = (reportedUserCounts[report.reportedUserId] || 0) + 1;
                    }
                });
                
                const mostReportedUsers = Object.entries(reportedUserCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                const mostReportedUsersContainer = document.getElementById('most-reported-users');
                mostReportedUsersContainer.innerHTML = '';
                
                if (mostReportedUsers.length === 0) {
                    mostReportedUsersContainer.innerHTML = '<li>æ²’æœ‰è¶³å¤ æ•¸æ“š</li>';
                    return;
                }
                
                // ç²å–ç”¨æˆ¶å
                for (const [userId, count] of mostReportedUsers) {
                    try {
                        const userDoc = await db.collection('userprofileData').doc(userId).get();
                        const userName = userDoc.exists ? (userDoc.data().name || 'æœªçŸ¥ç”¨æˆ¶') : 'æœªçŸ¥ç”¨æˆ¶';
                        
                        const validReports = reports.filter(report => 
                            report.reportedUserId === userId && report.status === 'resolved'
                        ).length;
                        
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span>${userName}</span>
                                <span>${count}æ¬¡ (${validReports}æ¬¡æˆç«‹)</span>
                            </div>
                        `;
                        
                        mostReportedUsersContainer.appendChild(li);
                    } catch (error) {
                        console.error('ç²å–ç”¨æˆ¶åéŒ¯èª¤:', error);
                    }
                }
                
                // åŠ è¼‰æª¢èˆ‰ä¿¡ç”¨çµ±è¨ˆ
                await loadCredibilityStatistics();
                
            } catch (error) {
                console.error('åŠ è¼‰çµ±è¨ˆæ•¸æ“šéŒ¯èª¤:', error);
                alert('åŠ è¼‰çµ±è¨ˆæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }
        
        // åŠ è¼‰æª¢èˆ‰ä¿¡ç”¨çµ±è¨ˆ
        async function loadCredibilityStatistics() {
        try {
            // ç²å–æ‰€æœ‰æª¢èˆ‰ä¿¡ç”¨è¨˜éŒ„
            const credibilitySnapshot = await db.collection('userReportCredibility').get();
            const credibilityData = [];
            
            credibilitySnapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            credibilityData.push(data);
            });
            
            // æª¢èˆ‰ä¿¡ç”¨åˆ†æ•¸åˆ†å¸ƒ
            let highCreditCount = 0;
            let mediumCreditCount = 0;
            let lowCreditCount = 0;
            
            credibilityData.forEach(data => {
            const score = data.score || 100;
            if (score >= 80) {
                highCreditCount++;
            } else if (score >= 50) {
                mediumCreditCount++;
            } else {
                lowCreditCount++;
            }
            });
            
            // æ›´æ–°UIå‰æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const highCreditElement = document.getElementById('high-credit-count');
            const mediumCreditElement = document.getElementById('medium-credit-count');
            const lowCreditElement = document.getElementById('low-credit-count');
            
            if (highCreditElement) highCreditElement.textContent = highCreditCount;
            if (mediumCreditElement) mediumCreditElement.textContent = mediumCreditCount;
            if (lowCreditElement) lowCreditElement.textContent = lowCreditCount;
            
            // æœ€æ´»èºæª¢èˆ‰äºº
            const mostActiveReporters = credibilityData
            .sort((a, b) => (b.reportCount || 0) - (a.reportCount || 0))
            .slice(0, 5);
            
            const mostActiveReportersContainer = document.getElementById('most-active-reporters');
            if (mostActiveReportersContainer) {
            mostActiveReportersContainer.innerHTML = '';
            
            if (mostActiveReporters.length === 0) {
                mostActiveReportersContainer.innerHTML = '<li>æ²’æœ‰è¶³å¤ æ•¸æ“š</li>';
            } else {
                for (const data of mostActiveReporters) {
                try {
                    const userDoc = await db.collection('userprofileData').doc(data.userId).get();
                    const userName = userDoc.exists ? (userDoc.data().name || 'æœªçŸ¥ç”¨æˆ¶') : 'æœªçŸ¥ç”¨æˆ¶';
                    
                    const validRate = ((data.validReports || 0) / (data.reportCount || 1) * 100).toFixed(0);
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${userName}</span>
                        <span>${data.reportCount || 0}æ¬¡ (${validRate}%æœ‰æ•ˆ)</span>
                    </div>
                    `;
                    
                    mostActiveReportersContainer.appendChild(li);
                } catch (error) {
                    console.error('ç²å–ç”¨æˆ¶åéŒ¯èª¤:', error);
                }
                }
            }
            }
            
            // æœ€ä½ä¿¡ç”¨åˆ†æ•¸ç”¨æˆ¶
            const lowestCreditUsers = credibilityData
            .sort((a, b) => (a.score || 100) - (b.score || 100))
            .slice(0, 5);
            
            const lowestCreditUsersContainer = document.getElementById('lowest-credit-users');
            if (lowestCreditUsersContainer) {
            lowestCreditUsersContainer.innerHTML = '';
            
            if (lowestCreditUsers.length === 0) {
                lowestCreditUsersContainer.innerHTML = '<li>æ²’æœ‰è¶³å¤ æ•¸æ“š</li>';
            } else {
                for (const data of lowestCreditUsers) {
                try {
                    const userDoc = await db.collection('userprofileData').doc(data.userId).get();
                    const userName = userDoc.exists ? (userDoc.data().name || 'æœªçŸ¥ç”¨æˆ¶') : 'æœªçŸ¥ç”¨æˆ¶';
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>${userName}</span>
                        <span>ä¿¡ç”¨åˆ†æ•¸: ${data.score || 100}</span>
                    </div>
                    `;
                    
                    lowestCreditUsersContainer.appendChild(li);
                } catch (error) {
                    console.error('ç²å–ç”¨æˆ¶åéŒ¯èª¤:', error);
                }
                }
            }
            }
            
        } catch (error) {
            console.error('åŠ è¼‰æª¢èˆ‰ä¿¡ç”¨çµ±è¨ˆéŒ¯èª¤:', error);
                // ä¸å½±éŸ¿ä¸»è¦æµç¨‹
            }
        }
        
        // åŠ è¼‰æ­·å²è¨˜éŒ„
        async function loadHistory() {
            const historyContainer = document.getElementById('history-container');
            const loadingIndicator = document.getElementById('history-loading');
            
            historyContainer.innerHTML = '';
            loadingIndicator.style.display = 'flex';
            
            try {
                // ç²å–éæ¿¾æ¢ä»¶
                const searchTerm = document.getElementById('historySearchInput').value.trim().toLowerCase();
                const statusFilter = document.getElementById('historyStatusFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                // æ§‹å»ºæŸ¥è©¢
                let query = db.collection('reports')
                    .where('status', '!=', 'pending')
                    .orderBy('status')
                    .orderBy('handledAt', 'desc')
                    .limit(50);
                
                // æ‡‰ç”¨ç‹€æ…‹éæ¿¾
                if (statusFilter !== 'all') {
                    query = db.collection('reports')
                        .where('status', '==', statusFilter)
                        .orderBy('handledAt', 'desc')
                        .limit(50);
                }
                
                const querySnapshot = await query.get();
                
                loadingIndicator.style.display = 'none';
                
                if (querySnapshot.empty) {
                    historyContainer.innerHTML = '<div style="text-align: center; padding: 30px;">æ²’æœ‰è™•ç†æ­·å²è¨˜éŒ„</div>';
                    return;
                }
                
                let records = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    records.push(data);
                });
                
                // æ‡‰ç”¨æ—¥æœŸéæ¿¾
                if (startDate) {
                    const startDateTime = new Date(startDate).getTime();
                    records = records.filter(record => {
                        if (!record.handledAt) return true;
                        return record.handledAt.toDate().getTime() >= startDateTime;
                    });
                }
                
                if (endDate) {
                    const endDateTime = new Date(endDate);
                    endDateTime.setHours(23, 59, 59, 999);
                    const endTime = endDateTime.getTime();
                    
                    records = records.filter(record => {
                        if (!record.handledAt) return true;
                        return record.handledAt.toDate().getTime() <= endTime;
                    });
                }
                
                // æ‡‰ç”¨æœå°‹éæ¿¾
                if (searchTerm) {
                    records = records.filter(record => {
                        return (
                            (record.reportedUserName && record.reportedUserName.toLowerCase().includes(searchTerm)) ||
                            (record.reporterName && record.reporterName.toLowerCase().includes(searchTerm)) ||
                            (record.id && record.id.toLowerCase().includes(searchTerm)) ||
                            (record.handlerName && record.handlerName.toLowerCase().includes(searchTerm))
                        );
                    });
                }
                
                // æª¢æŸ¥éæ¿¾å¾Œæ˜¯å¦æœ‰è¨˜éŒ„
                if (records.length === 0) {
                    historyContainer.innerHTML = '<div style="text-align: center; padding: 30px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ­·å²è¨˜éŒ„</div>';
                    return;
                }
                
                // é¡¯ç¤ºæ­·å²è¨˜éŒ„
                records.forEach(record => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    // æ ¼å¼åŒ–è™•ç†æ™‚é–“
                    const handledAt = record.handledAt ? formatDate(record.handledAt.toDate()) : 'æœªçŸ¥æ™‚é–“';
                    
                    // æ§‹å»ºç‹€æ…‹æ¨™ç±¤
                    let statusBadge = '';
                    switch (record.status) {
                        case 'resolved':
                            statusBadge = '<span class="status-badge badge-resolved">å·²è™•ç†</span>';
                            break;
                        case 'rejected':
                            statusBadge = '<span class="status-badge badge-rejected">å·²æ‹’çµ•</span>';
                            break;
                    }
                    
                    // æ§‹å»ºæ‡²ç½°æè¿°
                    let punishmentText = '';
                    if (record.punishment) {
                        switch (record.punishment.type) {
                            case 'warning':
                                punishmentText = 'ç™¼å‡ºè­¦å‘Š';
                                break;
                            case 'restrict':
                                punishmentText = `é™åˆ¶${getRestrictionTypeText(record.punishment.restrictType)}åŠŸèƒ½ ${record.punishment.duration} å¤©`;
                                break;
                            case 'suspend':
                                punishmentText = `æš«åœå¸³è™Ÿ ${record.punishment.duration} å¤©`;
                                break;
                            case 'ban':
                                punishmentText = 'æ°¸ä¹…å°ç¦å¸³è™Ÿ';
                                break;
                        }
                    } else if (record.status === 'rejected') {
                        punishmentText = 'ç„¡è™•ç½° (æ‹’çµ•æª¢èˆ‰)';
                    }
                    
                    historyItem.innerHTML = `
                        <div class="date">${handledAt} Â· è™•ç†äºº: ${record.handlerName || 'æœªçŸ¥'}</div>
                        <h4>
                            ${statusBadge}
                            <span style="margin-left: 5px;">
                                ${record.reportedUserName || 'æœªçŸ¥ç”¨æˆ¶'} è¢« ${record.reporterName || 'æœªçŸ¥ç”¨æˆ¶'} æª¢èˆ‰
                            </span>
                        </h4>
                        <p>
                            <strong>åŸå› :</strong> ${record.reasons ? record.reasons.map(r => getReasonText(r)).join('ã€') : 'æœªæŒ‡å®š'}
                            <br>
                            <strong>è™•ç†çµæœ:</strong> ${punishmentText}
                            ${record.actionNote ? `<br><strong>å‚™è¨»:</strong> ${record.actionNote}` : ''}
                        </p>
                    `;
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶ï¼Œé¡¯ç¤ºè©³æƒ…
                    historyItem.addEventListener('click', () => {
                        showReportDetail(record.id);
                    });
                    
                    historyContainer.appendChild(historyItem);
                });
                
            } catch (error) {
                console.error('åŠ è¼‰æ­·å²è¨˜éŒ„éŒ¯èª¤:', error);
                loadingIndicator.style.display = 'none';
                historyContainer.innerHTML = `<div style="text-align: center; padding: 30px;">åŠ è¼‰æ­·å²è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }
        
        // åŠ è¼‰è¨­ç½®
        async function loadSettings() {
            try {
                const settingsDoc = await db.collection('systemSettings').doc('reportManagement').get();
                
                if (settingsDoc.exists) {
                    const settings = settingsDoc.data();
                    
                    // æª¢èˆ‰è™•ç†è¦å‰‡
                    if (settings.reportRules) {
                        document.getElementById('multipleReportThreshold').value = settings.reportRules.multipleReportThreshold || 3;
                        document.getElementById('falseReportPenalty').value = settings.reportRules.falseReportPenalty || 'limit';
                        document.getElementById('defaultPunishDays').value = settings.reportRules.defaultPunishDays || 7;
                    }
                    
                    // è‡ªå‹•åŒ–æµç¨‹
                    if (settings.automation) {
                        document.getElementById('autoRejectFalseReports').checked = settings.automation.autoRejectFalseReports !== false;
                        document.getElementById('autoNotifyUser').checked = settings.automation.autoNotifyUser !== false;
                        document.getElementById('prioritizeMultipleReports').checked = settings.automation.prioritizeMultipleReports !== false;
                        
                        // æª¢èˆ‰ä¿¡ç”¨ç³»çµ±
                        if (document.getElementById('enableCreditSystem')) {
                            document.getElementById('enableCreditSystem').checked = settings.automation.enableCreditSystem !== false;
                        }
                        
                        if (document.getElementById('creditThreshold')) {
                            document.getElementById('creditThreshold').value = settings.automation.creditThreshold || 40;
                        }
                    }
                    
                    // è­¦å‘Šè¨Šæ¯æ¨¡æ¿
                    if (settings.messageTemplates) {
                        document.getElementById('warningTemplate').value = settings.messageTemplates.warning || '';
                        document.getElementById('suspensionTemplate').value = settings.messageTemplates.suspension || '';
                        
                        // è™›å‡æª¢èˆ‰è­¦å‘Š
                        if (document.getElementById('falseReportTemplate')) {
                            document.getElementById('falseReportTemplate').value = settings.messageTemplates.falseReport || '';
                        }
                    }
                }
                
            } catch (error) {
                console.error('åŠ è¼‰è¨­ç½®éŒ¯èª¤:', error);
            }
        }
        
        // ä¿å­˜è¨­ç½®
        async function saveSettings(section) {
            try {
                const settingsRef = db.collection('systemSettings').doc('reportManagement');
                
                switch (section) {
                    case 'reportRules':
                        await settingsRef.set({
                            reportRules: {
                                multipleReportThreshold: parseInt(document.getElementById('multipleReportThreshold').value),
                                falseReportPenalty: document.getElementById('falseReportPenalty').value,
                                defaultPunishDays: parseInt(document.getElementById('defaultPunishDays').value)
                            }
                        }, { merge: true });
                        break;
                        
                    case 'automation':
                        const automation = {
                            autoRejectFalseReports: document.getElementById('autoRejectFalseReports').checked,
                            autoNotifyUser: document.getElementById('autoNotifyUser').checked,
                            prioritizeMultipleReports: document.getElementById('prioritizeMultipleReports').checked
                        };
                        
                        // æ·»åŠ æª¢èˆ‰ä¿¡ç”¨ç³»çµ±è¨­ç½®
                        if (document.getElementById('enableCreditSystem')) {
                            automation.enableCreditSystem = document.getElementById('enableCreditSystem').checked;
                        }
                        
                        if (document.getElementById('creditThreshold')) {
                            automation.creditThreshold = parseInt(document.getElementById('creditThreshold').value);
                        }
                        
                        await settingsRef.set({
                            automation: automation
                        }, { merge: true });
                        break;
                        
                    case 'messageTemplates':
                        const templates = {
                            warning: document.getElementById('warningTemplate').value,
                            suspension: document.getElementById('suspensionTemplate').value
                        };
                        
                        // æ·»åŠ è™›å‡æª¢èˆ‰è­¦å‘Šæ¨¡æ¿
                        if (document.getElementById('falseReportTemplate')) {
                            templates.falseReport = document.getElementById('falseReportTemplate').value;
                        }
                        
                        await settingsRef.set({
                            messageTemplates: templates
                        }, { merge: true });
                        break;
                }
                
                alert('è¨­ç½®å·²ä¿å­˜');
                
            } catch (error) {
                console.error('ä¿å­˜è¨­ç½®éŒ¯èª¤:', error);
                alert('ä¿å­˜è¨­ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return new Intl.DateTimeFormat('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).format(date);
        }
        
        // ç²å–æª¢èˆ‰åŸå› æ–‡å­—
        function getReasonText(reason) {
            switch (reason) {
                case 'harassment': return 'é¨·æ“¾è¡Œç‚º';
                case 'inappropriate': return 'ä¸ç•¶å…§å®¹';
                case 'scam': return 'è©é¨™/é‡£é­š';
                case 'fake': return 'å†’å……ä»–äºº';
                case 'spam': return 'å»£å‘Š/åƒåœ¾è¨Šæ¯';
                case 'hate': return 'ä»‡æ¨è¨€è«–';
                case 'violence': return 'æš´åŠ›/å¨è„…è¡Œç‚º';
                case 'other': return 'å…¶ä»–é•è¦';
                default: return reason;
            }
        }
        
        // ç²å–ç‹€æ…‹æ–‡å­—
        function getStatusText(status) {
            switch (status) {
                case 'pending': return 'å¾…è™•ç†';
                case 'resolved': return 'å·²è™•ç†';
                case 'rejected': return 'å·²æ‹’çµ•';
                default: return status;
            }
        }
        
        // ç²å–é™åˆ¶é¡å‹æ–‡å­—
        function getRestrictionTypeText(type) {
            switch (type) {
                case 'chat': return 'èŠå¤©';
                case 'match': return 'é…å°';
                case 'photo': return 'ä¸Šå‚³ç…§ç‰‡';
                case 'all': return 'æ‰€æœ‰';
                case 'report': return 'æª¢èˆ‰';
                default: return type;
            }
        }

        // é¡¯ç¤ºé©—è­‰è©³æƒ…
        async function showVerificationDetail(requestId, userId) {
            // åˆ‡æ›è¦–åœ–
            mainContent.style.display = 'none';
            
            // ç¢ºä¿æœ‰ä¸€å€‹é©—è­‰è©³æƒ…è¦–åœ–å®¹å™¨
            let verificationDetailContainer = document.getElementById('verification-detail');
            if (!verificationDetailContainer) {
                verificationDetailContainer = createVerificationDetailContainer();
            }
            
            verificationDetailContainer.style.display = 'block';
            
            try {
                // ç²å–é©—è­‰è«‹æ±‚æ•¸æ“š
                const requestDoc = await db.collection('PhotoVerificationRequest').doc(requestId).get();
                if (!requestDoc.exists) {
                    alert('æ‰¾ä¸åˆ°é©—è­‰è«‹æ±‚');
                    backToVerificationList();
                    return;
                }
                
                const requestData = requestDoc.data();
                
                // ç²å–ç”¨æˆ¶æ•¸æ“š
                const userDoc = await db.collection('userprofileData').doc(userId).get();
                if (!userDoc.exists) {
                    alert('æ‰¾ä¸åˆ°ç”¨æˆ¶è³‡æ–™');
                    backToVerificationList();
                    return;
                }
                
                const userData = userDoc.data();
                
                // è¨­ç½®è«‹æ±‚IDå’Œç”¨æˆ¶IDåˆ°éš±è—å­—æ®µ
                document.getElementById('verification-requestid').value = requestId;
                document.getElementById('verification-userid').textContent = userId;
                
                // å¡«å……é©—è­‰è©³æƒ…è¡¨å–®
                document.getElementById('verification-username').textContent = requestData.userName || 'æœªçŸ¥ç”¨æˆ¶';
                document.getElementById('verification-selfie').src = requestData.selfiePhotoUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 300 300"%3E%3Crect width="300" height="300" fill="%23f0f0f0"/%3E%3Ctext x="50%25" y="50%25" font-family="Arial" font-size="24" fill="%23999" text-anchor="middle" dominant-baseline="middle"%3Eç„¡ç…§ç‰‡%3C/text%3E%3C/svg%3E';
                document.getElementById('verification-action').textContent = requestData.action || 'æœªæŒ‡å®šå‹•ä½œ';
                
                // æ ¼å¼åŒ–æäº¤æ™‚é–“
                const createdAt = requestData.createdAt ? new Date(requestData.createdAt.toDate()) : new Date();
                document.getElementById('verification-time').textContent = formatDate(createdAt);
                
                // é¡¯ç¤ºç”¨æˆ¶ç…§ç‰‡
                const photosContainer = document.getElementById('verification-photos');
                photosContainer.innerHTML = '';
                
                // ç²å–ç…§ç‰‡URLs
                const photoUrls = userData.photoUrls || [];
                // ç²å–ç…§ç‰‡é †åº
                const photoOrder = userData.photoOrder || [];
                
                if (photoUrls.length === 0) {
                    photosContainer.innerHTML = '<p>ç”¨æˆ¶æ²’æœ‰ä¸Šå‚³ç…§ç‰‡</p>';
                    return;
                }
                
                // åŠ è¼‰å·²é©—è­‰çš„ç…§ç‰‡ä¿¡æ¯
                const verifiedPhotos = userData.verifiedPhotos || {};
                console.log('å·²é©—è­‰ç…§ç‰‡ç‹€æ…‹:', verifiedPhotos);
                
                // æ²’æœ‰é †åºæˆ–é †åºç‚ºç©ºæ™‚ï¼Œç›´æ¥æŒ‰ç´¢å¼•é¡¯ç¤º
                if (photoOrder.length === 0) {
                    for (let i = 0; i < photoUrls.length; i++) {
                        if (photoUrls[i]) {
                            addPhotoItemToContainer(i, photoUrls[i], verifiedPhotos, photosContainer);
                        }
                    }
                } else {
                    // æŒ‰ç…§é †åºé¡¯ç¤ºç…§ç‰‡
                    for (let i = 0; i < photoOrder.length; i++) {
                        const photoIndex = photoOrder[i];
                        if (photoIndex >= 0 && photoIndex < photoUrls.length && photoUrls[photoIndex]) {
                            addPhotoItemToContainer(photoIndex, photoUrls[photoIndex], verifiedPhotos, photosContainer);
                        }
                    }
                }
                
            } catch (error) {
                console.error('é¡¯ç¤ºé©—è­‰è©³æƒ…éŒ¯èª¤:', error);
                alert(`è¼‰å…¥é©—è­‰è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                backToVerificationList();
            }
        }

        // è¼”åŠ©å‡½æ•¸ï¼šæ·»åŠ ç…§ç‰‡é …ç›®åˆ°å®¹å™¨
        function addPhotoItemToContainer(photoIndex, photoUrl, verifiedPhotos, container) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            // æª¢æŸ¥ç…§ç‰‡æ˜¯å¦å·²é©—è­‰
            const isVerified = verifiedPhotos[photoIndex] === true;
            
            photoItem.innerHTML = `
                <img src="${photoUrl}" alt="ç”¨æˆ¶ç…§ç‰‡ ${photoIndex}" 
                    onerror="this.src='data:image/svg+xml,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;300&quot; height=&quot;300&quot; viewBox=&quot;0 0 300 300&quot;%3E%3Crect width=&quot;300&quot; height=&quot;300&quot; fill=&quot;%23f0f0f0&quot;/%3E%3Ctext x=&quot;50%%&quot; y=&quot;50%%&quot; font-family=&quot;Arial&quot; font-size=&quot;24&quot; fill=&quot;%23999&quot; text-anchor=&quot;middle&quot; dominant-baseline=&quot;middle&quot;%3Eè¼‰å…¥å¤±æ•—%3C/text%3E%3C/svg%3E';"
                    loading="lazy">
                <span class="index">#${photoIndex}${isVerified ? ' âœ“' : ''}</span>
                <input type="checkbox" class="checkbox" data-index="${photoIndex}" ${isVerified ? 'checked' : ''}>
            `;
            
            container.appendChild(photoItem);
            
            // æ·»åŠ ç…§ç‰‡é è¦½åŠŸèƒ½
            photoItem.querySelector('img').addEventListener('click', () => {
                document.getElementById('lightboxImage').src = photoUrl;
                document.getElementById('imageLightbox').style.display = 'flex';
            });
        }


        // å‰µå»ºé©—è­‰è©³æƒ…å®¹å™¨
        function createVerificationDetailContainer() {
            const container = document.createElement('div');
            container.id = 'verification-detail';
            container.className = 'verification-detail card';
            container.style.display = 'none';
            
            container.innerHTML = `
                <div class="detail-header">
                    <h2>ç…§ç‰‡é©—è­‰è©³æƒ…</h2>
                    <button id="verification-back" class="btn-info">è¿”å›åˆ—è¡¨</button>
                </div>
                
                <input type="hidden" id="verification-requestid">
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>ç”¨æˆ¶è³‡è¨Š</h3>
                        <p><strong>ç”¨æˆ¶å:</strong> <span id="verification-username">æœªçŸ¥ç”¨æˆ¶</span></p>
                        <p><strong>ç”¨æˆ¶ID:</strong> <span id="verification-userid">æœªçŸ¥</span></p>
                        <p><strong>æäº¤æ™‚é–“:</strong> <span id="verification-time">æœªçŸ¥</span></p>
                    </div>
                    
                    <div class="info-card">
                        <h3>é©—è­‰å‹•ä½œ</h3>
                        <p id="verification-action">æœªæŒ‡å®šå‹•ä½œ</p>
                    </div>
                </div>
                
                <div class="selfie-container">
                    <h3>é©—è­‰è‡ªæ‹ç…§ <small>(ç”¨æˆ¶æŒ‰ç…§æŒ‡å®šå‹•ä½œæ‹æ”çš„ç…§ç‰‡)</small></h3>
                    <img id="verification-selfie" class="selfie-photo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'%3E%3Crect width='300' height='300' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='24' fill='%23999' text-anchor='middle' dominant-baseline='middle'%3Eç„¡ç…§ç‰‡%3C/text%3E%3C/svg%3E" alt="é©—è­‰è‡ªæ‹ç…§">
                </div>
                
                <div class="verification-instruction" style="margin: 20px 0; padding: 15px; background-color: rgba(157, 127, 134, 0.1); border-radius: 8px;">
                    <h3>é©—è­‰èªªæ˜</h3>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li>è«‹æ¯”å°è‡ªæ‹ç…§èˆ‡ç”¨æˆ¶ç…§ç‰‡æ˜¯å¦ç‚ºåŒä¸€äºº</li>
                        <li>å‹¾é¸ç¬¦åˆèº«åˆ†çš„ç…§ç‰‡å¾Œé»æ“Šã€Œæ ¸å‡†æ‰€é¸ç…§ç‰‡ã€</li>
                        <li>æœªå‹¾é¸çš„ç…§ç‰‡å°‡è¢«ç§»é™¤é©—è­‰ç‹€æ…‹</li>
                        <li>æ ¸å‡†å¾Œç…§ç‰‡å°‡é¡¯ç¤ºå·²é©—è­‰æ¨™è¨˜</li>
                    </ul>
                </div>
                
                <h3>ç”¨æˆ¶ç…§ç‰‡ <small>(å‹¾é¸ç¢ºèªç‚ºç”¨æˆ¶æœ¬äººçš„ç…§ç‰‡)</small></h3>
                <div class="photos-container" id="verification-photos">
                    <!-- ç”¨æˆ¶ç…§ç‰‡å°‡è¢«å‹•æ…‹è¼‰å…¥åˆ°é€™è£¡ -->
                    <div id="loadingPhotos" style="grid-column: 1 / -1; text-align: center; padding: 20px;">
                        <div class="loading-spinner"></div>
                        <span>è¼‰å…¥ä¸­...</span>
                    </div>
                </div>
                
                <div class="button-group" style="margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
                    <button id="verification-approve" class="btn-success">æ ¸å‡†æ‰€é¸ç…§ç‰‡</button>
                    <button id="verification-reject" class="btn-danger">æ‹’çµ•é©—è­‰</button>
                </div>
            `;
            
            document.body.appendChild(container);
            
            // æ·»åŠ äº‹ä»¶ç›£è½å™¨
            container.querySelector('#verification-back').addEventListener('click', backToVerificationList);
            container.querySelector('#verification-approve').addEventListener('click', approveVerification);
            container.querySelector('#verification-reject').addEventListener('click', rejectVerification);
            
            return container;
        }

        // è¿”å›åˆ—è¡¨
        function backToVerificationList() {
            document.getElementById('verification-detail').style.display = 'none';
            mainContent.style.display = 'block';
            
            // é‡æ–°åŠ è¼‰é©—è­‰è«‹æ±‚
            loadVerificationRequests();
        }

        // æ ¸å‡†é©—è­‰
        async function approveVerification() {
            const requestId = document.getElementById('verification-requestid').value;
            const userId = document.getElementById('verification-userid').textContent;
            
            if (!requestId || !userId) {
                alert('ç¼ºå°‘è«‹æ±‚IDæˆ–ç”¨æˆ¶ID');
                return;
            }
            
            // ç²å–é¸ä¸­çš„ç…§ç‰‡ç´¢å¼•
            const selectedCheckboxes = document.querySelectorAll('#verification-photos input[type="checkbox"]:checked');
            const verifiedIndices = Array.from(selectedCheckboxes).map(checkbox => {
                return parseInt(checkbox.getAttribute('data-index'));
            });
            
            if (verifiedIndices.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€å¼µç¬¦åˆé©—è­‰æ¢ä»¶çš„ç…§ç‰‡');
                return;
            }
            
            try {
                const approveBtn = document.getElementById('verification-approve');
                approveBtn.disabled = true;
                approveBtn.innerHTML = '<div class="loading-spinner"></div> è™•ç†ä¸­...';
                
                // 1. ç²å–ç•¶å‰é©—è­‰è«‹æ±‚æ•¸æ“š
                const requestDoc = await db.collection('PhotoVerificationRequest').doc(requestId).get();
                if (!requestDoc.exists) {
                    throw new Error('æ‰¾ä¸åˆ°é©—è­‰è«‹æ±‚');
                }
                const requestData = requestDoc.data();
                
                // 2. æ›´æ–°é©—è­‰è«‹æ±‚ç‹€æ…‹
                await db.collection('PhotoVerificationRequest').doc(requestId).update({
                    status: 'approved',
                    verifiedPhotoIndices: verifiedIndices,
                    verifiedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    verifiedBy: auth.currentUser ? auth.currentUser.uid : 'admin',
                    synced: false
                });
                
                // 3. æ›´æ–°ç”¨æˆ¶è³‡æ–™ä¸­çš„é©—è­‰ç‹€æ…‹
                const userDoc = await db.collection('userprofileData').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // 3.1 ç²å–æˆ–åˆå§‹åŒ– verifiedPhotos ç‰©ä»¶
                    let verifiedPhotos = userData.verifiedPhotos || {};
                    
                    // 3.2 ç²å–æ‰€æœ‰é¡¯ç¤ºçš„ç…§ç‰‡ç´¢å¼• (æ‰€æœ‰è¢«é¡¯ç¤ºåœ¨é©—è­‰ç•Œé¢çš„ç…§ç‰‡)
                    const allCheckboxes = document.querySelectorAll('#verification-photos input[type="checkbox"]');
                    const allDisplayedIndices = Array.from(allCheckboxes).map(checkbox => {
                        return parseInt(checkbox.getAttribute('data-index'));
                    });
                    
                    // 3.3 æ›´æ–°é©—è­‰ç‹€æ…‹
                    // é‡è¦ï¼šå…ˆå°‡ç•Œé¢ä¸Šæ‰€æœ‰é¡¯ç¤ºçš„ç…§ç‰‡è¨­ç½®ç‚º falseï¼Œå†å°‡é¸ä¸­çš„è¨­ç‚º true
                    allDisplayedIndices.forEach(index => {
                        verifiedPhotos[index.toString()] = false;
                    });
                    
                    // 3.4 å°‡é¸ä¸­çš„ç…§ç‰‡è¨­ç½®ç‚º true
                    verifiedIndices.forEach(index => {
                        verifiedPhotos[index.toString()] = true;
                    });
                    
                    // 3.5 æ›´æ–°ç”¨æˆ¶æ–‡æª”ä¸­çš„ verifiedPhotos å­—æ®µ
                    await db.collection('userprofileData').doc(userId).update({
                        verifiedPhotos: verifiedPhotos
                    });
                    
                    console.log('å·²æ›´æ–°ç”¨æˆ¶å·²é©—è­‰ç…§ç‰‡:', verifiedPhotos);
                }
                
                // 4. åˆªé™¤é©—è­‰è«‹æ±‚è¨˜éŒ„ (æ”¹ç‚ºä½¿ç”¨ delete è€Œä¸æ˜¯æ›´æ–°)
                await db.collection('PhotoVerificationRequest').doc(requestId).delete();
                console.log('å·²åˆªé™¤é©—è­‰è«‹æ±‚:', requestId);
                
                // 5. ç™¼é€é€šçŸ¥çµ¦ç”¨æˆ¶
                await db.collection('notifications').add({
                    userId: userId,
                    type: 'verification_approved',
                    message: 'æ‚¨çš„ç…§ç‰‡é©—è­‰è«‹æ±‚å·²é€šéå¯©æ ¸',
                    data: {
                        verifiedIndices: verifiedIndices
                    },
                    isRead: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('å·²æ ¸å‡†é¸å®šçš„ç…§ç‰‡ä¸¦åˆªé™¤é©—è­‰è«‹æ±‚');
                
                // é‡ç½®æŒ‰éˆ•ç‹€æ…‹ï¼Œä»¥ä¾¿ä¸‹æ¬¡ä½¿ç”¨
                approveBtn.disabled = false;
                approveBtn.textContent = 'æ ¸å‡†æ‰€é¸ç…§ç‰‡';
                
                backToVerificationList();
                
            } catch (error) {
                console.error('æ ¸å‡†é©—è­‰éŒ¯èª¤:', error);
                alert(`æ ¸å‡†é©—è­‰æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                
                const approveBtn = document.getElementById('verification-approve');
                approveBtn.disabled = false;
                approveBtn.textContent = 'æ ¸å‡†æ‰€é¸ç…§ç‰‡';
            }
        }


        // æ‹’çµ•é©—è­‰
        async function rejectVerification() {
            const requestId = document.getElementById('verification-requestid').value;
            const userId = document.getElementById('verification-userid').textContent;
            
            if (!requestId || !userId) {
                alert('ç¼ºå°‘è«‹æ±‚IDæˆ–ç”¨æˆ¶ID');
                return;
            }
            
            const confirmReject = confirm('ç¢ºå®šè¦æ‹’çµ•æ­¤é©—è­‰è«‹æ±‚å—ï¼Ÿ');
            if (!confirmReject) return;
            
            try {
                const rejectBtn = document.getElementById('verification-reject');
                rejectBtn.disabled = true;
                rejectBtn.innerHTML = '<div class="loading-spinner"></div> è™•ç†ä¸­...';
                
                // å…ˆç²å–é©—è­‰è«‹æ±‚æ•¸æ“šï¼Œç”¨æ–¼ä¹‹å¾Œç™¼é€é€šçŸ¥
                const requestDoc = await db.collection('PhotoVerificationRequest').doc(requestId).get();
                if (!requestDoc.exists) {
                    throw new Error('æ‰¾ä¸åˆ°é©—è­‰è«‹æ±‚');
                }
                const requestData = requestDoc.data();
                
                // ç›´æ¥åˆªé™¤é©—è­‰è«‹æ±‚è¨˜éŒ„ï¼Œè€Œä¸æ˜¯æ›´æ–°å®ƒçš„ç‹€æ…‹
                await db.collection('PhotoVerificationRequest').doc(requestId).delete();
                console.log('å·²åˆªé™¤é©—è­‰è«‹æ±‚:', requestId);
                
                // ç™¼é€æ‹’çµ•é€šçŸ¥çµ¦ç”¨æˆ¶
                await db.collection('notifications').add({
                    userId: userId,
                    type: 'verification_rejected',
                    message: 'æ‚¨çš„ç…§ç‰‡é©—è­‰è«‹æ±‚æœªé€šéå¯©æ ¸ï¼Œè«‹ç¢ºä¿ç…§ç‰‡æ¸…æ™°é¡¯ç¤ºæ‚¨æœ¬äººï¼Œä¸¦æŒ‰ç…§æŒ‡ç¤ºçš„å‹•ä½œæ‹æ”ã€‚',
                    isRead: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('å·²æ‹’çµ•é©—è­‰è«‹æ±‚ä¸¦åˆªé™¤è¨˜éŒ„');
                backToVerificationList();
                
            } catch (error) {
                console.error('æ‹’çµ•é©—è­‰éŒ¯èª¤:', error);
                alert(`æ‹’çµ•é©—è­‰æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
                
                const rejectBtn = document.getElementById('verification-reject');
                rejectBtn.disabled = false;
                rejectBtn.textContent = 'æ‹’çµ•é©—è­‰';
            }
        }


        // åŠ è¼‰ç…§ç‰‡é©—è­‰è«‹æ±‚
        async function loadVerificationRequests() {
            const container = document.getElementById('verification-container');
            const loadingElement = document.getElementById('verification-loading');
            
            if (!container || !loadingElement) {
                console.error('é©—è­‰è«‹æ±‚å®¹å™¨å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }
            
            container.innerHTML = '';
            loadingElement.style.display = 'flex';
            
            try {
                // ç²å–æ‰€æœ‰å¾…è™•ç†é©—è­‰è«‹æ±‚
                const querySnapshot = await db.collection('PhotoVerificationRequest')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                loadingElement.style.display = 'none';
                
                if (querySnapshot.empty) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;">æ²’æœ‰å¾…è™•ç†çš„é©—è­‰è«‹æ±‚</div>';
                    return;
                }
                
                // é¡¯ç¤ºé©—è­‰è«‹æ±‚å¡ç‰‡
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const requestCard = document.createElement('div');
                    requestCard.className = 'report-card pending';
                    
                    // æ ¼å¼åŒ–æ—¥æœŸ
                    const createdAt = data.createdAt ? new Date(data.createdAt.toDate()) : new Date();
                    const formattedDate = formatDate(createdAt);
                    
                    requestCard.innerHTML = `
                        <h3>
                            <span class="status-badge badge-pending">å¾…é©—è­‰</span>
                            <span style="margin-left: 5px;">${data.userName || 'æœªçŸ¥ç”¨æˆ¶'}</span>
                        </h3>
                        <p><strong>æäº¤æ™‚é–“:</strong> ${formattedDate}</p>
                        <p><strong>è¦æ±‚å‹•ä½œ:</strong> ${data.action || 'æœªæŒ‡å®š'}</p>
                    `;
                    
                    // æ·»åŠ é»æ“Šäº‹ä»¶
                    requestCard.addEventListener('click', () => {
                        showVerificationDetail(doc.id, data.userId);
                    });
                    
                    container.appendChild(requestCard);
                });
                
            } catch (error) {
                console.error('åŠ è¼‰é©—è­‰è«‹æ±‚éŒ¯èª¤:', error);
                loadingElement.style.display = 'none';
                container.innerHTML = `<div style="text-align: center; padding: 30px;">åŠ è¼‰é©—è­‰è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç®¡ç†å“¡æŒ‰éˆ•è¨ºæ–·é–‹å§‹...');
            
            // æª¢æŸ¥æŒ‰éˆ•æ˜¯å¦å­˜åœ¨
            const adminButton = document.getElementById('adminButton');
            if (!adminButton) {
                console.error('æ‰¾ä¸åˆ°adminButtonå…ƒç´ ');
                return;
            }
            console.log('æ‰¾åˆ°adminButtonå…ƒç´ :', adminButton);
            
            // æª¢æŸ¥Firebaseæ˜¯å¦åˆå§‹åŒ–
            if (typeof firebase === 'undefined' || !firebase.apps.length) {
                console.error('Firebaseå°šæœªåˆå§‹åŒ–');
                return;
            }
            console.log('Firebaseå·²åˆå§‹åŒ–');
            
            // æª¢æŸ¥ç”¨æˆ¶èªè­‰ç‹€æ…‹
            const auth = firebase.auth();
            console.log('æª¢æŸ¥ç”¨æˆ¶èªè­‰ç‹€æ…‹...');
            
            // ç›´æ¥é¡¯ç¤ºæŒ‰éˆ•ï¼Œç„¡è«–ç”¨æˆ¶æ˜¯å¦ç™»å…¥ï¼ˆç”¨æ–¼æ¸¬è©¦ï¼‰
            // adminButton.style.display = 'inline-block';
            // console.log('å·²å¼·åˆ¶é¡¯ç¤ºç®¡ç†å“¡æŒ‰éˆ•ï¼ˆæ¸¬è©¦ç”¨ï¼‰');
            
            // ç›£è½èªè­‰ç‹€æ…‹è®ŠåŒ–
            auth.onAuthStateChanged(async (user) => {
                console.log('èªè­‰ç‹€æ…‹è®Šæ›´:', user ? 'å·²ç™»å…¥: ' + user.email : 'æœªç™»å…¥');
                
                if (user) {
                    try {
                        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦åœ¨ç®¡ç†å“¡é›†åˆä¸­
                        const db = firebase.firestore();
                        console.log('å˜—è©¦æŸ¥è©¢ç®¡ç†å“¡æ–‡æª”:', user.uid);
                        
                        const adminDoc = await db.collection('admins').doc(user.uid).get();
                        
                        if (!adminDoc.exists) {
                            console.log('ç”¨æˆ¶ä¸æ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºç”³è«‹æŒ‰éˆ•');
                            adminButton.style.display = 'inline-block';
                            
                            // å¼·åˆ¶æ›´æ–°DOM
                            setTimeout(() => {
                                console.log('å»¶é²å¾ŒæŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹:', adminButton.style.display);
                                // å†æ¬¡ç¢ºä¿æŒ‰éˆ•å¯è¦‹
                                if (adminButton.style.display === 'none') {
                                    adminButton.style.display = 'inline-block';
                                    console.log('å·²å¼·åˆ¶é¡¯ç¤ºç®¡ç†å“¡æŒ‰éˆ•');
                                }
                            }, 1000);
                        } else {
                            console.log('ç”¨æˆ¶å·²æ˜¯ç®¡ç†å“¡');
                            // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹é¡¯ç¤º
                            const userStatus = document.getElementById('userStatus');
                            if (userStatus) {
                                userStatus.innerHTML = `å·²ç™»å…¥: ${user.email} <span style="color: #4CAF50; font-weight: bold; margin-left: 5px;">[ç®¡ç†å“¡]</span>`;
                            }
                        }
                    } catch (error) {
                        console.error('æª¢æŸ¥ç®¡ç†å“¡ç‹€æ…‹å¤±æ•—:', error);
                        // å‡ºéŒ¯æ™‚ä¹Ÿé¡¯ç¤ºæŒ‰éˆ•ï¼ˆå¯èƒ½æ˜¯æ¬Šé™å•é¡Œï¼‰
                        adminButton.style.display = 'inline-block';
                        console.log('å‡ºéŒ¯å¾Œå·²å¼·åˆ¶é¡¯ç¤ºç®¡ç†å“¡æŒ‰éˆ•');
                    }
                }
            });
            
            // æª¢æŸ¥æŒ‰éˆ•é»æ“Šäº‹ä»¶æ˜¯å¦æ­£ç¢ºç¶å®š
            const adminKeyModal = document.getElementById('adminKeyModal');
            if (!adminKeyModal) {
                console.error('æ‰¾ä¸åˆ°adminKeyModalå…ƒç´ ');
            } else {
                console.log('æ‰¾åˆ°adminKeyModalå…ƒç´ ');
                
                // ç¢ºä¿æŒ‰éˆ•é»æ“Šå¾Œé¡¯ç¤ºå°è©±æ¡†
                adminButton.addEventListener('click', function() {
                    console.log('é»æ“Šç®¡ç†å“¡æŒ‰éˆ•');
                    adminKeyModal.style.display = 'block';
                });
                
                // ç¢ºä¿å–æ¶ˆæŒ‰éˆ•å¯ä»¥é—œé–‰å°è©±æ¡†
                const cancelAdminKey = document.getElementById('cancelAdminKey');
                if (cancelAdminKey) {
                    cancelAdminKey.addEventListener('click', function() {
                        adminKeyModal.style.display = 'none';
                    });
                }
            }
            
            console.log('ç®¡ç†å“¡æŒ‰éˆ•è¨ºæ–·å®Œæˆ');
        });
    </script>
</body>
</html>