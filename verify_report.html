<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台</title>

    <script src="https://www.google.com/recaptcha/api.js?render=6Lf0pfMqAAAAAPWeK67sgdduOfMbWeB5w0-0bG6G" 
        async 
        onload="console.log('reCAPTCHA 腳本加載成功', new Date().toISOString())" 
        onerror="console.error('reCAPTCHA 腳本加載失敗', new Date().toISOString())">
    </script>
    <!-- Firebase SDK -->
    <!-- (1) 先引入 Firebase SDK (compat 版) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-check-compat.js"></script>

    <style>
        :root {
            --primary-color: #9D7F86;
            --secondary-color: #D8CAB8;
            --background-color: #F5EDE6;
            --text-color: #4A4A4A;
            --light-color: #FFFFFF;
            --danger-color: #F44336;
            --warning-color: #FFC107;
            --success-color: #4CAF50;
            --info-color: #2196F3;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 修復頭部區域樣式以及管理員按鈕顯示 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            flex: 0 0 auto;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-button {
            background-color: #4CAF50;
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .admin-button:hover {
            background-color: #45a049;
        }

        .logout-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        #userStatus {
            color: white;
            font-size: 14px;
        }

        .card {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .login-section {
            padding: 20px;
        }

        .login-form {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        input, select, textarea {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(157, 127, 134, 0.2);
        }

        button {
            cursor: pointer;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #8a6e74;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #ffb300;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #43a047;
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #1e88e5;
        }

        .logout-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            padding: 8px 16px;
        }

        .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            font-weight: 600;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            background-color: rgba(157, 127, 134, 0.1);
        }

        .tab:hover:not(.active) {
            background-color: #f9f9f9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        

        .report-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .report-card {
            background: var(--light-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 5px solid transparent;
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .report-card.pending {
            border-left-color: var(--warning-color);
        }

        .report-card.resolved {
            border-left-color: var(--success-color);
        }

        .report-card.rejected {
            border-left-color: var(--danger-color);
        }

        .report-card h3 {
            margin-top: 0;
            color: var(--text-color);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-pending {
            background-color: var(--warning-color);
            color: white;
        }

        .badge-resolved {
            background-color: var(--success-color);
            color: white;
        }

        .badge-rejected {
            background-color: var(--danger-color);
            color: white;
        }

        .badge-warning {
            background-color: #ff9800;
            color: white;
        }

        .report-detail {
            display: none;
        }

        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f9f9f9;
            border-radius: var(--border-radius);
            padding: 15px;
        }

        .info-card h3 {
            margin-top: 0;
            font-size: 16px;
            color: var(--primary-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #eee;
        }

        .user-info h4 {
            margin: 0;
            font-size: 16px;
        }

        .user-info p {
            margin: 5px 0 0;
            font-size: 14px;
            color: #666;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .tag {
            background: rgba(157, 127, 134, 0.1);
            color: var(--primary-color);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            position: relative;
            flex: 0 0 250px;
            margin-right: 10px;
        }

        .search-box input {
            width: 100%;
            padding-left: 32px;
            box-sizing: border-box;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
            z-index: 1;
        }

        .filter-select {
            min-width: 120px;
            flex: 0 1 150px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-item.active {
            background: var(--primary-color);
            color: white;
        }

        .page-item:hover:not(.active) {
            background: #e0e0e0;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .lightbox .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .notification-badge {
            position: relative;
        }

        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* 照片驗證樣式 */
        .verification-detail {
            display: none;
        }

        .photos-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            accent-color: #4caf50;
        }

        .photo-item .index {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .selfie-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .selfie-photo {
            width: 300px;
            max-width: 100%;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
        }

        /* 店家審核詳情頁面樣式 */
        .business-verification-detail {
            width: 100%;
            max-width: 1200px;
            margin: 20px auto;
            min-height: 500px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .business-detail-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .business-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .business-detail-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }

        .business-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .business-info-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
        }

        .business-info-card h3 {
            margin-top: 0;
            font-size: 18px;
            color: #9D7F86;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .business-info-card p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .business-license-container {
            margin: 30px 0;
        }

        .business-license-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            text-align: center;
        }

        .business-photos-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .business-photos-container .business-loading {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px;
        }

        .business-photos-container .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            background-color: #f5f5f5;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .business-photos-container .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* 改進圖片容器，確保圖片正確顯示 */
        .business-photos-container .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* 或使用 'contain' 以完整顯示圖片 */
            background-color: #f0f0f0;
            transition: opacity 0.3s;
        }

        /* 圖片載入動畫 */
        .business-photos-container .photo-item .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2;
        }

        /* 圖片載入錯誤時的樣式 */
        .business-photos-container .photo-item .error-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            color: #9e9e9e;
            font-size: 14px;
            text-align: center;
            padding: 15px;
        }

        .business-photos-container .photo-item .error-placeholder svg {
            margin-bottom: 10px;
            opacity: 0.7;
        }

        /* 燈箱查看器優化 */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }

        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .lightbox.active img {
            transform: scale(1);
        }

        .lightbox .close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .lightbox .close:hover {
            opacity: 1;
        }

        /* 圖片載入中樣式 */
        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .image-loading .loading-spinner {
            width: 30px;
            height: 30px;
        }

        /* 增強圖像索引標籤 */
        .photo-item .index {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 3;
        }

        /* 文件類型標籤 */
        .photo-item .file-type {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            z-index: 3;
        }

        /* 過濾欄位容器樣式 */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* 搜索框樣式 */
        .search-box {
            position: relative;
            flex: 0 0 250px; /* 固定寬度且不收縮 */
            margin-right: 10px;
        }

        .search-box input {
            width: 100%;
            padding-left: 40px;
            box-sizing: border-box; /* 確保padding不影響寬度 */
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        /* 過濾選擇器分組 */
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            flex: 1;
            gap: 10px;
            align-items: center;
        }

        /* 過濾選擇器 */
        .filter-select {
            min-width: 120px;
            max-width: 200px;
            flex: 0 1 auto;
        }

        /* 響應式調整 */
        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .search-box {
                flex: 1 1 100%;
                margin-right: 0;
                margin-bottom: 10px;
                max-width: none;
            }
            
            .filter-group {
                flex-direction: column;
                width: 100%;
            }
            
            .filter-select, 
            .filter-bar button {
                width: 100%;
                max-width: none;
            }
        }
    </style>
    <style>
        @font-face {
          font-family: 'Material Icons';
          font-style: normal;
          font-weight: 400;
          src: local('Material Icons'), local('MaterialIcons-Regular'),
               url('path/to/MaterialIcons-Regular.woff2') format('woff2');
        }
        
        .material-icons {
          font-family: 'Material Icons';
          font-weight: normal;
          font-style: normal;
          font-size: 24px;
          line-height: 1;
          letter-spacing: normal;
          text-transform: none;
          display: inline-block;
          white-space: nowrap;
          word-wrap: normal;
          direction: ltr;
          -webkit-font-smoothing: antialiased;
        }
    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="icon" href="logo_s.png" type="image/png">
    <style>
        #appCheckStatus {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        
        #appCheckStatus.initializing {
            background-color: #ffeeba;
            color: #856404;
            display: block;
        }
        
        #appCheckStatus.success {
            background-color: #d4edda;
            color: #155724;
            display: block;
        }
        
        #appCheckStatus.error {
            background-color: #f8d7da;
            color: #721c24;
            display: block;
        }
    </style>
<script type="module">
    // 先导入 Firebase 配置
    import './firebase-config.js';
    
    // 导入统一的 App Check 模块
    import { addDiagnosticsPanel } from './app-check-module.js';
    
    // 添加诊断按钮
    document.addEventListener('DOMContentLoaded', () => {
        // 创建诊断按钮
        const diagnosticsBtn = document.createElement('button');
        diagnosticsBtn.id = 'appCheckDiagnosticsBtn';
        diagnosticsBtn.innerHTML = '🔍';
        diagnosticsBtn.title = 'App Check 診斷';
        diagnosticsBtn.style.position = 'fixed';
        diagnosticsBtn.style.bottom = '20px';
        diagnosticsBtn.style.right = '20px';
        diagnosticsBtn.style.width = '50px';
        diagnosticsBtn.style.height = '50px';
        diagnosticsBtn.style.borderRadius = '50%';
        diagnosticsBtn.style.backgroundColor = '#007bff';
        diagnosticsBtn.style.color = 'white';
        diagnosticsBtn.style.border = 'none';
        diagnosticsBtn.style.fontSize = '20px';
        diagnosticsBtn.style.display = 'flex';
        diagnosticsBtn.style.alignItems = 'center';
        diagnosticsBtn.style.justifyContent = 'center';
        diagnosticsBtn.style.cursor = 'pointer';
        diagnosticsBtn.style.zIndex = '9999';
        diagnosticsBtn.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
        
        // 添加点击事件
        diagnosticsBtn.addEventListener('click', () => {
            addDiagnosticsPanel();
            diagnosticsBtn.style.display = 'none';
        });
        
        // 添加到页面
        document.body.appendChild(diagnosticsBtn);
    });
    
    // 导入主要逻辑模块
    import './verify_report.js';
</script>

</head>
<body>
    <div id="appCheckStatus" class="initializing">App Check: 初始化中...</div>
    <div class="header">
        <h1>系統管理後台</h1>
        <div class="header-actions">
            <span id="userStatus" style="margin-right: 15px;"></span>
            <button id="adminButton" class="admin-button" style="display: none;">申請管理員權限</button>
            <button id="logoutButton" class="logout-button" style="display: none;">登出</button>
        </div>
    </div>
    <div id="adminKeyModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 500px;">
            <h3>申請管理員權限</h3>
            <p>系統將自動檢查您的IP地址是否有權限申請管理員。</p>
            <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
                <button id="cancelAdminKey" style="margin-right: 10px; padding: 8px 16px; border-radius: 8px; border: none; background-color: #f0f0f0; cursor: pointer;">取消</button>
                <button id="submitAdminKey" style="padding: 8px 16px; border-radius: 8px; border: none; background-color: #9D7F86; color: white; cursor: pointer;">確認申請</button>
            </div>
            <div id="adminKeyError" style="color: red; margin-top: 10px; display: none;"></div>
        </div>
    </div>

    <!-- 管理員成功提示框保持不變 -->
    <div id="adminSuccessModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);">
        <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border-radius: 12px; width: 80%; max-width: 500px; text-align: center;">
            <h3 style="color: #4CAF50;">操作成功</h3>
            <p>您已成功獲得管理員權限！</p>
            <p>系統將在 <span id="reloadCountdown">3</span> 秒後自動重新載入頁面。</p>
            <button id="reloadNow" style="margin-top: 15px; padding: 8px 16px; border-radius: 8px; border: none; background-color: #9D7F86; color: white; cursor: pointer;">立即重新載入</button>
        </div>
    </div>

        <!-- 登入區塊 -->
        <div class="card login-section" id="loginSection">
            <h2>管理員登入</h2>
            <div class="login-form">
                <input type="email" id="emailInput" placeholder="管理員郵箱" required>
                <input type="password" id="passwordInput" placeholder="密碼" required>
                <button id="loginButton" class="btn-primary">登入</button>
            </div>
            <div id="errorMessage" style="color: red; margin-top: 10px; display: none;"></div>
        </div>

        <!-- 主要內容區 -->
        <div id="main-content" style="display: none;">
            <!-- 標籤頁 -->
            <div class="tabs">
                <div class="tab" data-tab="verification">照片驗證</div>
                <div class="tab active" data-tab="report">檢舉管理</div>
                <div class="tab" data-tab="businessApproval">店家審核</div>
                <div class="tab" data-tab="statistics">統計分析</div>
                <div class="tab" data-tab="settings">系統設置</div>
                <div class="tab notification-badge" data-tab="frequentReports" data-count="0">重複檢舉</div>
            </div>

            <!-- 照片驗證標籤頁 -->
            <div class="tab-content" id="verification-tab">
                <div class="card">
                    <h2>待處理的照片驗證請求</h2>
                    <div id="verification-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>載入驗證請求中...</span>
                    </div>
                    <div id="verification-container" class="report-list"></div>
                    <div class="pagination" id="verification-pagination"></div>
                </div>
            </div>

            <!-- 檢舉管理標籤頁 -->
            <div class="tab-content active" id="report-tab">
                <div class="card">
                    <div class="filter-bar">
                        <div class="search-box">
                            <div class="search-box">
                                <span class="search-icon">🔍</span>
                                <input type="text" id="searchInput" placeholder="搜尋用戶名或檢舉ID...">
                            </div>
                        </div>
                        <div class="filter-group">
                            <select class="filter-select" id="statusFilter">
                                <option value="all">所有狀態</option>
                                <option value="pending" selected>待處理</option>
                                <option value="resolved">已處理</option>
                                <option value="rejected">已拒絕</option>
                            </select>
                            <select class="filter-select" id="typeFilter">
                                <option value="all">所有類型</option>
                                <option value="harassment">騷擾行為</option>
                                <option value="inappropriate">不當內容</option>
                                <option value="scam">詐騙/釣魚</option>
                                <option value="fake">冒充他人</option>
                                <option value="spam">廣告/垃圾訊息</option>
                                <option value="hate">仇恨言論</option>
                                <option value="violence">暴力/威脅行為</option>
                                <option value="other">其他違規</option>
                            </select>
                            <select class="filter-select" id="sortBy">
                                <option value="newest">最新優先</option>
                                <option value="oldest">最舊優先</option>
                                <option value="severity">嚴重度</option>
                            </select>
                            <button class="btn-primary" id="applyFilters">應用過濾</button>
                        </div>
                    </div>
                </div>

                <div id="reports-loading" class="loading">
                    <div class="loading-spinner"></div>
                    <span>載入檢舉資料中...</span>
                </div>
                <div id="reports-container" class="report-list"></div>
                <div class="pagination" id="reports-pagination"></div>
            </div>

            <!-- 店家審核標籤頁 -->
            <div class="tab-content" id="businessApproval-tab">
                <div class="card">
                    <h2>待處理的店家審核請求</h2>
                    <div id="business-approval-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>載入審核請求中...</span>
                    </div>
                    <div id="business-approval-container" class="report-list"></div>
                    <div class="pagination" id="business-approval-pagination"></div>
                </div>
            </div>
          

            <!-- 統計分析標籤頁 -->
            <div class="tab-content" id="statistics-tab">
                <div class="card">
                    <h2>檢舉統計</h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>檢舉信用分數分布</h3>
                            <div>
                              <p><strong>高信用分數 (≥80):</strong> <span id="high-credit-count">0</span></p>
                              <p><strong>中信用分數 (50-79):</strong> <span id="medium-credit-count">0</span></p>
                              <p><strong>低信用分數 (<50):</strong> <span id="low-credit-count">0</span></p>
                            </div>
                          </div>
                          
                          <div class="info-card">
                            <h3>最活躍檢舉人</h3>
                            <ul id="most-active-reporters"></ul>
                          </div>
                          
                          <div class="info-card">
                            <h3>最低信用分數用戶</h3>
                            <ul id="lowest-credit-users"></ul>
                          </div>
                        <div class="info-card">
                            <h3>檢舉概況</h3>
                            <div>
                                <p><strong>總檢舉數:</strong> <span id="total-reports">0</span></p>
                                <p><strong>處理中:</strong> <span id="pending-reports">0</span></p>
                                <p><strong>已解決:</strong> <span id="resolved-reports">0</span></p>
                                <p><strong>已拒絕:</strong> <span id="rejected-reports">0</span></p>
                            </div>
                        </div>
                        <div class="info-card">
                            <h3>檢舉類型分布</h3>
                            <ul id="report-types-stats"></ul>
                        </div>
                        <div class="info-card">
                            <h3>檢舉處理時間</h3>
                            <p><strong>平均處理時間:</strong> <span id="avg-handle-time">0</span> 小時</p>
                            <p><strong>本週處理量:</strong> <span id="weekly-handled">0</span></p>
                        </div>
                        <div class="info-card">
                            <h3>最常被檢舉用戶</h3>
                            <ul id="most-reported-users"></ul>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>照片驗證統計</h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>驗證概況</h3>
                            <div>
                                <p><strong>總驗證請求:</strong> <span id="total-verifications">0</span></p>
                                <p><strong>待處理:</strong> <span id="pending-verifications">0</span></p>
                                <p><strong>已通過:</strong> <span id="approved-verifications">0</span></p>
                                <p><strong>已拒絕:</strong> <span id="rejected-verifications">0</span></p>
                            </div>
                        </div>
                        <div class="info-card">
                            <h3>驗證處理時間</h3>
                            <p><strong>平均處理時間:</strong> <span id="avg-verification-time">0</span> 小時</p>
                            <p><strong>本週處理量:</strong> <span id="weekly-verifications">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系統設置標籤頁 -->
            <div class="tab-content" id="settings-tab">
                <div class="card">
                    <h2>系統設置</h2>
                    <div class="info-grid">
                        <div class="info-card">
                            <h3>檢舉處理規則</h3>
                            <form id="reportRulesForm">
                                <div>
                                    <label for="multipleReportThreshold">多次檢舉閾值:</label>
                                    <input type="number" id="multipleReportThreshold" min="2" max="10" value="3">
                                    <p class="description">當用戶被檢舉達到此次數時立即進行處理</p>
                                </div>
                                <div>
                                    <label for="falseReportPenalty">虛假檢舉懲罰:</label>
                                    <select id="falseReportPenalty">
                                        <option value="none">無</option>
                                        <option value="warning">警告</option>
                                        <option value="limit" selected>限制檢舉功能</option>
                                        <option value="ban">暫時禁用</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="defaultPunishDays">預設懲罰天數:</label>
                                    <input type="number" id="defaultPunishDays" min="1" max="90" value="7">
                                </div>
                                <button type="submit" class="btn-primary">保存設置</button>
                            </form>
                        </div>
                        
                        <div class="info-card">
                            <h3>驗證設置</h3>
                            <form id="verificationSettingsForm">
                                <div>
                                    <label for="autoApproveVerification">
                                        <input type="checkbox" id="autoApproveVerification">
                                        啟用自動驗證通過 (AI輔助)
                                    </label>
                                </div>
                                <div>
                                    <label for="verificationExpireDays">驗證過期天數:</label>
                                    <input type="number" id="verificationExpireDays" min="1" max="90" value="30">
                                    <p class="description">通過驗證後多少天需要重新驗證</p>
                                </div>
                                <div>
                                    <label for="requiredPhotoCount">最少需驗證照片數:</label>
                                    <input type="number" id="requiredPhotoCount" min="1" max="6" value="1">
                                </div>
                                <button type="submit" class="btn-primary">保存設置</button>
                            </form>
                        </div>
                        
                        <div class="info-card">
                            <h3>自動化流程</h3>
                            <form id="automationForm">
                                <div>
                                    <label>
                                        <input type="checkbox" id="autoRejectFalseReports" checked>
                                        自動拒絕虛假檢舉
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        <input type="checkbox" id="autoNotifyUser" checked>
                                        自動通知被檢舉用戶
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        <input type="checkbox" id="prioritizeMultipleReports" checked>
                                        多人檢舉優先處理
                                    </label>
                                </div>
                                <button type="submit" class="btn-primary">保存設置</button>
                            </form>
                        </div>
                        
                        <div class="info-card">
                            <h3>訊息模板</h3>
                            <form id="messageTemplateForm">
                                <div>
                                    <label for="warningTemplate">警告模板:</label>
                                    <textarea id="warningTemplate" rows="4">親愛的用戶，您因{reason}被檢舉，我們提醒您遵守社區規範。重複違規可能導致帳號限制或暫停。</textarea>
                                </div>
                                <div>
                                    <label for="suspensionTemplate">帳號暫停模板:</label>
                                    <textarea id="suspensionTemplate" rows="4">親愛的用戶，您因{reason}的行為，帳號已被暫停使用{days}天。如有疑問請聯繫客服。</textarea>
                                </div>
                                <button type="submit" class="btn-primary">保存模板</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 重複檢舉標籤頁 -->
            <div class="tab-content" id="frequentReports-tab">
                <div class="card">
                    <h2>重複被檢舉用戶</h2>
                    <p>以下用戶在短時間內被檢舉多次，可能需要優先處理</p>
                    <div id="frequent-loading" class="loading">
                        <div class="loading-spinner"></div>
                        <span>載入數據中...</span>
                    </div>
                    <div id="frequent-reports-container" class="report-list"></div>
                </div>
            </div>
        </div>


        <!-- 檢舉詳情頁面 -->
        <div id="report-detail" class="report-detail">
            <div class="card">
                <div class="detail-header">
                    <h2>檢舉詳情</h2>
                    <button id="backToList" class="btn-info">返回列表</button>
                </div>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h3>檢舉資訊</h3>
                        <p><strong>檢舉ID:</strong> <span id="report-id"></span></p>
                        <p><strong>提交時間:</strong> <span id="report-time"></span></p>
                        <p><strong>狀態:</strong> <span id="report-status"></span></p>
                        <p><strong>處理人員:</strong> <span id="report-handler">尚未處理</span></p>
                    </div>
                    
                    <div class="info-card">
                        <h3>檢舉人資料</h3>
                        <div class="user-profile">
                            <img id="reporter-avatar" class="avatar" src="https://placehold.co/60" alt="檢舉人頭像">
                            <div class="user-info">
                                <h4 id="reporter-name">檢舉人姓名</h4>
                                <p id="reporter-id">ID: ABC123</p>
                                <!-- 新增：檢舉信用分數 -->
                                <div>
                                    <span id="reporter-credit" class="credit-score">信用分數: 100</span>
                                    <span class="credit-tooltip">
                                        <i class="material-icons" style="font-size: 16px;">info</i>
                                        <span class="tooltip-text">信用分數根據檢舉有效性計算，影響檢舉可信度</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <p><strong>檢舉歷史:</strong> <span id="reporter-history">3次 (2次有效)</span></p>
                        <p><strong>帳戶狀態:</strong> <span id="reporter-status">正常</span></p>
                    </div>
                    
                    <div class="info-card">
                        <h3>被檢舉人資料</h3>
                        <div class="user-profile">
                            <img id="reported-avatar" class="avatar" src="https://via.placeholder.com/60" alt="被檢舉人頭像">
                            <div class="user-info">
                                <h4 id="reported-name">被檢舉人姓名</h4>
                                <p id="reported-id">ID: XYZ789</p>
                            </div>
                        </div>
                        <p><strong>被檢舉歷史:</strong> <span id="reported-history">1次 (0次成立)</span></p>
                        <p><strong>帳戶狀態:</strong> <span id="reported-status">正常</span></p>
                        <!-- 新增：顯示之前的處罰記錄 -->
                        <div id="previous-punishments">
                            <p><strong>處罰記錄:</strong></p>
                            <ul id="punishment-history"></ul>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>檢舉原因</h3>
                    <ul class="reasons-list" id="report-reasons">
                        <!-- 檢舉原因將動態載入 -->
                    </ul>
                    <div style="margin-top: 15px;">
                        <p><strong>詳細描述:</strong></p>
                        <p id="report-detail-text"></p>
                    </div>
                </div>
                
                <div class="evidence-container">
                    <h3>檢舉證據</h3>
                    <div class="evidence-grid" id="evidence-container">
                        <!-- 證據圖片將動態載入 -->
                    </div>
                </div>
                
                <div class="action-panel">
                    <h3>處理決定</h3>
                    
                    <div class="punishment-options">
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="ignore" checked>
                                拒絕檢舉 (無違規行為)
                            </label>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="warning">
                                發出警告
                            </label>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="restrict">
                                功能限制
                            </label>
                            <div style="margin-left: 25px; margin-top: 10px;">
                                <select id="restrictType">
                                    <option value="chat">聊天功能</option>
                                    <option value="match">配對功能</option>
                                    <option value="photo">上傳照片</option>
                                    <option value="all">所有功能</option>
                                </select>
                                <input type="number" id="restrictDays" min="1" max="30" value="7" style="width: 60px; margin-left: 10px;"> 天
                            </div>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="suspend">
                                暫停帳號
                            </label>
                            <div style="margin-left: 25px; margin-top: 10px;">
                                <input type="number" id="suspendDays" min="1" max="90" value="30" style="width: 60px;"> 天
                            </div>
                        </div>
                        
                        <div class="punishment-type">
                            <label>
                                <input type="radio" name="action" value="ban">
                                永久封禁
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <label for="actionNote">處理備註 (僅管理員可見):</label>
                        <textarea id="actionNote" rows="3" style="width: 100%; margin-top: 10px;"></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="submitAction" class="btn-success">確認處理</button>
                        <button id="cancelAction" class="btn-danger">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 店家審核詳情頁面 -->
        <div id="business-approval-detail" class="business-verification-detail" style="display: none;">
            <div class="business-detail-card">
                <div class="business-detail-header">
                    <h2>店家審核詳情</h2>
                    <button id="business-approval-back" class="btn-info">返回列表</button>
                </div>
                
                <input type="hidden" id="business-approval-requestid">
                
                <div class="business-info-grid">
                    <div class="business-info-card">
                        <h3>基本資訊</h3>
                        <p><strong>店家名稱:</strong> <span id="business-name">未知店家</span></p>
                        <p><strong>用戶ID:</strong> <span id="business-userid">未知</span></p>
                        <p><strong>店家類型:</strong> <span id="business-type">未知</span></p>
                        <p><strong>提交時間:</strong> <span id="business-time">未知</span></p>
                    </div>
                    
                    <div class="business-info-card">
                        <h3>聯絡資訊</h3>
                        <p><strong>店家地址:</strong> <span id="business-address">未知</span></p>
                        <p><strong>店家電話:</strong> <span id="business-phone">未知</span></p>
                        <p><strong>聯絡人姓名:</strong> <span id="business-contact-name">未知</span></p>
                        <p><strong>聯絡人電話:</strong> <span id="business-contact-phone">未知</span></p>
                    </div>
                </div>
                
                <div class="business-license-container">
                    <h3>營業執照/商業證明</h3>
                    <div id="business-licenses" class="business-photos-container">
                        <!-- 證照照片將在這裡動態加載 -->
                        <div class="business-loading">
                            <div class="loading-spinner"></div>
                            <span>載入證明文件中...</span>
                        </div>
                    </div>
                </div>
                
                <div class="business-rejection-section">
                    <h3>審核結果</h3>
                    <div class="form-group">
                        <label for="reject-reason">拒絕原因 (僅在拒絕時需填寫):</label>
                        <textarea id="reject-reason" class="form-control" rows="3" placeholder="請填寫拒絕原因，將通知店家進行修正..."></textarea>
                    </div>
                </div>
                
                <div class="business-button-group">
                    <button id="business-approve" class="btn-success">核准店家</button>
                    <button id="business-reject" class="btn-danger">拒絕審核</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 全屏圖片查看 -->
    <div class="lightbox" id="imageLightbox">
        <span class="close material-icons">close</span>
        <img id="lightboxImage" src="">
    </div>
    <!-- <script src="admin-manager.js"></script> -->
    <script type="module">
        // 导入必要的模块，确保正确的初始化顺序
        import { auth, db, appCheck } from './firebase-config.js';
        import { checkAppCheckStatus, addDiagnosticsPanel } from './app-check-module.js';
        import './verify_report.js';
        
        // DOM 加载完成后初始化 UI 元素
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('頁面加載完成，開始設置 App Check 狀態指示器...');
            const statusElement = document.getElementById('appCheckStatus');
            
            try {
                // 延迟执行检查，给 reCAPTCHA 足够的加载时间
                setTimeout(async () => {
                    try {
                        const result = await checkAppCheckStatus();
                        if (result.success) {
                            statusElement.className = 'success';
                            statusElement.textContent = 'App Check: 已驗證 ✓';
                            setTimeout(() => { statusElement.style.display = 'none'; }, 3000);
                        } else {
                            statusElement.className = 'error';
                            statusElement.textContent = 'App Check: 驗證失敗 ✗';
                            setTimeout(() => { statusElement.style.display = 'none'; }, 5000);
                        }
                    } catch (error) {
                        statusElement.className = 'error';
                        statusElement.textContent = 'App Check: 發生錯誤 ✗';
                        console.error('App Check 初始化錯誤:', error);
                        setTimeout(() => { statusElement.style.display = 'none'; }, 5000);
                    }
                }, 2000); // 延迟 2 秒后检查，提高成功率
            } catch (error) {
                console.error('設置狀態指示器時發生錯誤:', error);
            }
        });
    </script>

    <!-- 添加诊断功能 -->
    <script type="module">
        import { runFullDiagnostics, checkRecaptchaStatus } from './app-check-module.js';
        
        // 添加诊断按钮
        document.addEventListener('DOMContentLoaded', () => {
            const diagButton = document.createElement('button');
            diagButton.textContent = '執行 App Check 診斷';
            diagButton.style.position = 'fixed';
            diagButton.style.bottom = '10px';
            diagButton.style.left = '10px';
            diagButton.style.zIndex = '9999';
            diagButton.style.padding = '10px';
            diagButton.style.backgroundColor = '#4285f4';
            diagButton.style.color = 'white';
            diagButton.style.border = 'none';
            diagButton.style.borderRadius = '4px';
            diagButton.style.cursor = 'pointer';
            
            diagButton.addEventListener('click', () => {
                console.log('手動觸發診斷');
                runFullDiagnostics();
            });
            
            document.body.appendChild(diagButton);
        });
        
        // 页面加载 5 秒后自动检查 reCAPTCHA 状态
        setTimeout(() => {
            console.log('頁面加載 5 秒後自動檢查 reCAPTCHA 狀態');
            checkRecaptchaStatus();
        }, 5000);
    </script>Z
    
</body>
</html>